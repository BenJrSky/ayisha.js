/*!
 * Ayisha.js v1.0.1
 * (c) 2025 devBen - Benito Massidda
 * License: MIT
 */
!function(){if(window.AyishaVDOM)return;class t{extractDependencies(t){if("string"!=typeof t)return[];const e=t.match(/\b([a-zA-Z_$][a-zA-Z0-9_$]*)\b/g);if(!e)return[];const i=["true","false","null","undefined","if","else","for","while","switch","case","default","try","catch","finally","return","var","let","const","function","new","typeof","instanceof","in","do","break","continue","this","window","document","Math","Date","Array","Object","String","Number","Boolean","RegExp","JSON","console","setTimeout","setInterval","fetch","localStorage","sessionStorage","history","location","navigator"];return e.filter(((t,e,s)=>s.indexOf(t)===e&&!i.includes(t)))}constructor(t){this.state=t}evalExpr(t,e={},i){const s=t.trim();if(/^['"].*['"]$/.test(s))return s.slice(1,-1);if(/^\d+(\.\d+)?$/.test(s))return Number(s);try{const s=new Proxy(this.state,{get:(t,e)=>t[e],set:(t,e,i)=>(t[e]=i,!0)});return new Function("state","ctx","event",`with(state){with(ctx||{}){return (${t})}}`)(s,e,i)}catch{return}}executeMultipleExpressions(t,e={},i){const s=t.trim();if(!this.hasMultipleAssignments(s))return!1;const r=this.parseMultipleExpressions(s);try{const t=new Proxy(this.state,{get:(t,e)=>t[e],set:(t,e,i)=>(t[e]=i,!0)});for(const s of r)s.trim()&&new Function("state","ctx","event",`with(state){with(ctx||{}){${s.trim()}}}`)(t,e,i);return!0}catch(t){return!1}}executeDirectiveExpression(t,e={},i=null,s=!0){let r=t;this.hasInterpolation(t)&&(r=this.evalAttrValue(t,e));const n=r.replace(/\bstate\./g,"");try{if(this.executeMultipleExpressions(n,e,i))return s&&setTimeout((()=>window.ayisha&&window.ayisha.render()),0),!0;return new Function("state","ctx","event",`with(state){with(ctx||{}){${n}}}`)(this.state,e||{},i),s&&setTimeout((()=>window.ayisha&&window.ayisha.render()),0),!0}catch(t){return!1}}hasMultipleAssignments(t){if(t.includes("=>"))return!1;if(t.includes("(")&&t.includes(")")){return t.includes(";")}if(t.includes(";"))return!0;if(t.includes(",")&&!t.includes("("))return!0;return/\w+\s*=\s*[^=\s]+\s+\w+\s*=\s*/.test(t)}parseMultipleExpressions(t){if(t.includes(";"))return t.split(";").map((t=>t.trim())).filter((t=>t));if(t.includes(",")&&!t.includes("("))return t.split(",").map((t=>t.trim())).filter((t=>t));const e=[];let i="",s=!1,r="",n=0,a=0;for(;a<t.length;){const o=t[a];if(s||'"'!==o&&"'"!==o)if(s&&o===r&&"\\"!==t[a-1])s=!1,r="",i+=o;else if(s||"("!==o)if(s||")"!==o)if(s||" "!==o||0!==n)i+=o;else{t.substring(a+1).trim().match(/^\w+\s*=/)&&i.trim().includes("=")?(e.push(i.trim()),i=""):i+=o}else n--,i+=o;else n++,i+=o;else s=!0,r=o,i+=o;a++}return i.trim()&&e.push(i.trim()),e.length>1?e:[t]}evalText(t,e){return t.replace(/{{(.*?)}}/g,((t,i)=>{const s=this.evalExpr(i.trim(),e);return null!=s?s:""}))}evalAttrValue(t,e){let i=t.replace(/{{(.*?)}}/g,((t,i)=>{const s=this.evalExpr(i.trim(),e);return null!=s?s:""}));if(i=i.replace(/\[\{(.*?)\}\]/g,((t,i)=>{const s=this.evalExpr(i.trim(),e);return null!=s?s:""})),/^\{([^{}]+)\}$/.test(i.trim())){const t=i.trim().slice(1,-1),s=this.evalExpr(t,e);return null!=s?s:""}return i=i.replace(/\{([^{}]+)\}/g,((t,i)=>{if(/^\{\{.*\}\}$/.test(t))return t;const s=this.evalExpr(i.trim(),e);return null!=s?s:""})),i}autoVarExpr(t){return"string"==typeof t&&/^\w+$/.test(t.trim())?`{${t.trim()}}`:t}hasInterpolation(t){return/\{\{.*?\}\}|\{[\w$.]+\}/.test(t)}ensureVarInState(t,e=!1,i=null){if("string"!=typeof t)return;const s=["JSON","Object","Array","String","Number","Boolean","Date","Math","RegExp","console","window","document","setTimeout","setInterval","fetch","localStorage","sessionStorage","history","location","navigator","undefined","null","true","false"],r=t.match(/([\w$]+)\.(push|pop|shift|unshift|filter|map|reduce|forEach|length|slice|splice)/);if(r){const t=r[1];return void(s.includes(t)||t in this.state||(this.state[t]=[]))}const n=t.split(".")[0];s.includes(n)||n in this.state||("number"===i?this.state[n]=0:"checkbox"===i?this.state[n]=!1:e?this.state[n]=void 0:/items|list|array|data|results|errors|posts|todos|users/.test(n)?this.state[n]=[]:/count|total|index|id|size|length|number|num/.test(n)?this.state[n]=0:/show|hide|is|has|can|should|valid|enable|subscribed/.test(n)?this.state[n]=!1:/user|config|form|settings/.test(n)?this.state[n]={}:this.state[n]=void 0);const a=t.match(/([\w$][\w\d$]*(?:\.[\w$][\w\d$]*)+)/);if(a){const t=a[1].split("."),e=t[0];if(s.includes(e))return;let i=this.state;for(let e=0;e<t.length;e++){const s=t[e];s in i?e<t.length-1&&"object"!=typeof i[s]&&(i[s]={}):i[s]=e===t.length-1?void 0:{},i=i[s]}}}safeSetArrayVariable(t,e){try{this.state[t]=e}catch(i){Object.defineProperty(this.state,t,{value:e,writable:!0,configurable:!0,enumerable:!0})}}}class e{constructor(t){this.initBlocks=t}parse(t){if(!t)return null;if(11===t.nodeType){const e={tag:"fragment",attrs:{},directives:{},subDirectives:{},children:[]};return t.childNodes.forEach((t=>{const i=this.parse(t);i&&e.children.push(i)})),e}if(3===t.nodeType)return{type:"text",text:t.textContent};if(1!==t.nodeType)return null;const e=t.tagName.toLowerCase();if("init"===e)return this.initBlocks.push(t.textContent),null;if("no"===e)return{tag:"no",attrs:{},directives:{},subDirectives:{},children:[],rawContent:t.innerHTML};const i={tag:e,attrs:{},directives:{},subDirectives:{},children:[]};for(const e of Array.from(t.attributes))if(e.name.startsWith("@")){const t=e.name.split(":");if(2===t.length){const[s,r]=t;i.subDirectives[s]=i.subDirectives[s]||{},i.subDirectives[s][r]=e.value}else i.directives[e.name]=e.value}else i.attrs[e.name]=e.value;return t.childNodes&&t.childNodes.length>0&&t.childNodes.forEach((t=>{const e=this.parse(t);e&&i.children.push(e)})),i}}class i{constructor(){this.components={},this.cache={},this.loadingComponents=new Map}component(t,e){this.components[t]=e}async loadExternalComponent(t){if(this.cache[t])return this.cache[t];if(this.loadingComponents.has(t))return this.loadingComponents.get(t);const e=this._fetchComponent(t);this.loadingComponents.set(t,e);try{const i=await e;return this.cache[t]=i,i}catch(t){return null}finally{this.loadingComponents.delete(t)}}async _fetchComponent(t){const e=await fetch(t);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return await e.text()}getComponent(t){return this.components[t]}getCachedComponent(t){return this.cache[t]}isLoading(t){return this.loadingComponents.has(t)}}class s{constructor(t,e){this.state=t,this.watchers={},this.renderCallback=e,this.watchersReady=!1,this._isUpdating=!1,this._renderTimeout=null}makeReactive(){return this.state=new Proxy(this.state,{set:(t,e,i)=>{if(this._isUpdating)return t[e]=i,!0;const s=t[e];return JSON.stringify(s)===JSON.stringify(i)?(t[e]=i,!0):(this._isUpdating=!0,t[e]=i,this.watchersReady&&this.watchers[e]&&this.watchers[e].forEach((t=>{try{t(i)}catch(t){}})),this._renderTimeout&&clearTimeout(this._renderTimeout),this._renderTimeout=setTimeout((()=>{this._isUpdating=!1,this._renderTimeout=null,this.renderCallback()}),10),!0)}}),this.state}addWatcher(t,e){this.watchers[t]=this.watchers[t]||[],this.watchers[t].push(e)}enableWatchers(){this.watchersReady=!0}}class r{constructor(t,e){this.state=t,this.renderCallback=e}setupRouting(){let t=location.pathname.replace(/^\//,"")||"";t&&"index.html"!==t||(history.replaceState({},"","/"),t=""),this.state._currentPage||(this.state._currentPage=t),window.addEventListener("popstate",(()=>{this.state._currentPage=location.pathname.replace(/^\//,"")||"",this.renderCallback()}))}setupCurrentPageProperty(){const t=this;let e=this.state._currentPage;Object.defineProperty(this.state,"_currentPage",{get:()=>e,set(i){e!==i&&(e=i,history.pushState({},"","/"+i),t.renderCallback())}})}}class n{constructor(t){this.evaluator=t,this.pendingFetches={},this.lastFetchUrl={},this.fetched={}}setupFetch(t,e,i,s,r){let n=this.evaluator.evalExpr(t,i,s);if(void 0===n&&(n=t.replace(/\{([^}]+)\}/g,((t,e)=>{const r=this.evaluator.evalExpr(e,i,s);return null!=r?r:""}))),null==n&&(n=t),!n)return;const a=`${n}::${e}`;if(!r&&this.lastFetchUrl[e]===n)return;if(this.pendingFetches[a])return;this.pendingFetches[a]=!0,this.lastFetchUrl[e]=n,e in this.evaluator.state||(this.evaluator.state[e]=null);let o="GET",c=null,l=null;i&&i._vNode&&(i._vNode.directives&&i._vNode.directives["@method"]&&(o=this.evaluator.evalExpr(i._vNode.directives["@method"],i,s)||"GET"),i._vNode.directives&&i._vNode.directives["@payload"]&&(c=this.evaluator.evalExpr(i._vNode.directives["@payload"],i,s)),i._vNode.directives&&i._vNode.directives["@headers"]&&(l=this.evaluator.evalExpr(i._vNode.directives["@headers"],i,s)));const h={method:o};let d={};null!=c&&o&&"GET"!==o.toUpperCase()&&("object"==typeof c?(h.body=JSON.stringify(c),d["Content-Type"]="application/json"):h.body=c),l&&"object"==typeof l&&(d={...d,...l}),Object.keys(d).length>0&&(h.headers=d),fetch(n,h).then((t=>{if(!t.ok)throw this.fetched[n]||(this.fetched[n]={}),this.fetched[n].error=`${t.status} ${t.statusText||"errore di rete"}`,new Error(`${t.status} ${t.statusText}`);return t.json().catch((()=>t.text()))})).then((t=>{const i=this.evaluator.state[e];JSON.stringify(i)===JSON.stringify(t)||(this.evaluator.state[e]=t),this.fetched[n]&&delete this.fetched[n].error})).catch((t=>{this.fetched[n]||(this.fetched[n]={}),this.fetched[n].error||(this.fetched[n].error=t.message)})).finally((()=>{delete this.pendingFetches[a]}))}}class a{constructor(){this.helpTexts={"@when":'Esempio: <span @when="condizione" @do="azione"></span> oppure <span @when="condizione" @go="pagina"></span>',"@do":'Esempio: <span @when="condizione" @do="azione"></span>',"@go":'Esempio: <span @when="condizione" @go="pagina"></span>',"@wait":'Esempio: <span @when="condizione" @wait="1000" @go="pagina"></span>',"@if":'Esempio: <div @if="condizione">Mostra se condizione è true</div>',"@show":'Esempio: <div @show="condizione">Mostra se condizione è true</div>',"@hide":'Esempio: <div @hide="condizione">Nasconde se condizione è true</div>',"@for":'Esempio: <li @for="item in items">{{item}}</li> o <li @for="i, item in items">{{i}}: {{item}}</li>',"@model":'Esempio: <input @model="nome">',"@click":'Esempio: <button @click="state.count++">Aumenta</button>',"@fetch":'Esempio: <div @fetch="\'url\'" @method="\'POST\'" @payload="{foo:1}" @headers="{ Authorization: \'Bearer ...\' }"></div>',"@payload":'Esempio: <div @fetch="\'url\'" @method="\'POST\'" @payload="{foo:1}"></div>',"@headers":"Esempio: <div @fetch=\"'url'\" @headers=\"{ Authorization: 'Bearer ...' }\"></div>","@result":'Esempio: <div @fetch="\'url\'" @result="data">Carica</div>',"@watch":'Esempio: <div @watch="prop=>console.log(prop)"></div>',"@text":'Esempio: <span @text="nome"></span>',"@class":'Esempio: <div @class="{rosso: condizione}"></div>',"@style":"Esempio: <div @style=\"{color:'red'}\"></div>","@validate":'Esempio: <input @validate="required,minLength:3">',"@link":'Esempio: <a @link="pagina">Vai</a>',"@page":'Esempio: <div @page="home">Solo su home</div>',"@component":'Esempio: <component @src="comp.html"></component>',"@set":'Esempio: <button @set:click="foo=1"></button>',"@key":'Esempio: <li @for="item in items" @key="item.id"></li>',"@src":'Esempio: <component @src="comp.html"></component>',"@switch":'Esempio: <div @switch="valore"><div @case="1">Uno</div><div @default>Altro</div></div>',"@case":'Esempio: <div @case="1">Uno</div>',"@default":"Esempio: <div @default>Altro</div>","@source":'Esempio: <div @source="items" @map="item => item*2" @result="doppio"></div>',"@map":'Esempio: <div @source="items" @map="item => item*2"></div>',"@filter":'Esempio: <div @source="items" @filter="item > 0"></div>',"@reduce":'Esempio: <div @source="items" @reduce="(acc, item) => acc+item" @initial="0"></div>',"@initial":'Esempio: <div @source="items" @reduce="(acc, item) => acc+item" @initial="0"></div>',"@animate":'Esempio: <div @animate="fade-in"></div>',"@state":"Esempio: <div @state></div> (renderizza lo stato corrente come JSON)","@log":"Esempio: <div @log></div> (mostra il log delle direttive sull'elemento)","@hover":'Esempio: <div @hover="doSomething()"></div>',no:"Esempio: <no>{{nome}}</no> (mostra contenuto senza interpolazione)","@text:hover":"Esempio: <div @text:hover=\"'Testo hover'\"></div>","@text:click":"Esempio: <div @text:click=\"'Testo click'\"></div>","@text:input":'Esempio: <input @text:input="nome">',"@text:focus":'Esempio: <input @text:focus="nome">',"@class:focus":'Esempio: <input @class:focus="{rosso:true}">',"@class:hover":'Esempio: <div @class:hover="{rosso: condizione}"></div>',"@class:click":'Esempio: <div @class:click="{rosso: condizione}"></div>',"@class:input":'Esempio: <input @class:input="{rosso: condizione}">',"@class:change":'Esempio: <input @class:change="{rosso: condizione}">',"@fetch:click":'Esempio: <button @fetch:click="\'url\'" @result="data"></button>',"@fetch:hover":'Esempio: <button @fetch:hover="\'url\'" @result="data"></button>',"@fetch:input":'Esempio: <input @fetch:input="\'url\'" @result="data">',"@fetch:change":'Esempio: <input @fetch:change="\'url\'" @result="data">',"@model:input":'Esempio: <input @model:input="nome">',"@model:change":'Esempio: <input @model:change="nome">',"@model:focus":'Esempio: <input @model:focus="nome">',"@model:blur":'Esempio: <input @model:blur="nome">',"@set:change":"Esempio: <input @set:change=\"foo='bar'\">","@set:click":'Esempio: <button @set:click="foo=1"></button>',"@set:input":"Esempio: <input @set:input=\"foo='bar'\">","@set:focus":"Esempio: <input @set:focus=\"foo='bar'\">","@set:blur":"Esempio: <input @set:blur=\"foo='bar'\">","@focus":'Esempio: <input @focus="doSomething()">',"@blur":'Esempio: <input @blur="doSomething()">',"@change":'Esempio: <input @change="doSomething()">',"@input":'Esempio: <input @input="doSomething()">',"@then":'Esegui una o più espressioni dopo tutte le altre direttive su questo nodo. Esempio: <div @then="foo=1;;bar=2"></div>',"@finally":'Esegui una o più espressioni dopo tutto, inclusi @then. Esempio: <div @finally="foo=1;;bar=2"></div>'}}getHelp(t){return this.helpTexts[t]||""}isValidDirective(t){return this.helpTexts.hasOwnProperty(t)}}class o{constructor(t){this.evaluator=t,this.startTime=performance.now()}getBaseInfo(t,e){return{tag:t.tag,timestamp:new Date,executionTime:(performance.now()-this.startTime).toFixed(2)+"ms"}}log(t,e,i){return this.getBaseInfo(t,e)}}class c extends o{log(t,e,i){const s=super.log(t,e,i),r=t.directives["@for"];let n={};try{const t=r.match(/(\w+),\s*(\w+) in (.+)/),i=r.match(/(\w+) in (.+)/);if(t||i){const s=t?t[3]:i[2],a=t?t[2]:i[1],o=t?t[1]:null,c=this.evaluator.evalExpr(s,e),l=Array.isArray(c),h=l?c.length:c?Object.keys(c).length:0;n={expression:r,arrayVariable:s,itemVariable:a,indexVariable:o,arrayType:l?"Array":"Object",length:h,isEmpty:0===h,firstItem:h>0?c[0]:null,status:0===h?"❌ Empty":`✅ ${h} items`,performance:`${h} items rendered`}}}catch(t){n={expression:r,error:`❌ ${t.message}`,status:"❌ Error evaluating"}}return{...s,type:"@for",data:n}}}class l extends o{constructor(t,e){super(t),this.fetchManager=e}log(t,e,i){const s=super.log(t,e,i),r=t.directives["@fetch"],n=t.directives["@result"]||"result";let a={};try{let t=this.evaluator.evalExpr(r,e);t||(t=r);const s=i[n],o=this.fetchManager.fetched[t]?.error,c=this.fetchManager.pendingFetches[`${t}::${n}`];a={url:t,method:"GET",resultVariable:n,status:o?`❌ ${o}`:c?"⏳ Loading...":s?"✅ Success":"⭕ No data",responseSize:s?`${JSON.stringify(s).length} chars`:"N/A",hasData:!!s,hasError:!!o,isPending:!!c,lastFetch:this.fetchManager.lastFetchUrl[n]?"Recently":"Never"}}catch(t){a={url:r,error:`❌ ${t.message}`,status:"❌ Error evaluating URL"}}return{...s,type:"@fetch",data:a}}}class h extends o{log(t,e,i){const s=super.log(t,e,i),r=t.directives["@model"],n=t.directives["@validate"];let a={};try{const t=this.evaluator.evalExpr(r,e),s=i._validate?.[r];a={variable:r,currentValue:t,valueType:typeof t,isEmpty:!t||""===t,validation:n?{rules:n,isValid:s,status:s?"✅ Valid":"❌ Invalid"}:null,binding:"✅ Active"}}catch(t){a={variable:r,error:`❌ ${t.message}`,status:"❌ Error evaluating"}}return{...s,type:"@model",data:a}}}class d extends o{log(t,e,i){const s=super.log(t,e,i),r=t.directives["@if"]||t.directives["@show"]||t.directives["@hide"],n=t.directives["@if"]?"@if":t.directives["@show"]?"@show":"@hide";let a={};try{const t=this.evaluator.evalExpr(r,e),i="@hide"===n?!t:!!t;a={condition:r,result:t,isVisible:i,status:i?"✅ Visible":"❌ Hidden",evaluation:`${r} → ${t}`}}catch(t){a={condition:r,error:`❌ ${t.message}`,status:"❌ Error evaluating"}}return{...s,type:n,data:a}}}class u extends o{constructor(t){super(t),this.clickCount=0,this.lastClick=null}log(t,e,i){return{...super.log(t,e,i),type:"@click",data:{action:t.directives["@click"],clickCount:this.clickCount,lastClick:this.lastClick?Date.now()-this.lastClick+"ms ago":"Never",status:"✅ Ready"}}}recordClick(){this.clickCount++,this.lastClick=Date.now()}}class p extends o{constructor(t){super(t),this.inputCount=0,this.lastInput=null}log(t,e,i){return{...super.log(t,e,i),type:"@input",data:{action:t.directives["@input"],inputCount:this.inputCount,lastInput:this.lastInput?Date.now()-this.lastInput+"ms ago":"Never",status:"✅ Ready"}}}recordInput(){this.inputCount++,this.lastInput=Date.now()}}class v extends o{constructor(t){super(t),this.focusCount=0,this.lastFocus=null}log(t,e,i){return{...super.log(t,e,i),type:"@focus",data:{action:t.directives["@focus"],focusCount:this.focusCount,lastFocus:this.lastFocus?Date.now()-this.lastFocus+"ms ago":"Never",status:"✅ Ready"}}}recordFocus(){this.focusCount++,this.lastFocus=Date.now()}}class g extends o{constructor(t){super(t),this.blurCount=0,this.lastBlur=null}log(t,e,i){return{...super.log(t,e,i),type:"@blur",data:{action:t.directives["@blur"],blurCount:this.blurCount,lastBlur:this.lastBlur?Date.now()-this.lastBlur+"ms ago":"Never",status:"✅ Ready"}}}recordBlur(){this.blurCount++,this.lastBlur=Date.now()}}class f extends o{constructor(t){super(t),this.changeCount=0,this.lastChange=null}log(t,e,i){return{...super.log(t,e,i),type:"@change",data:{action:t.directives["@change"],changeCount:this.changeCount,lastChange:this.lastChange?Date.now()-this.lastChange+"ms ago":"Never",status:"✅ Ready"}}}recordChange(){this.changeCount++,this.lastChange=Date.now()}}class m extends o{constructor(t,e){super(t),this.componentManager=e}log(t,e,i){const s=super.log(t,e,i),r=t.directives["@src"];let n={};try{let t=this.evaluator.evalExpr(r,e);if(!t){const e=r.trim();t=/^['"].*['"]$/.test(e)?e.slice(1,-1):e}const i=this.componentManager.getCachedComponent(t),s=this.componentManager.isLoading(t);n={source:t,status:s?"⏳ Loading...":i?"✅ Loaded":"⭕ Not loaded",cached:!!i,isLoading:s,size:i?`${i.length} chars`:"N/A"}}catch(t){n={source:r,error:`❌ ${t.message}`,status:"❌ Error evaluating"}}return{...s,type:"@component",data:n}}}class y{constructor(){this.logs=[],this.loggers={},this.clickLoggers=new WeakMap,this.startTime=performance.now(),this.maxLogs=100}initializeLoggers(t,e,i){this.loggers={"@for":new c(t),"@fetch":new l(t,e),"@model":new h(t),"@if":new d(t),"@show":new d(t),"@hide":new d(t),"@click":new u(t),"@component":new m(t,i),"@input":new p(t),"@focus":new v(t),"@blur":new g(t),"@change":new f(t)}}addLog(t,e,i,s,r=null){if(!this.loggers||0===Object.keys(this.loggers).length)return;const n=performance.now(),a={id:Date.now()+Math.random(),timestamp:new Date,tag:e.tag,type:"multi-directive",elementInfo:t,executionTime:(performance.now()-n).toFixed(2)+"ms",directives:[]};Object.keys(e.directives).forEach((t=>{if(this.loggers[t])try{const r=this.loggers[t].log(e,i,s);a.directives.push({type:t,data:r.data,status:this._getDirectiveStatus(r.data)})}catch(e){a.directives.push({type:t,data:{error:e.message,status:"❌ Error logging"},status:"error"})}else a.directives.push({type:t,data:{expression:e.directives[t],status:"📋 Untracked directive"},status:"unknown"})})),Object.entries(e.subDirectives||{}).forEach((([t,r])=>{Object.keys(r).forEach((n=>{if(this.loggers[t])try{const r=this.loggers[t].log(e,i,s);a.directives.push({type:`${t}:${n}`,data:r.data,status:this._getDirectiveStatus(r.data),isSubDirective:!0})}catch(e){a.directives.push({type:`${t}:${n}`,data:{error:e.message,status:"❌ Error logging"},status:"error",isSubDirective:!0})}else a.directives.push({type:`${t}:${n}`,data:{expression:r[n],status:"📋 Untracked sub-directive"},status:"unknown",isSubDirective:!0})}))})),0===a.directives.length&&(a.type="generic",a.directives.push({type:"generic",data:{message:"Element with @log but no tracked directives",status:"📋 Generic log"},status:"generic"})),a.overallStatus=this._calculateOverallStatus(a.directives),this.logs.unshift(a),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(0,this.maxLogs))}_getDirectiveStatus(t){return t.error?"error":t.isPending||t.isLoading?"loading":t.status&&t.status.includes("✅")?"success":t.status&&t.status.includes("❌")?"error":t.status&&t.status.includes("⏳")?"loading":"normal"}_calculateOverallStatus(t){if(!t||0===t.length)return"📊 No directives";const e=t.map((t=>t.status));return e.includes("error")?"❌ Has Errors":e.includes("loading")?"⏳ Loading":e.every((t=>"success"===t))?"✅ All Good":"📊 Mixed Status"}recordClick(t){const e=this.clickLoggers.get(t);e&&e.recordClick()}_getDirectiveColor(t){return{"@for":"#ff9800","@fetch":"#4caf50","@model":"#2196f3","@if":"#9c27b0","@show":"#9c27b0","@hide":"#9c27b0","@click":"#f44336","@component":"#00bcd4","@input":"#e91e63","@focus":"#3f51b5","@blur":"#607d8b","@change":"#795548",generic:"#666666"}[t]||"#666666"}_generateIntelligentLogHTML(t){const e=t.timestamp.toLocaleTimeString();if("multi-directive"===t.type){let i=`\n          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n            <span style="color: #66ccff; font-weight: bold;">🎯 &lt;${t.tag}&gt; (${t.directives.length} directives)</span>\n            <span style="color: #999; font-size: 10px;">${e}</span>\n          </div>\n          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n            <span style="color: #ffcc66; font-size: 10px;">⏱️ ${t.executionTime}</span>\n            <span style="color: ${this._getStatusColor(t.overallStatus)}; font-size: 10px; font-weight: bold;">${t.overallStatus}</span>\n          </div>\n        `;return t.directives.forEach(((t,e)=>{const s=this._getDirectiveColor(t.type),r=this._getStatusColor(t.status);i+=`\n            <div style="border-left: 3px solid ${s}; margin: 6px 0; padding: 6px 8px; background: rgba(255,255,255,0.03); border-radius: 3px;">\n              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">\n                <span style="color: ${s}; font-weight: bold; font-size: 11px;">\n                  ${t.isSubDirective?"📎":"📋"} ${t.type}\n                </span>\n                <span style="color: ${r}; font-size: 9px;">${this._getStatusIcon(t.status)}</span>\n              </div>\n              ${this._generateCompactDirectiveHTML(t.type,t.data)}\n            </div>\n          `})),i}return'<div style="color: #cccccc;">Generic log entry</div>'}_getStatusColor(t){if(!t)return"#cccccc";if("string"==typeof t){if(t.includes("error")||t.includes("❌"))return"#ff6b6b";if(t.includes("loading")||t.includes("⏳"))return"#ffa726";if(t.includes("success")||t.includes("✅"))return"#66bb6a"}return"#cccccc"}_getStatusIcon(t){return t?"error"===t?"❌":"loading"===t?"⏳":"success"===t?"✅":"unknown"===t?"❓":"📊":"📊"}_generateCompactDirectiveHTML(t,e){if(!e)return'<div style="color: #999;">No data available</div>';let i="";try{switch(t.split(":")[0]){case"@for":i=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Array: <strong>${e.arrayVariable||"unknown"}</strong> (${e.length||0} items)<br>\n                Status: ${e.status||"unknown"}\n              </div>\n            `;break;case"@fetch":const t=e.url||"";i=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                URL: <strong>${t.slice(0,40)}${t.length>40?"...":""}</strong><br>\n                Status: ${e.status||"unknown"} | Size: ${e.responseSize||"N/A"}\n              </div>\n            `;break;case"@model":const s=e.currentValue,r="string"==typeof s?`"${s.slice(0,20)}${s.length>20?"...":""}"`:JSON.stringify(s);i=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Variable: <strong>${e.variable||"unknown"}</strong><br>\n                Value: ${r} | ${e.validation?.status||"No validation"}\n              </div>\n            `;break;case"@if":case"@show":case"@hide":const n=e.condition||"";i=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Condition: <strong>${n.slice(0,30)}${n.length>30?"...":""}</strong><br>\n                Result: ${e.result} → ${e.isVisible?"Visible":"Hidden"}\n              </div>\n            `;break;case"@click":const a=e.action||"";i=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${a.slice(0,30)}${a.length>30?"...":""}</strong><br>\n                Clicks: ${e.clickCount||0} | Last: ${e.lastClick||"Never"}\n              </div>\n            `;break;case"@component":const o=e.source||"";i=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Source: <strong>${o.slice(0,30)}${o.length>30?"...":""}</strong><br>\n                Status: ${e.status||"unknown"} | Cached: ${e.cached?"Yes":"No"}\n              </div>\n            `;break;case"@input":const c=e.action||"";i=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${c.slice(0,30)}${c.length>30?"...":""}</strong><br>\n                Inputs: ${e.inputCount||0} | Last: ${e.lastInput||"Never"}\n              </div>\n            `;break;case"@focus":const l=e.action||"";i=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${l.slice(0,30)}${l.length>30?"...":""}</strong><br>\n                Focus events: ${e.focusCount||0} | Last: ${e.lastFocus||"Never"}\n              </div>\n            `;break;case"@blur":const h=e.action||"";i=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${h.slice(0,30)}${h.length>30?"...":""}</strong><br>\n                Blur events: ${e.blurCount||0} | Last: ${e.lastBlur||"Never"}\n              </div>\n            `;break;case"@change":const d=e.action||"";i=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${d.slice(0,30)}${d.length>30?"...":""}</strong><br>\n                Change events: ${e.changeCount||0} | Last: ${e.lastChange||"Never"}\n              </div>\n            `;break;default:const u=e.expression||"";i=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Expression: <strong>${u.slice(0,40)}${u.length>40?"...":""}</strong><br>\n                Status: ${e.status||"unknown"}\n              </div>\n            `}e.error&&(i+=`<div style="color: #ff6b6b; font-size: 9px; margin-top: 2px;">💥 ${e.error}</div>`)}catch(t){i=`<div style="color: #ff6b6b; font-size: 9px;">Error rendering directive data: ${t.message}</div>`}return i}}class b{showAyishaError(t,e,i){if(!t)return;let s=t.parentNode&&t.parentNode.querySelector(".ayisha-error-banner");s?s.innerHTML=`<b>Errore JS:</b> ${e.message}<br><code>${i}</code>`:(s=document.createElement("div"),s.className="ayisha-error-banner",s.style.background="#c00",s.style.color="#fff",s.style.padding="0.5em 1em",s.style.margin="0.5em 0",s.style.borderRadius="4px",s.style.fontWeight="bold",s.style.border="1px solid #900",s.style.position="relative",s.style.zIndex="1000",s.innerHTML=`<b>Errore JS:</b> ${e.message}<br><code>${i}</code>`,t.parentNode&&t.parentNode.insertBefore(s,t.nextSibling))}createErrorElement(t){const e=document.createElement("div");return e.className="ayisha-directive-error",e.style.background="#c00",e.style.color="#fff",e.style.padding="1em",e.style.margin="0.5em 0",e.style.borderRadius="4px",e.style.fontWeight="bold",e.style.border="1px solid #900",e.innerHTML=t,e}createWarningElement(t){const e=document.createElement("div");return e.className="ayisha-directive-warning",e.style.background="#ffeb3b",e.style.color="#333",e.style.padding="1em",e.style.margin="0.5em 0",e.style.borderRadius="4px",e.style.fontWeight="bold",e.style.border="1px solid #e0c200",e.innerHTML=t,e}}class w{constructor(t,e){this.evaluator=t,this.renderCallback=e,this.modelBindings=[]}bindModel(t,e,i){let s=null;function r(t,e,i){if(t.includes(".")){const s=t.split("."),r=s[0];return e&&"object"==typeof e[r]&&null!==e[r]?{root:e[r],path:s.slice(1)}:{root:i,path:s}}return e&&"object"==typeof e[t]&&null!==e[t]?{root:e[t],path:[]}:{root:i,path:[t]}}"number"===t.type?s="number":"checkbox"===t.type&&(s="checkbox");const{root:n,path:a}=r(e,i,this.evaluator.state);let o=n;if(a.length>0){for(let t=0;t<a.length-1;t++)"object"==typeof o[a[t]]&&null!==o[a[t]]||(o[a[t]]={}),o=o[a[t]];const e=a[a.length-1];"number"===t.type?"number"!=typeof o[e]&&(o[e]=0):"checkbox"===t.type?"boolean"!=typeof o[e]&&(o[e]=!1):"string"!=typeof o[e]&&(o[e]="")}else"object"==typeof o&&null!==o||("number"===t.type?"number"!=typeof this.evaluator.state[e]&&(this.evaluator.state[e]=0):"checkbox"===t.type?"boolean"!=typeof this.evaluator.state[e]&&(this.evaluator.state[e]=!1):"string"!=typeof this.evaluator.state[e]&&(this.evaluator.state[e]=""));const c=()=>{const s=this.evaluator.evalExpr(e,i);if("checkbox"===t.type)t.checked=!!s;else if("radio"===t.type)t.checked=s==t.value;else if("color"===t.type)s&&"string"==typeof s&&s.match(/^#[0-9A-Fa-f]{6}$/)?t.value=s:s&&"string"==typeof s&&s.match(/^[0-9A-Fa-f]{6}$/)?t.value="#"+s:t.value="#000000";else{const e=null==s?"":String(s);t.value!==e&&(t.value=e)}};this.modelBindings.push({el:t,update:c}),c();const l=()=>{let s=null;"number"===t.type?s="number":"checkbox"===t.type&&(s="checkbox");const{root:n,path:a}=r(e,i,this.evaluator.state);let o,c=n;if(o="checkbox"===t.type?t.checked:"number"===t.type?""===t.value?void 0:Number(t.value):t.value,a.length>0){for(let t=0;t<a.length-1;t++)"object"==typeof c[a[t]]&&null!==c[a[t]]||(c[a[t]]={}),c=c[a[t]];c[a[a.length-1]]=o}else"object"==typeof c&&null!==c||(this.evaluator.state[e]=o);this.renderCallback()};"checkbox"===t.type||"radio"===t.type?t.addEventListener("change",l):t.addEventListener("input",l)}bindValidation(t,e,i=null){const s=[];let r="",n=!1;for(let t=0;t<e.length;t++){const i=e[t];"^"!==i||n?"$"===i&&n?(n=!1,r+=i,s.push(r.trim()),r=""):","!==i||n?r+=i:(r.trim()&&s.push(r.trim()),r=""):(n=!0,r+=i)}if(r.trim()&&s.push(r.trim()),!i)return;this.evaluator.state._validate||(this.evaluator.state._validate={}),this.evaluator.state._validate[i]=!1;const a=()=>{let e=!0;for(const i of s)if(/^\^.*\$$/.test(i))try{const s=new RegExp(i);if(!s.test(t.value||"")){e=!1;break}}catch(t){e=!1;break}else if("required"===i){if(!t.value||!t.value.trim()){e=!1;break}}else if(i.startsWith("minLength:")){const s=parseInt(i.split(":")[1],10);if(t.value.length<s){e=!1;break}}else if(i.startsWith("maxLength:")){const s=parseInt(i.split(":")[1],10);if(t.value.length>s){e=!1;break}}else if(i.startsWith("min:")){const s=parseFloat(i.split(":")[1]),r=parseFloat(t.value);if(isNaN(r)||r<s){e=!1;break}}else if(i.startsWith("max:")){const s=parseFloat(i.split(":")[1]),r=parseFloat(t.value);if(isNaN(r)||r>s){e=!1;break}}else if("email"===i){if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(t.value||"")){e=!1;break}}else if("phone"===i){if(!/^\+\d{1,3}\s?\d{3,4}\s?\d{3,4}\s?\d{3,4}$/.test(t.value||"")){e=!1;break}}else if("password"===i){if(!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(t.value||"")){e=!1;break}}else if(i.startsWith("regex:")){let s=i.slice(6);try{if(!new RegExp(s).test(t.value||"")){e=!1;break}}catch(t){e=!1;break}}return this.evaluator.state._validate[i]=e,t.classList.toggle("invalid",!e),t.classList.toggle("valid",e&&t.value.length>0),e};a(),t.addEventListener("input",(()=>{a(),this.renderCallback()})),t.addEventListener("blur",a)}updateBindings(){this.modelBindings.forEach((t=>t.update()))}clearBindings(){this.modelBindings=[]}}class x{isBot(){const t=navigator.userAgent.toLowerCase();return/bot|crawler|spider|googlebot|bingbot|facebookexternalhit|twitterbot/i.test(t)}renderForSEO(){this.processAllDirectivesSync(),this.loadAllComponentsSync(),this.executeAllFetchSync(),this.generateMetaTags()}processAllDirectivesSync(){document.querySelectorAll("[\\@if]").forEach((t=>{const e=t.getAttribute("@if");let i=!1;try{i=this.evaluator.evalExpr(e,this.state)}catch{}t.style.display=i?"":"none"}));document.querySelectorAll("[\\@for]").forEach((t=>{const e=t.getAttribute("@for");let i=e.match(/(\\w+),\\s*(\\w+) in (.+)/),s=[],r=null,n=null,a=null;if(i?(n=i[1],r=i[2],a=i[3]):(i=e.match(/(\\w+) in (.+)/),i&&(r=i[1],a=i[2])),a)try{s=this.evaluator.evalExpr(a,this.state)||[],"object"!=typeof s||Array.isArray(s)||(s=Object.values(s))}catch{}const o=t.parentNode;o&&(o.querySelectorAll("[data-ayisha-for-clone]").forEach((t=>t.remove())),t.style.display="none",s.forEach(((e,i)=>{const s=t.cloneNode(!0);s.removeAttribute("@for"),s.setAttribute("data-ayisha-for-clone","1"),s.style.display="";const a=document.createTreeWalker(s,NodeFilter.SHOW_TEXT,null,!1);let c;for(;c=a.nextNode();){let t=c.textContent;r&&(t=t.replace(new RegExp("{{\\s*"+r+"\\s*}}","g"),e)),n&&(t=t.replace(new RegExp("{{\\s*"+n+"\\s*}}","g"),i)),c.textContent=t}o.insertBefore(s,t.nextSibling)})))}));document.querySelectorAll("[\\@model]").forEach((t=>{const e=t.getAttribute("@model");let i="";try{i=this.evaluator.evalExpr(e,this.state)}catch{}"checkbox"===t.type?t.checked=!!i:"radio"===t.type?t.checked=i==t.value:t.value=null==i?"":String(i)}))}loadAllComponentsSync(){document.querySelectorAll("[data-component]").forEach((t=>{const e=t.getAttribute("data-component");this.components&&this.components[e]&&(t.innerHTML=this.components[e])}))}executeAllFetchSync(){const t=document.querySelectorAll("[\\@fetch]"),e=[];if(t.forEach((t=>{const i=t.getAttribute("@fetch");let s=i,r="result";const n=i.match(/(.+) as (\w+)/);n&&(s=n[1].trim(),r=n[2].trim());try{s=this.evaluator.evalExpr(s,this.state)}catch{}s&&e.push(fetch(s).then((t=>t.json())).then((t=>{this.state[r]=t})).catch((()=>{this.state[r]=null})))})),e.length>0){const t=Date.now();let i=!1;for(Promise.all(e).then((()=>{i=!0}));!i&&Date.now()-t<2e3;);}}generateMetaTags(){const t=document.querySelector("h1");t&&!document.title&&(document.title=t.textContent);const e=document.body.textContent.slice(0,160);if(!document.querySelector('meta[name="description"]')){const t=document.createElement("meta");t.name="description",t.content=e,document.head.appendChild(t)}}_handleWhenActionDirectives(t,e){if(!t.directives||!t.directives["@when"])return;const i=t.directives["@when"],s=t.directives["@do"],r=t.directives["@go"],n=t.directives["@wait"],a=t.directives["@fetch"],o=t.directives["@result"];if(!s&&!r&&!a)return void(t._el&&t._el.setAttribute("data-ayisha-when-error","@when richiede almeno @do, @go o @fetch"));this._whenDirectiveTimers||(this._whenDirectiveTimers=new WeakMap),this._whenDirectiveLoopGuards||(this._whenDirectiveLoopGuards=new WeakMap);let c=this._whenDirectiveTimers.get(t)||null,l=this._whenDirectiveLoopGuards.get(t)||{count:0,lastPage:null,lastDo:null,lastTime:0};const h=()=>{try{return!!this.evaluator.evalExpr(i,e)}catch{return!1}},d=()=>{const i=Date.now();let n="";if(r&&(n+="go:"+this.evaluator.evalExpr(r,e)),s&&(n+="do:"+s),a&&(n+="fetch:"+a),n===l.lastDo&&i-l.lastTime<2e3?l.count++:l.count=1,l.lastDo=n,l.lastTime=i,this._whenDirectiveLoopGuards.set(t,l),l.count>5)t._el&&t._el.setAttribute("data-ayisha-when-error","Loop rilevato nelle direttive @when/@go/@do/@fetch");else{if(s)try{this.evaluator.executeDirectiveExpression(s,e)}catch(t){}if(r)try{let t=r;if(t=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(r.trim())?void 0!==this.state[r.trim()]?this.evaluator.evalExpr(r,e):r.trim():this.evaluator.evalExpr(r,e),"string"==typeof t){if(this.state._currentPage=t,window&&window.history&&"function"==typeof window.history.pushState){let e=t;!/\.html$/.test(e)&&document.querySelector(`component[@page='${t}']`)&&(e=t+".html"),window.history.pushState({},"",e),window.dispatchEvent(new PopStateEvent("popstate"))}"function"==typeof window.ayisha?.render&&setTimeout((()=>window.ayisha.render()),0)}}catch(t){}if(a)try{this.fetchManager.setupFetch(a,o||"result",e,null,!0)}catch(t){}}};this._whenDirectiveLastValues||(this._whenDirectiveLastValues=new WeakMap);let u=!1;const p=()=>{const i=h();let s=this._whenDirectiveLastValues.get(t);if(!i||s||u)!i&&c&&(clearTimeout(c),c=null,u=!1,this._whenDirectiveTimers.delete(t));else if(n){let i=parseInt(this.evaluator.evalExpr(n,e),10);isNaN(i)&&(i=0),c&&clearTimeout(c),u=!0,c=setTimeout((()=>{d(),c=null,u=!1,this._whenDirectiveTimers.delete(t)}),i),this._whenDirectiveTimers.set(t,c)}else d();this._whenDirectiveLastValues.set(t,i)};t._ayishaWhenWatcher||(t._ayishaWhenWatcher=!0,this._whenDirectiveWatchers||(this._whenDirectiveWatchers=[]),this._whenDirectiveWatchers.push(p)),this._whenDirectiveLastValues.has(t)||this._whenDirectiveLastValues.set(t,h())}static version="1.0.1";constructor(o=document.body){if(this.root=o,this.state={},this._initBlocks=[],this._vdom=null,this._isRendering=!1,this._processedSetDirectives=new Set,this._componentRenderTimeout=null,this._setNodes=new WeakSet,this.evaluator=new t(this.state),this.parser=new e(this._initBlocks),this.componentManager=new i,this.reactivitySystem=new s(this.state,(()=>this.render())),this.router=new r(this.state,(()=>this.render())),this.fetchManager=new n(this.evaluator),this.helpSystem=new a,this.errorHandler=new b,this.bindingManager=new w(this.evaluator,(()=>this.render())),this.centralLogger=new y,this.centralLogger.initializeLoggers(this.evaluator,this.fetchManager,this.componentManager),!("_currentPage"in this.state)||!this.state._currentPage){let t=null,e=[];try{e=document.querySelectorAll("[@page]")}catch(t){try{e=document.querySelectorAll("[@page]")}catch(t){e=[]}}e.length>0&&(t=e[0].getAttribute("@page")),this.state._currentPage=t||"home"}this.isBot&&"function"==typeof this.isBot&&this.isBot()&&this.renderForSEO(),window.ayisha=this}component(t,e){this.componentManager.component(t,e)}addWatcher(t,e){this.reactivitySystem.addWatcher(t,e)}directiveHelp(t){return this.helpSystem.getHelp(t)}parse(t){return this.parser.parse(t)}_runInitBlocks(){if(this._isRendering)return;this._initBlocks.forEach((t=>{if(!t||!t.trim())return;let e=t.trim().replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n\s*\n/g,"\n").replace(/\n\s+/g,"\n").trim();const i=e.split("\n");e=i.map((t=>{const e=t.trim();if(!e||e.startsWith("function")||e.includes("function(")||e.includes("=>")||/^(if|else|for|while|switch|case|default|try|catch|finally|return|var|let|const)\b/.test(e))return t;const i=e.match(/^([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*(.+)$/);if(i&&!e.includes("state.")&&!e.includes("this.")&&!e.includes("window.")&&!e.includes("console.")&&!e.includes("localStorage.")&&!e.includes("sessionStorage.")){const[,e,s]=i;if(!["JSON","Object","Array","String","Number","Boolean","Date","Math","RegExp"].includes(e))return t.replace(i[0],`state.${e} = ${s}`)}return t})).join("\n");try{new Function("state",e)(this.state)}catch(t){}}));["JSON","Object","Array","String","Number","Boolean","Date","Math","RegExp","console","window","document","setTimeout","setInterval","fetch","localStorage","sessionStorage","history","location","navigator","undefined","null","true","false"].forEach((t=>{t in this.state&&delete this.state[t]}));Object.keys(this.state).forEach((t=>{/[+\-*\/=<>!&|(){}[\].,\s]|=>|==|!=|<=|>=|\|\||&&/.test(t)&&delete this.state[t]}));["_validate","_currentPage","_version","_locale"].forEach((t=>{t in this.state||("_validate"===t?this.state[t]={}:"_currentPage"===t?this.state[t]="":"_version"===t?this.state[t]=x.version:"_locale"===t&&(this.state[t]=navigator.language||navigator.userLanguage||"en"))}))}_preInitializeEssentialVariables(){this.state._validate||(this.state._validate={}),this.state._currentPage||(this.state._currentPage=""),this.state._version||(this.state._version=x.version),this.state._locale||(this.state._locale=navigator.language||navigator.userLanguage||"en");const t=()=>{var t;this.state._currentBreakpoint=(t=window.innerWidth)<576?"xs":t<768?"sm":t<992?"md":t<1200?"lg":t<1400?"xl":"xxl",this.state._screenSize=window.innerWidth};t(),this._breakpointListenerAdded||(window.addEventListener("resize",t),this._breakpointListenerAdded=!0)}_makeReactive(){this.state=this.reactivitySystem.makeReactive(),this.evaluator.state=this.state,this.fetchManager.evaluator.state=this.state}_setupRouting(){this.router.setupRouting()}_findFirstPageDirective(t){if(!t)return null;if(t.directives&&t.directives["@page"])return t;if(t.children&&t.children.length)for(const e of t.children){const t=this._findFirstPageDirective(e);if(t)return t}return null}async preloadComponents(){const t=[],e=new Set;if(this.root.querySelectorAll("component").forEach((i=>{let s=null;if(i.hasAttribute("src"))s=i.getAttribute("src");else if(i.hasAttribute("@src")){const t=i.getAttribute("@src");if(/^['\"].*['\"]$/.test(t))s=t.slice(1,-1);else try{s=this.evaluator.evalExpr(t)}catch(e){(t.includes(".html")||t.startsWith("./"))&&(s=t)}}!s||e.has(s)||this.componentManager.getCachedComponent(s)||(e.add(s),t.push(this.componentManager.loadExternalComponent(s)))})),t.length>0)try{await Promise.allSettled(t)}catch(t){}}render(){if(this._isRendering)return;this._isRendering=!0;const t=window.scrollX,e=window.scrollY,i=document.activeElement;let s=null;if(i&&("INPUT"===i.tagName||"TEXTAREA"===i.tagName)){const t=[];let e=i;for(;e&&e!==this.root;){const i=e.parentNode;t.unshift([...i.childNodes].indexOf(e)),e=i}s={path:t,start:i.selectionStart,end:i.selectionEnd,type:i.type}}this.bindingManager.clearBindings();const r=this._renderVNode(this._vdom,this.state);if(this.root===document.body?(document.body.innerHTML="",r&&(void 0===r.tagName&&r.childNodes?Array.from(r.childNodes).forEach((t=>document.body.appendChild(t))):(DocumentFragment,document.body.appendChild(r)))):(this.root.innerHTML="",r&&(void 0===r.tagName&&r.childNodes?Array.from(r.childNodes).forEach((t=>this.root.appendChild(t))):(DocumentFragment,this.root.appendChild(r)))),s){let t=this.root;if(s.path.forEach((e=>t=t.childNodes[e])),t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName)){t.focus();try{("INPUT"===t.tagName&&"number"==typeof t.selectionStart&&"function"==typeof t.setSelectionRange&&"number"!==t.type||"TEXTAREA"===t.tagName)&&t.setSelectionRange(s.start,s.end)}catch(t){}}}this._addLogIndicators(),window.scrollTo(t,e),this.bindingManager.updateBindings(),this._whenDirectiveWatchers&&this._whenDirectiveWatchers.forEach((t=>{try{t()}catch{}})),this._isRendering=!1}_addLogIndicators(){this.root.querySelectorAll('[data-ayisha-log="true"]').forEach((t=>{const e=t.nextElementSibling;e&&e.classList.contains("ayisha-log-display")&&e.remove();try{const e=JSON.parse(t.getAttribute("data-ayisha-log-info")||"{}"),i=document.createElement("div");i.className="ayisha-log-display",i.style.cssText="\n            background: rgba(0, 20, 40, 0.95) !important;\n            color: #fff !important;\n            padding: 8px 12px !important;\n            margin: 4px 0 !important;\n            border-radius: 6px !important;\n            font-family: 'JetBrains Mono', 'Courier New', monospace !important;\n            font-size: 11px !important;\n            border-left: 4px solid #0066cc !important;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;\n            max-width: 400px !important;\n            overflow-x: auto !important;\n            line-height: 1.4 !important;\n          ";const s=this._generateInlineLogContent(t,e);i.innerHTML=s,t.parentNode&&t.parentNode.insertBefore(i,t.nextSibling)}catch(t){}}));this.root.querySelectorAll("[data-ayisha-log-error]").forEach((t=>{const e=t.getAttribute("data-ayisha-log-error"),i=document.createElement("div");i.className="ayisha-log-error-display",i.style.cssText="\n          background: rgba(255, 0, 0, 0.9) !important;\n          color: white !important;\n          padding: 8px 12px !important;\n          margin: 4px 0 !important;\n          border-radius: 6px !important;\n          font-family: monospace !important;\n          font-size: 11px !important;\n          font-weight: bold !important;\n          display: block !important;\n        ",i.innerHTML=`❌ Log Error: ${e}`,t.parentNode&&t.parentNode.insertBefore(i,t.nextSibling)}))}_generateInlineLogContent(t,e){const i={tag:e.tag||t.tagName.toLowerCase(),directives:e.directives||{},subDirectives:e.subDirectives||{}},s={};let r=`<div style="color: #66ccff; font-weight: bold; margin-bottom: 6px;">📊 &lt;${i.tag}&gt;</div>`,n=!1,a=0;if(Object.keys(i.directives).forEach((t=>{if("@log"!==t)if(a++,this.centralLogger.loggers[t]){n=!0;try{const e=this.centralLogger.loggers[t].log(i,s,this.state);r+=this._formatDirectiveLog(t,e.data)}catch(e){r+=`<div style="color: #ff6b6b; margin: 2px 0;">\n              <span style="color: #ff9999;">${t}</span>: \n              <span style="color: #ffcccc;">❌ ${e.message}</span>\n            </div>`}}else r+=`<div style="color: #999; margin: 2px 0;">\n            <span style="color: #ccc;">${t}</span>: \n            <span style="color: #aaa;">${this._truncateValue(i.directives[t])}</span>\n            <span style="color: #777; font-size: 10px;"> [untracked]</span>\n          </div>`})),Object.entries(i.subDirectives||{}).forEach((([t,e])=>{Object.keys(e).forEach((o=>{a++;const c=`${t}:${o}`;if(this.centralLogger.loggers[t]){n=!0;try{const e=this.centralLogger.loggers[t].log(i,s,this.state);r+=this._formatDirectiveLog(c,e.data,!0)}catch(t){r+=`<div style="color: #ff6b6b; margin: 2px 0;">\n                <span style="color: #ff9999;">${c}</span>: \n                <span style="color: #ffcccc;">❌ ${t.message}</span>\n              </div>`}}else r+=`<div style="color: #999; margin: 2px 0;">\n              <span style="color: #ccc;">${c}</span>: \n              <span style="color: #aaa;">${this._truncateValue(e[o])}</span>\n              <span style="color: #777; font-size: 10px;"> [untracked]</span>\n            </div>`}))})),0===a?r+='<div style="color: #ff9966; font-style: italic; margin: 4px 0;">\n          ⚠️ Element has @log but no other directives\n        </div>':n||(r+=`<div style="color: #ffa726; font-style: italic; margin: 4px 0;">\n          Found ${a} directive(s) but none are tracked by loggers\n        </div>`),e.elementInfo){const t=e.elementInfo;(t.className||t.id)&&(r+=`<div style="color: #666; font-size: 10px; margin-top: 4px; padding-top: 2px; border-top: 1px solid #333;">\n            ${t.className?`Class: ${t.className}`:""}${t.className&&t.id?" | ":""}${t.id?`ID: ${t.id}`:""}\n          </div>`)}return r+=`<div style="color: #666; font-size: 10px; margin-top: 4px; border-top: 1px solid #333; padding-top: 2px;">\n        ${(new Date).toLocaleTimeString()}\n      </div>`,r}_formatDirectiveLog(t,e,i=!1){const s=i?"📎":"📋";let r='<div style="margin: 4px 0; padding: 4px; background: rgba(255,255,255,0.03); border-radius: 3px;">';if(r+=`<div style="color: ${this._getDirectiveColor(t.split(":")[0])}; font-weight: bold; font-size: 11px; margin-bottom: 2px;">\n        ${s} ${t}\n      </div>`,!e)return r+='<div style="color: #999;">No data available</div>',r+="</div>",r;switch(t.split(":")[0]){case"@for":r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Array: <strong style="color: #ffcc66;">${e.arrayVariable||"unknown"}</strong> (${e.length||0} items)<br>\n            Status: <span style="color: ${this._getStatusColor(e.status)};">${e.status||"unknown"}</span><br>\n            Item var: <span style="color: #66ccff;">${e.itemVariable||"unknown"}</span>\n            ${e.indexVariable?`, Index var: <span style="color: #66ccff;">${e.indexVariable}</span>`:""}\n          </div>`;break;case"@fetch":const t=e.url||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            URL: <strong style="color: #66ff66;">${t.slice(0,35)}${t.length>35?"...":""}</strong><br>\n            Result var: <span style="color: #ffcc66;">${e.resultVariable||"result"}</span><br>\n            Status: <span style="color: ${this._getStatusColor(e.status)};">${e.status||"unknown"}</span><br>\n            Size: <span style="color: #ccc;">${e.responseSize||"N/A"}</span>\n          </div>`;break;case"@model":const i=e.currentValue,s="string"==typeof i?`"${i.slice(0,20)}${i.length>20?"...":""}"`:JSON.stringify(i);r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Variable: <strong style="color: #66ccff;">${e.variable||"unknown"}</strong><br>\n            Value: <span style="color: #ffcc66;">${s}</span> \n            <span style="color: #999;">(${e.valueType})</span><br>\n            ${e.validation?`Validation: <span style="color: ${this._getStatusColor(e.validation.status)};">${e.validation.status}</span>`:"No validation"}\n          </div>`;break;case"@if":case"@show":case"@hide":const n=e.condition||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Condition: <strong style="color: #ffcc66;">${n.slice(0,25)}${n.length>25?"...":""}</strong><br>\n            Result: <span style="color: #66ccff;">${e.result}</span> → \n            <span style="color: ${e.isVisible?"#66bb6a":"#ff6b6b"};">${e.isVisible?"Visible":"Hidden"}</span>\n          </div>`;break;case"@click":const a=e.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${a.slice(0,25)}${a.length>25?"...":""}</strong><br>\n            Clicks: <span style="color: #66ccff;">${e.clickCount||0}</span><br>\n            Last: <span style="color: #999;">${e.lastClick||"Never"}</span>\n          </div>`;break;case"@component":const o=e.source||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Source: <strong style="color: #66ccff;">${o.slice(0,30)}${o.length>30?"...":""}</strong><br>\n            Status: <span style="color: ${this._getStatusColor(e.status)};">${e.status||"unknown"}</span><br>\n            Cached: <span style="color: ${e.cached?"#66bb6a":"#ff9800"};">${e.cached?"Yes":"No"}</span>\n          </div>`;break;case"@input":const c=e.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${c.slice(0,25)}${c.length>25?"...":""}</strong><br>\n            Inputs: <span style="color: #66ccff;">${e.inputCount||0}</span><br>\n            Last: <span style="color: #999;">${e.lastInput||"Never"}</span>\n          </div>`;break;case"@focus":const l=e.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${l.slice(0,25)}${l.length>25?"...":""}</strong><br>\n            Focus events: <span style="color: #66ccff;">${e.focusCount||0}</span><br>\n            Last: <span style="color: #999;">${e.lastFocus||"Never"}</span>\n          </div>`;break;case"@blur":const h=e.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${h.slice(0,25)}${h.length>25?"...":""}</strong><br>\n            Blur events: <span style="color: #66ccff;">${e.blurCount||0}</span><br>\n            Last: <span style="color: #999;">${e.lastBlur||"Never"}</span>\n          </div>`;break;case"@change":const d=e.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${d.slice(0,25)}${d.length>25?"...":""}</strong><br>\n            Change events: <span style="color: #66ccff;">${e.changeCount||0}</span><br>\n            Last: <span style="color: #999;">${e.lastChange||"Never"}</span>\n          </div>`;break;default:r+=`<div style="color: #cccccc; font-size: 10px;">\n            Expression: <span style="color: #ffcc66;">${e.expression||"N/A"}</span><br>\n            Status: <span style="color: #999;">${e.status||"unknown"}</span>\n          </div>`}return e.error&&(r+=`<div style="color: #ff6b6b; font-size: 9px; margin-top: 2px; padding: 2px; background: rgba(255,0,0,0.1); border-radius: 2px;">\n          💥 ${e.error}\n        </div>`),r+="</div>",r}_getDirectiveColor(t){return{"@for":"#ff9800","@fetch":"#4caf50","@model":"#2196f3","@if":"#9c27b0","@show":"#9c27b0","@hide":"#9c27b0","@click":"#f44336","@component":"#00bcd4",generic:"#666666"}[t]||"#666666"}_getStatusColor(t){if(!t)return"#cccccc";if("string"==typeof t){if(t.includes("error")||t.includes("❌"))return"#ff6b6b";if(t.includes("loading")||t.includes("⏳"))return"#ffa726";if(t.includes("success")||t.includes("✅"))return"#66bb6a"}return"#cccccc"}_getStatusIcon(t){return t?"error"===t?"❌":"loading"===t?"⏳":"success"===t?"✅":"unknown"===t?"❓":"📊":"📊"}_truncateValue(t,e=30){return"string"!=typeof t&&(t=String(t)),t.length>e?t.slice(0,e)+"...":t}_renderVNode(t,e){if(t.directives&&t.directives["@go"]){const i=t.directives["@go"];if(t._goHandlerAdded||(t._goHandlerAdded=!0,t._goId||(t._goId="go-"+Math.random().toString(36).substr(2,9)),setTimeout((()=>{const s=document.querySelector(`[data-ayisha-go-id="${t._goId}"]`);s&&s.addEventListener("click",(t=>{t.preventDefault();try{this.evaluator.executeDirectiveExpression(i,e,t)}catch(t){}}))}),0)),t.directives["@when"]&&(this._goWatcherAdded||(this._goWatcherAdded=new WeakSet),!this._goWatcherAdded.has(t))){this._goWatcherAdded.add(t),this._goLastValue||(this._goLastValue=new WeakMap),this._goLastValue.set(t,!1);const s=()=>{const s=!!this.evaluator.evalExpr(t.directives["@when"],e),r=this._goLastValue.get(t);if(s&&!r)try{this.evaluator.executeDirectiveExpression(i,e)}catch(t){}this._goLastValue.set(t,s)};this._goWatchers||(this._goWatchers=[]),this._goWatchers.push(s)}}if(this._goWatchers&&this._goWatchers.forEach((t=>{try{t()}catch{}})),this._handleWhenActionDirectives(t,e),!t)return null;if(this._whenDirectiveWatchers&&this._whenDirectiveWatchers.forEach((t=>{try{t()}catch{}})),t.directives&&t.directives["@set"]&&!t._setProcessed){let i=t.directives["@set"];i=Array.isArray(i)?i.flat().filter(Boolean):"string"==typeof i?i.split(/;;|\n/).map((t=>t.trim())).filter(Boolean):[i],i.forEach((i=>{try{const t=/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=/g;let s;for(;null!==(s=t.exec(i));){const t=s[1];t in this.state||(this.state[t]=void 0)}if(!this.evaluator.executeDirectiveExpression(i,e,null,!1)){const t=String(i).replace(/\bstate\./g,"");new Function("state","ctx",`with(state){with(ctx||{}){${t}}}`)(this.state,e)}}catch(e){t._setErrors||(t._setErrors=[]),t._setErrors.push(e.message)}})),t._setProcessed=!0,delete t.directives["@set"]}Object.entries(t.directives||{}).forEach((([t,e])=>{/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(e.trim())&&("@model"===t?this.evaluator.ensureVarInState(e,!0):this.evaluator.ensureVarInState(e))})),Object.values(t.subDirectives||{}).forEach((t=>Object.values(t).forEach((t=>{/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(t.trim())&&this.evaluator.ensureVarInState(t)}))));let i=null,s=null,r=null;if(t&&t.directives)for(const e of Object.keys(t.directives))if(("@src"!==e||"component"!==t.tag)&&"@attr"!==e&&"@then"!==e&&"@finally"!==e&&!this.helpSystem.isValidDirective(e)){i=e;break}if(!i&&t&&t.subDirectives)for(const[e,i]of Object.entries(t.subDirectives)){for(const t of Object.keys(i)){const i=`${e}:${t}`;if(!this.helpSystem.isValidDirective(i)){s=e,r=t;break}}if(s)break}if(i||s){let t="";if(i)t=`Error: Unknown directive <b>${i}</b>.`,t+="<br>"+this.directiveHelp(i);else{const e=`${s}:${r}`;t=`Error: Unknown sub-directive <b>${e}</b>.`,t+="<br>"+this.directiveHelp(e)}return this.errorHandler.createErrorElement(t)}if("text"===t.type)return document.createTextNode(this.evaluator.evalText(t.text,e));if("fragment"===t.tag){const i=document.createDocumentFragment();return t.children.forEach((t=>{const s=this._renderVNode(t,e);s&&i.appendChild(s)})),i}if(t.directives["@if"]&&!this.evaluator.evalExpr(t.directives["@if"],e))return null;if(t.directives["@show"]&&!this.evaluator.evalExpr(t.directives["@show"],e))return null;if(t.directives["@hide"]&&this.evaluator.evalExpr(t.directives["@hide"],e))return null;if(t.directives["@for"])return this._handleForDirective(t,e);if(t.directives["@switch"])return this._handleSwitchDirective(t,e);if(t.directives["@source"])return this._handleFunctionalDirectives(t,e);if("component"===t.tag){if(t.directives["@page"]){const i=t.directives["@page"],s=this.state._currentPage||this.state.currentPage;if(String(i)!==String(s))return this._handleComponentDirective(t,e),null}return this._handleComponentDirective(t,e)}if("no"===t.tag)return this._handleNoDirective(t,e);const n=document.createElement(t.tag);if(t.directives&&t.directives["@go"]&&t._goId&&(n.setAttribute("data-ayisha-go-id",t._goId),n.style.cursor="pointer"),Object.entries(t.attrs).forEach((([t,i])=>{n.setAttribute(t,this.evaluator.evalAttrValue(i,e))})),this._handleSpecialDirectives(n,t,e),this._handleStandardDirectives(n,t,e),t.children.forEach((t=>{const i=this._renderVNode(t,e);i&&n.appendChild(i)})),this._handleSubDirectives(n,t,e),t.directives&&t.directives["@then"]){let i=t.directives["@then"];i=Array.isArray(i)?i.flat().filter(Boolean):"string"==typeof i?i.split(/;;|\n/).map((t=>t.trim())).filter(Boolean):[i],i.forEach((t=>{try{if(!this.evaluator.executeDirectiveExpression(t,e,null,!1)){const i=String(t).replace(/\bstate\./g,"");new Function("state","ctx",`with(state){with(ctx||{}){${i}}}`)(this.state,e)}}catch(t){n.setAttribute("data-ayisha-then-error",t.message)}}))}if(t.directives&&t.directives["@finally"]){let i=t.directives["@finally"];i=Array.isArray(i)?i.flat().filter(Boolean):"string"==typeof i?i.split(/;;|\n/).map((t=>t.trim())).filter(Boolean):[i],i.forEach((t=>{try{if(!this.evaluator.executeDirectiveExpression(t,e,null,!1)){const i=String(t).replace(/\bstate\./g,"");new Function("state","ctx",`with(state){with(ctx||{}){${i}}}`)(this.state,e)}}catch(t){n.setAttribute("data-ayisha-finally-error",t.message)}}))}return n}_handleForDirective(t,e){let i=t.directives["@for"].match(/(\w+),\s*(\w+) in (.+)/);if(i){const[,s,r,n]=i;let a=this.evaluator.evalExpr(n,e)||[];"object"!=typeof a||Array.isArray(a)||(a=Object.values(a));const o=document.createDocumentFragment();return a.forEach(((i,a)=>{const c=JSON.parse(JSON.stringify(t));delete c.directives["@for"];const l={...e,[r]:i,[s]:a,[`${r}_index`]:a,[`${r}_ref`]:`${n.split(".")[0]}[${a}]`},h=this._renderVNode(c,l);h&&o.appendChild(h)})),o}if(i=t.directives["@for"].match(/(\w+) in (.+)/),i){const[,s,r]=i;let n=this.evaluator.evalExpr(r,e)||[];"object"!=typeof n||Array.isArray(n)||(n=Object.values(n));const a=r.split(".")[0],o=r.includes(".filter"),c=document.createDocumentFragment();return n.forEach(((i,r)=>{const n=JSON.parse(JSON.stringify(t));delete n.directives["@for"];let l=r;o&&this.state[a]&&(l=this.state[a].findIndex((t=>t.id===i.id||JSON.stringify(t)===JSON.stringify(i))));const h={...e,[s]:i,$index:r,$originalIndex:l,$arrayName:a},d=this._renderVNode(n,h);d&&c.appendChild(d)})),c}return null}_handleSwitchDirective(t,e){const i=this.evaluator.evalExpr(t.directives["@switch"],e);let s=null;for(const r of t.children)if(r.directives){if(null!=r.directives["@case"]){let t=r.directives["@case"];if(/^['"].*['"]$/.test(t)&&(t=t.slice(1,-1)),String(t)===String(i))return this._renderVNode(r,e)}null!=r.directives["@default"]&&(s=r)}return s?this._renderVNode(s,e):document.createComment("noswitch")}_handleFunctionalDirectives(t,e){let i=this.evaluator.evalExpr(t.directives["@source"],e),s=[];s=Array.isArray(i)?i:i&&"object"==typeof i?Object.values(i):null==i?[]:[i];const r=(t,e)=>{JSON.stringify(this.state[t])!==JSON.stringify(e)&&Object.defineProperty(this.state,t,{value:e,writable:!0,configurable:!0,enumerable:!0})};let n=!1;if(t.directives["@map"]){n=!0;try{const e=t.directives["@map"];let i;if(e.includes("=>")){const[t,s]=e.split("=>").map((t=>t.trim()));i=new Function(t.trim(),`return (${s})`)}else i=new Function("item",`return (${e})`);const n=s.map(i);r(t.directives["@result"]||"result",n)}catch(e){r(t.directives["@result"]||"result",[])}}if(t.directives["@filter"]){n=!0;try{const e=t.directives["@filter"];let i;if(e.includes("=>")){const[t,s]=e.split("=>").map((t=>t.trim()));i=new Function(t.trim(),`return (${s})`)}else i=new Function("item",`return (${e})`);const n=s.filter(i);r(t.directives["@result"]||"result",n)}catch(e){r(t.directives["@result"]||"result",[])}}if(t.directives["@reduce"]){n=!0;try{const i=t.directives["@reduce"];let n;if(i.includes("=>")){const[t,e]=i.split("=>").map((t=>t.trim())),[s,r]=t.replace(/[()]/g,"").split(",").map((t=>t.trim()));n=new Function(s,r,`return (${e})`)}else n=new Function("acc","item",`return (${i})`);const a=t.directives["@initial"]?this.evaluator.evalExpr(t.directives["@initial"],e):void 0;let o;o=0===s.length?void 0!==a?a:void 0:void 0!==a?s.reduce(n,a):s.reduce(n),r(t.directives["@result"]||"result",o)}catch(i){const s=t.directives["@initial"]?this.evaluator.evalExpr(t.directives["@initial"],e):void 0;r(t.directives["@result"]||"result",void 0!==s?s:void 0)}}return n?document.createComment("functional"):null}_handleComponentDirective(t,e){if(!t.directives["@src"])return this.errorHandler.createErrorElement("Error: <b>&lt;component&gt;</b> requires the <b>@src</b> attribute");let i=null;try{i=this.evaluator.evalExpr(t.directives["@src"],e)}catch(t){}if(!i){const e=t.directives["@src"].trim();i=/^['\"].*['\"]$/.test(e)?e.slice(1,-1):e}if(!i||"undefined"===i||"null"===i)return this.errorHandler.createErrorElement("Error: Invalid component URL");if(i.startsWith("./")&&(i=i.substring(2)),this.componentManager.getCachedComponent(i)){const t=this.componentManager.getCachedComponent(i),s=document.createElement("div");s.innerHTML=t,this._processComponentInitBlocks(s);const r=this.parse(s);if(r&&r.children){const t=document.createDocumentFragment();return r.children.forEach((i=>{const s=this._renderVNode(i,e);s&&t.appendChild(s)})),t}}this.componentManager.getCachedComponent(i)||this.componentManager.loadExternalComponent(i).then((t=>{if(t){const e=document.createElement("div");e.innerHTML=t,this._processComponentInitBlocks(e),this._isRendering||(clearTimeout(this._componentRenderTimeout),this._componentRenderTimeout=setTimeout((()=>this.render()),10))}})).catch((t=>{this.componentManager.cache[i]=`<div class='component-error' style='padding: 10px; background: #ffe6e6; border: 1px solid #ff6b6b; border-radius: 4px; color: #d32f2f;'>Errore: ${t.message}</div>`,this._isRendering||(clearTimeout(this._componentRenderTimeout),this._componentRenderTimeout=setTimeout((()=>this.render()),10))}));const s=document.createElement("div");return s.className="component-loading",s.style.cssText="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; color: #6c757d; font-size: 14px; text-align: center;",s.innerHTML=`� Loading component: <code>${i}</code>`,s}_processComponentInitBlocks(t){const e=t.querySelectorAll("init"),i=[];e.forEach((t=>{const e=t.textContent.trim();e&&(this._initBlocks.includes(e)||(i.push(e),this._initBlocks.push(e))),t.remove()})),this._runInitBlocksImmediate(i)}_runInitBlocksImmediate(t){t.forEach((t=>{if(!t||!t.trim())return;let e=t.trim().replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n\s*\n/g,"\n").replace(/\n\s+/g,"\n").trim();const i=e.split("\n");e=i.map((t=>{const e=t.trim();if(!e||e.startsWith("//")||e.startsWith("/*")||e.startsWith("function")||e.includes("function(")||e.includes("=>")||/^(if|else|for|while|switch|case|default|try|catch|finally|return|var|let|const)\b/.test(e))return t;const i=e.match(/^([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*(.+)$/);if(i&&!e.includes("state.")&&!e.includes("this.")&&!e.includes("window.")&&!e.includes("console.")&&!e.includes("localStorage.")&&!e.includes("sessionStorage.")){const[,e,s]=i;if(!["JSON","Object","Array","String","Number","Boolean","Date","Math","RegExp"].includes(e))return t.replace(i[0],`state.${e} = ${s}`)}return t})).join("\n");try{new Function("state",e)(this.state)}catch(t){}}))}_handleNoDirective(t,e){const i=document.createElement("span");if(void 0!==t.rawContent)i.textContent=t.rawContent;else{let e="";const s=t=>{if("string"==typeof t)return t;if("text"===t.type)return t.content||"";if(t.tag){let e="";t.attrs&&(e=Object.entries(t.attrs).map((([t,e])=>` ${t}="${e}"`)).join(""));let i="";t.directives&&(i=Object.entries(t.directives).map((([t,e])=>` ${t}="${e}"`)).join(""));let r="";t.subDirectives&&Object.entries(t.subDirectives).forEach((([t,e])=>{Object.entries(e).forEach((([e,i])=>{r+=` ${t}:${e}="${i}"`}))}));const n=t.children?t.children.map(s).join(""):"";return`<${t.tag}${e}${i}${r}>${n}</${t.tag}>`}return""};t.children&&t.children.length>0&&(e=t.children.map(s).join("")),i.textContent=e}return i}_handleSpecialDirectives(t,e,i){if(e.directives&&e.directives["@set"]){const s=e.directives["@set"],r=`${e.tag}-${JSON.stringify(e.attrs)}-${s}`;if(!this._processedSetDirectives.has(r)){this._processedSetDirectives.add(r);try{const t=e.directives["@set"];if(!this.evaluator.executeDirectiveExpression(t,i,null,!1)){const e=String(t).replace(/\bstate\./g,"");new Function("state","ctx",`with(state){with(ctx||{}){${e}}}`)(this.state,i)}}catch(e){t.setAttribute("data-ayisha-set-error",e.message)}}delete e.directives["@set"]}if(e.directives.hasOwnProperty("@state")){const s=document.createElement("div");s.style.backgroundColor="rgba(0, 0, 0, 0.8)",s.style.color="#fff",s.style.padding="1em",s.style.borderRadius="4px",s.style.marginTop="1em",s.style.overflow="auto";let r=this.state,n="CURRENT STATE";const a=e.directives["@state"];if("string"==typeof a&&a.trim())try{r=this.evaluator.evalExpr(a,i),n=`STATE: ${a}`}catch(t){r={error:"Invalid expression",details:t.message},n=`STATE: ${a}`}const o=document.createElement("h3");o.textContent=n,o.style.margin="0.5em 0 2em",o.style.fontSize="1.1em",o.style.fontWeight="bold",o.style.color="#fff",s.appendChild(o);const c=document.createElement("pre");c.style.margin="0",c.style.whiteSpace="pre-wrap",c.style.fontFamily="monospace",c.textContent=JSON.stringify(r,null,2),s.appendChild(c),t.appendChild(s)}if(e.directives.hasOwnProperty("@attr")){const e=document.createElement("div");e.style.backgroundColor="rgba(0, 0, 0, 0.8)",e.style.color="#fff",e.style.padding="1em",e.style.borderRadius="4px",e.style.marginTop="1em",e.style.overflow="auto";const i=document.createElement("h3");i.textContent="STATE ATTRIBUTES",i.style.margin="0.5em 0 2em",i.style.fontSize="1.1em",i.style.fontWeight="bold",i.style.color="#fff",e.appendChild(i);const s=document.createElement("ul");s.style.margin="0",s.style.padding="0 0 0 1.2em",s.style.fontFamily="monospace",s.style.fontSize="1em",Object.keys(this.state).forEach((t=>{const e=document.createElement("li");e.textContent=t,s.appendChild(e)})),e.appendChild(s),t.appendChild(e)}if(e.directives.hasOwnProperty("@log")){this.centralLogger&&this.centralLogger.loggers&&0!==Object.keys(this.centralLogger.loggers).length||this.centralLogger.initializeLoggers(this.evaluator,this.fetchManager,this.componentManager);try{const s={tagName:t.tagName,className:t.className,id:t.id};this.centralLogger.addLog(s,e,i,this.state,t);const r={tag:e.tag,directives:{...e.directives},subDirectives:{...e.subDirectives},elementInfo:s};if(t.setAttribute("data-ayisha-log","true"),t.setAttribute("data-ayisha-log-info",JSON.stringify(r)),e.directives["@click"]){const r=this.centralLogger.loggers["@click"];r&&(this.centralLogger.clickLoggers.set(t,r),t.addEventListener("click",(()=>{r.recordClick(),this.centralLogger.addLog(s,e,i,this.state,t)})))}}catch(e){t.setAttribute("data-ayisha-log-error",e.message)}}}_handleStandardDirectives(t,e,i){if(e.directives["@click"]&&t.addEventListener("click",(s=>{"BUTTON"===t.tagName&&s.preventDefault();const r=e.directives["@click"];this.evaluator.ensureVarInState(r);let n=r;this.evaluator.hasInterpolation(r)&&(n=this.evaluator.evalAttrValue(r,i));let a=n.replace(/\bstate\./g,"");try{const t=a.match(/^(\w+)\.(\w+)(\+\+|--|=.+)$/);if(t){const[,e,s,r]=t;if(i&&i[e]){const t=i[e];if(t&&"object"==typeof t&&t.id)for(const[e,n]of Object.entries(this.state))if(Array.isArray(n)){const a=n.findIndex((e=>e&&"object"==typeof e&&e.id===t.id));if(-1!==a){if("++"===r)return this.state[e][a][s]=(this.state[e][a][s]||0)+1,void setTimeout((()=>this.render()),0);if("--"===r)return this.state[e][a][s]=(this.state[e][a][s]||0)-1,void setTimeout((()=>this.render()),0);if(r.startsWith("=")){const t=r.substring(1).trim(),n=this.evaluator.evalExpr(t,i);return this.state[e][a][s]=n,void setTimeout((()=>this.render()),0)}}}if("++"===r)return t[s]=(t[s]||0)+1,void setTimeout((()=>this.render()),0);if("--"===r)return t[s]=(t[s]||0)-1,void setTimeout((()=>this.render()),0);if(r.startsWith("=")){const e=r.substring(1).trim(),n=this.evaluator.evalExpr(e,i);return t[s]=n,void setTimeout((()=>this.render()),0)}}}const e=a.match(/^(\w+)\s*=\s*(\w+)\.filter\((.+)\)$/);if(e){const[,t,s,r]=e;if(i&&r.includes("!==")&&t===s){const e=r.match(/!==\s*(\w+)\.id/);let s=null;if(e){const t=e[1];s=i[t]}else for(const[t,e]of Object.entries(i))if(e&&"object"==typeof e&&e.id&&"users"!==t){s=e;break}if(s&&s.id){const e=s.id;return this.state[t]=this.state[t].filter((t=>t.id!==e)),void setTimeout((()=>this.render()),0)}}}const r=a.match(/([\w$]+)\.(push|pop|shift|unshift|filter|map|reduce|forEach|slice|splice)/g);r&&r.forEach((t=>{const e=t.split(".")[0];e in this.state&&Array.isArray(this.state[e])||(this.state[e]=[])}));const n=a.match(/^(\w+)\+\+$/);if(n){const t=n[1];t in this.state||(this.state[t]=0);let e=Number(this.state[t])||0;return this.state[t]=e+1,void setTimeout((()=>this.render()),0)}const o=a.match(/^(\w+)--$/);if(o){const t=o[1];let e=Number(this.state[t])||0;return this.state[t]=e-1,void setTimeout((()=>this.render()),0)}const c=a.match(/^(\w+)\s*([+\-*\/])=\s*(.+)$/);if(c){const[,t,e,s]=c;let r=Number(this.state[t])||0,n=Number(this.evaluator.evalExpr(s,i))||0;switch(e){case"+":this.state[t]=r+n;break;case"-":this.state[t]=r-n;break;case"*":this.state[t]=r*n;break;case"/":this.state[t]=0!==n?r/n:r;break}return void setTimeout((()=>this.render()),0)}if(a.includes(";"))try{if(this.evaluator.executeMultipleExpressions(a,i,s))return void setTimeout((()=>this.render()),0)}catch(t){}const l=a.match(/^(\w+)\s*=\s*(.+)$/);if(l){const[,t,e]=l;if(e.includes("=>"))throw new Error("Assignment with arrow function, using fallback");const s=this.evaluator.evalExpr(e,i);return this.state[t]=s,void setTimeout((()=>this.render()),0)}try{if(this.evaluator.executeMultipleExpressions(a,i,s))return}catch(t){}new Function("state","ctx",`with(state){with(ctx||{}){${a}}}`)(this.state,i||{}),setTimeout((()=>this.render()),0)}catch(e){this.errorHandler.showAyishaError(t,e,a)}})),e.directives["@hover"]){const s=e.directives["@hover"],r=e=>{try{if(!this.evaluator.executeDirectiveExpression(s,i,e,!0)){let t=s;this.evaluator.hasInterpolation(s)&&(t=this.evaluator.evalAttrValue(s,i));const r=t.replace(/\bstate\./g,"");new Function("state","ctx","event",`with(state){with(ctx||{}){${r}}}`)(this.state,i,e)}}catch(e){this.errorHandler.showAyishaError(t,e,s)}};t.addEventListener("mouseover",r),t.addEventListener("mouseout",r)}if(e.directives["@input"]&&t.addEventListener("input",(s=>{const r=e.directives["@input"];this.evaluator.ensureVarInState(r);try{if(!this.evaluator.executeDirectiveExpression(r,i,s,!0)){let t=r;this.evaluator.hasInterpolation(r)&&(t=this.evaluator.evalAttrValue(r,i));const e=t.replace(/\bstate\./g,"");new Function("state","ctx","event",`with(state){with(ctx||{}){${e}}}`)(this.state,i,s)}}catch(e){this.errorHandler.showAyishaError(t,e,r)}})),e.directives["@focus"]&&t.addEventListener("focus",(s=>{const r=e.directives["@focus"];this.evaluator.ensureVarInState(r);try{if(!this.evaluator.executeDirectiveExpression(r,i,s,!0)){let t=r;this.evaluator.hasInterpolation(r)&&(t=this.evaluator.evalAttrValue(r,i));const e=t.replace(/\bstate\./g,"");new Function("state","ctx","event",`with(state){with(ctx||{}){${e}}}`)(this.state,i,s)}}catch(e){this.errorHandler.showAyishaError(t,e,r)}})),e.directives["@blur"]&&t.addEventListener("blur",(s=>{const r=e.directives["@blur"];this.evaluator.ensureVarInState(r);try{if(!this.evaluator.executeDirectiveExpression(r,i,s,!0)){let t=r;this.evaluator.hasInterpolation(r)&&(t=this.evaluator.evalAttrValue(r,i));const e=t.replace(/\bstate\./g,"");new Function("state","ctx","event",`with(state){with(ctx||{}){${e}}}`)(this.state,i,s)}}catch(e){this.errorHandler.showAyishaError(t,e,r)}})),e.directives["@change"]&&t.addEventListener("change",(s=>{const r=e.directives["@change"];this.evaluator.ensureVarInState(r);try{if(!this.evaluator.executeDirectiveExpression(r,i,s,!0)){let t=r;this.evaluator.hasInterpolation(r)&&(t=this.evaluator.evalAttrValue(r,i));const e=t.replace(/\bstate\./g,"");new Function("state","ctx","event",`with(state){with(ctx||{}){${e}}}`)(this.state,i,s)}}catch(e){this.errorHandler.showAyishaError(t,e,r)}})),e.directives["@fetch"]&&!e.subDirectives["@fetch"]&&!e.directives["@when"]){const t=this.evaluator.autoVarExpr(e.directives["@fetch"]),s=e.directives["@result"]||"result";this.fetchManager.setupFetch(t,s,i),e.directives["@watch"]&&this._handleWatchDirective(e,t,s)}if(e.directives["@watch"]&&!e.directives["@fetch"]&&this._handleGenericWatchDirective(e),e.directives["@text"]&&!e.subDirectives["@text"])try{const s=e.directives["@text"];if(this.evaluator.hasMultipleAssignments(s))this.evaluator.executeDirectiveExpression(s,i,null,!1);else{const e=this.evaluator.evalExpr(s,i);t.textContent=void 0===e?"":null===e?"null":String(e)}}catch(e){t.textContent=`[Error: ${e.message}]`}if(e.directives["@model"]&&this.bindingManager.bindModel(t,e.directives["@model"],i),e.directives["@class"]&&!e.subDirectives["@class"]){const s=this.evaluator.evalExpr(e.directives["@class"],i)||{};Object.entries(s).forEach((([e,i])=>t.classList.toggle(e,!!i)))}if(e.directives["@style"])try{const s=this.evaluator.evalExpr(e.directives["@style"],i)||{};"object"!=typeof s||null===s||Array.isArray(s)||Object.entries(s).forEach((([e,i])=>{"string"==typeof e&&e.trim()&&(t.style[e]=i)}))}catch(t){}if(e.directives["@validate"]){const i=e.directives["@model"]||null;this.bindingManager.bindValidation(t,e.directives["@validate"],i)}if(e.directives["@link"]&&(t.setAttribute("href",e.directives["@link"]),t.addEventListener("click",(t=>{t.preventDefault(),this.state._currentPage=e.directives["@link"]}))),e.directives["@animate"]){const i=e.directives["@animate"];t.classList.add(i),"fadeIn"!==i&&"fade-in"!==i||(t.style.opacity="1",t.style.transition="opacity 0.3s ease-in-out")}if(e.directives["@component"]){const s=e.directives["@component"];if(this.componentManager.getComponent(s)){const e=document.createRange().createContextualFragment(this.componentManager.getComponent(s)),r=this.parse(e),n=this._renderVNode(r,i);n&&t.appendChild(n)}}}_handleSubDirectives(t,e,i){Object.entries(e.subDirectives).forEach((([s,r])=>{Object.entries(r).forEach((([r,n])=>{const a="hover"===r?"mouseover":r;if(!("@click"!==s&&"@hover"!==s&&"@set"!==s&&"@fetch"!==s&&"@model"!==s&&"@focus"!==s&&"@blur"!==s&&"@change"!==s&&"@input"!==s&&"@class"!==s&&"@text"!==s||"click"!==r&&"hover"!==r&&"focus"!==r&&"input"!==r&&"change"!==r&&"blur"!==r)){const o=()=>"@class"===s&&n.trim().startsWith("{")?this.evaluator.evalExpr(n,i):this.evaluator.evalAttrValue(n,i);if("@fetch"===s)return void this._handleFetchSubDirective(t,a,n,e,i);if("@class"===s)return void this._handleClassSubDirective(t,r,o,i);if("@text"===s)return void this._handleTextSubDirective(t,r,o,i);t.addEventListener(a,(e=>{let s=o();try{const t=String(s).replace(/\bstate\./g,"");this.evaluator.executeMultipleExpressions(t,i,e)||new Function("state","ctx","event",`with(state){with(ctx||{}){${t}}}`)(this.state,i,e)}catch(e){this.errorHandler.showAyishaError(t,e,s)}}))}}))}))}_handleFetchSubDirective(t,e,i,s,r){t.addEventListener(e,(t=>{const e=s.directives["@result"]||"result";try{let s=this.evaluator.evalExpr(i,r);void 0===s&&(s=i),this.fetchManager.setupFetch(s,e,r,t,!0)}catch(s){this.fetchManager.setupFetch(i,e,r,t,!0)}}))}_handleClassSubDirective(t,e,i,s){"hover"===e?(t.addEventListener("mouseover",(e=>{try{const e=i()||{};Object.entries(e).forEach((([e,i])=>{i&&t.classList.add(e)}))}catch(t){}})),t.addEventListener("mouseout",(e=>{try{const e=i()||{};Object.entries(e).forEach((([e,i])=>{i&&t.classList.remove(e)}))}catch(t){}}))):"focus"===e?(t.addEventListener("focus",(e=>{try{const e=i()||{};Object.entries(e).forEach((([e,i])=>{i&&t.classList.add(e)}))}catch(t){}})),t.addEventListener("blur",(e=>{try{const e=i()||{};Object.entries(e).forEach((([e,i])=>{i&&t.classList.remove(e)}))}catch(t){}}))):"input"===e?(t.addEventListener("input",(e=>{try{const e=i()||{};Object.entries(e).forEach((([e,i])=>{i&&t.classList.add(e)}))}catch(t){}})),t.addEventListener("blur",(e=>{try{const e=i()||{};Object.entries(e).forEach((([e,i])=>{i&&t.classList.remove(e)}))}catch(t){}}))):"click"===e?t.addEventListener("click",(e=>{try{const e=i()||{};Object.entries(e).forEach((([e,i])=>{i&&t.classList.toggle(e)}))}catch(t){}})):t.addEventListener(e,(e=>{try{const e=i()||{};Object.entries(e).forEach((([e,i])=>{i&&t.classList.add(e)}))}catch(t){}}))}_handleTextSubDirective(t,e,i,s){t._ayishaOriginalText||(t._ayishaOriginalText=t.textContent||t.innerText||""),"click"===e?t.addEventListener("click",(e=>{const r=this.evaluator.evalExpr(i(),s,e);t.textContent=r})):"hover"===e?(t.addEventListener("mouseover",(e=>{const r=this.evaluator.evalExpr(i(),s,e);t.textContent=r})),t.addEventListener("mouseout",(()=>{t.textContent=t._ayishaOriginalText||""}))):"input"!==e&&"focus"!==e&&"blur"!==e||t.addEventListener(e,(e=>{const r=this.evaluator.evalExpr(i(),s,e);t.textContent=r}))}_handleWatchDirective(t,e,i){t.directives["@watch"].split(",").forEach((t=>{let s=(t=t.trim()).match(/^([\w$]+)\s*=>\s*(.+)$/)||t.match(/^([\w$]+)\s*:\s*(.+)$/);if(s){const t=s[1],e=s[2];this.evaluator.ensureVarInState(e),this.addWatcher(t,(function(t){const i=window.ayisha.state;try{window.ayisha.evaluator.ensureVarInState(e),window.ayisha.evaluator.executeDirectiveExpression(e,{},{newVal:t},!0)||new Function("state","newVal",`with(state) { ${e} }`)(i,t)}catch(t){}}))}else this.addWatcher(t,(()=>this.fetchManager.setupFetch(e,i,void 0,void 0,!0)))}))}_handleGenericWatchDirective(t){t.directives["@watch"].split(",").forEach((t=>{const e=(t=t.trim()).match(/^(\w+)\s*=>\s*(.+)$/)||t.match(/^(\w+)\s*:\s*(.+)$/);if(e){const t=e[1],i=e[2];this.addWatcher(t,(function(t){const e=window.ayisha.state;window.ayisha.evaluator.ensureVarInState(i);try{window.ayisha.evaluator.executeDirectiveExpression(i,{},{newVal:t},!0)||new Function("state","newVal",`with(state){ ${i} }`)(e,t)}catch(t){}}))}}))}mount(){if(this.root.childNodes.forEach((t=>{1===t.nodeType&&t.tagName&&"init"===t.tagName.toLowerCase()&&this.parser.parse(t)})),this.root.childNodes.length>1){const t={tag:"fragment",attrs:{},directives:{},subDirectives:{},children:[]};this.root.childNodes.forEach((e=>{if(1===e.nodeType&&e.tagName&&"init"===e.tagName.toLowerCase())return;const i=this.parse(e);i&&t.children.push(i)})),this._vdom=t}else this._vdom=this.parse(this.root);if(!this.state._currentPage){const t=this._findFirstPageDirective(this._vdom);t&&(this.state._currentPage=t.directives["@page"])}this._preInitializeEssentialVariables(),this._makeReactive(),this._runInitBlocks(),this.reactivitySystem.enableWatchers(),this._setupRouting(),this.router.setupCurrentPageProperty(),this.preloadComponents().then((()=>{this._isRendering||this.render()})),this.render(),this.root.addEventListener("click",(t=>{let e=t.target;for(;e&&e!==this.root;){if(e.hasAttribute("@link"))return t.preventDefault(),this.state._currentPage=e.getAttribute("@link"),void this.render();e=e.parentNode}}),!0)}}window.AyishaVDOM=x;const E=()=>{if(!document.getElementById("ayisha-default-animations")){const t=document.createElement("style");t.id="ayisha-default-animations",t.textContent="\n        .fadeIn, .fade-in {\n          animation: ayishaFadeIn 0.3s ease-in-out;\n        }\n        \n        @keyframes ayishaFadeIn {\n          from { opacity: 0; }\n          to { opacity: 1; }\n        }\n        \n        .slide-down {\n          overflow: hidden;\n          transition: height 0.3s ease-in-out;\n        }\n        \n        /* Stili per @log display come sibling */\n        .ayisha-log-display {\n          background: rgba(0, 20, 40, 0.95) !important;\n          color: #fff !important;\n          padding: 8px 12px !important;\n          margin: 4px 0 !important;\n          border-radius: 6px !important;\n          font-family: 'JetBrains Mono', 'Courier New', monospace !important;\n          font-size: 11px !important;\n          border-left: 4px solid #0066cc !important;\n          box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;\n          max-width: 400px !important;\n          overflow-x: auto !important;\n          line-height: 1.4 !important;\n          display: block !important;\n        }\n        \n        .ayisha-log-error-display {\n          background: rgba(255, 0, 0, 0.9) !important;\n          color: white !important;\n          padding: 8px 12px !important;\n          margin: 4px 0 !important;\n          border-radius: 6px !important;\n          font-family: monospace !important;\n          font-size: 11px !important;\n          font-weight: bold !important;\n          display: block !important;\n        }\n      ",document.head.appendChild(t)}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{E(),new x(document.body).mount()})):(E(),new x(document.body).mount())}();