/*!
 * Ayisha.js - Complete Modular Directive System
 * (c) 2023 devBen - Benito Massidda
 * License: MIT
 */
!function(){if("undefined"!=typeof window&&window.AyishaVDOM)return;class e{constructor(){this.errors=[],this.listeners=[]}report(e,t={}){const s={error:e,context:t,timestamp:Date.now()};this.errors.push(s),this.listeners.forEach((e=>{try{e(s)}catch{}}))}getAll(){return this.errors}clear(){this.errors=[]}onError(e){this.listeners.push(e)}}class t{constructor(e,t,s){this.vNode=e,this.ctx=t,this.ayisha=s,this.total=0,this.completed=0,this.thenQueue=[],this.finallyQueue=[],this.done=!1,this.syncCompleted=!1}addTask(e){this.total++,Promise.resolve("function"==typeof e?e():e).then((()=>this._onComplete())).catch((()=>this._onComplete()))}addAsyncTask(){return this.total++,()=>this._onComplete()}addThen(e){Array.isArray(e)?e.forEach((e=>this.thenQueue.push(e))):"string"==typeof e?e.split(/;;|\n/).map((e=>e.trim())).filter(Boolean).forEach((e=>this.thenQueue.push(e))):this.thenQueue.push(e),this._preInitializeVariablesFromExpressions(e)}addFinally(e){Array.isArray(e)?e.forEach((e=>this.finallyQueue.push(e))):"string"==typeof e?e.split(/;;|\n/).map((e=>e.trim())).filter(Boolean).forEach((e=>this.finallyQueue.push(e))):this.finallyQueue.push(e),this._preInitializeVariablesFromExpressions(e)}_preInitializeVariablesFromExpressions(e){if(!e||!this.ayisha?.evaluator)return;let t=[];t=Array.isArray(e)?e.flat().filter(Boolean):"string"==typeof e?e.split(/;;|\n/).map((e=>e.trim())).filter(Boolean):[e],t.forEach((e=>{if("string"!=typeof e)return;const t=/([a-zA-Z_$][a-zA-Z0-9_$]*(?:\.[a-zA-Z_$][a-zA-Z0-9_$]*)*)\s*=\s*[^=]/g;let s;for(;null!==(s=t.exec(e));){const e=s[1].trim();if(e.includes(".")){const t=e.split(".")[0];this._ensureVariableInState(t,"object"),this._ensureNestedPath(e)}else this._ensureVariableInState(e,"auto")}}))}_ensureVariableInState(e,t="auto"){if(!e||!this.ayisha?.evaluator?.state)return;if(!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(e))return;if(e in this.ayisha.evaluator.state)return;if(["JSON","Object","Array","String","Number","Boolean","Date","Math","RegExp","console","window","document","setTimeout","setInterval","fetch","localStorage","sessionStorage","history","location","navigator","undefined","null","true","false"].includes(e))return;let s;s="object"===t?{}:"array"===t||/items|list|array|data|results|errors|posts|todos|users|cats|dogs|products|content/.test(e)?[]:/count|total|index|id|size|length|number|num|page|limit|offset/.test(e)?0:!/show|hide|is|has|can|should|valid|enable|subscribed|loading|visible/.test(e)&&(/user|config|form|settings|profile|metadata|info/.test(e)?{}:void 0),this.ayisha.evaluator.state[e]=s}_ensureNestedPath(e){e&&this.ayisha?.evaluator?.state&&E.setNested(this.ayisha.evaluator.state,e,void 0)}_onComplete(){this.done||(this.completed++,this.completed>this.total&&(this.completed=this.total),this._checkCompletion())}markSyncDone(){this.syncCompleted=!0,this._checkCompletion()}_checkCompletion(){this.done||this.completed>=this.total&&this.syncCompleted&&(this.done=!0,this._executeThenAndFinally())}_executeThenAndFinally(){this.thenQueue.length>0?setTimeout((()=>{this.thenQueue.forEach((e=>{try{"function"==typeof e?e():this.ctx&&void 0!==this.ctx._eventResult?this.ayisha.evaluator.executeDirectiveExpression(e,this.ctx,this.ctx._eventResult,!1):this.ayisha.evaluator.executeDirectiveExpression(e,this.ctx,null,!1)}catch(e){}})),setTimeout((()=>{this.finallyQueue.length>0&&this.finallyQueue.forEach((e=>{try{"function"==typeof e?e():this.ayisha.evaluator.executeDirectiveExpression(e,this.ctx,null,!1)}catch(e){}}))}),1500)}),1500):setTimeout((()=>{this.finallyQueue.length>0&&this.finallyQueue.forEach((e=>{try{"function"==typeof e?e():this.ayisha.evaluator.executeDirectiveExpression(e,this.ctx,null,!1)}catch(e){}}))}),1500)}}class s{autoPageName(e){return"string"==typeof e&&e.trim()&&!e.trim().startsWith("'")&&!e.trim().startsWith('"')&&/^[a-zA-Z0-9_]+$/.test(e.trim())?`'${e.trim()}'`:e}extractDependencies(e){if("string"!=typeof e)return[];const t=e.match(/\b([a-zA-Z_$][a-zA-Z0-9_$]*)\b/g);if(!t)return[];const s=["true","false","null","undefined","if","else","for","while","switch","case","default","try","catch","finally","return","var","let","const","function","new","typeof","instanceof","in","do","break","continue","this","window","document","Math","Date","Array","Object","String","Number","Boolean","RegExp","JSON","console","setTimeout","setInterval","fetch","localStorage","sessionStorage","history","location","navigator"];return t.filter(((e,t,i)=>i.indexOf(e)===t&&!s.includes(e)))}constructor(e){this.state=e}evalExpr(e,t={},s){const i=e.trim();if(/^['"].*['"]$/.test(i))return i.slice(1,-1);if(/^\d+(\.\d+)?$/.test(i))return Number(i);try{const i=new Proxy(this.state,{get:(e,t)=>e[t],set:(e,t,s)=>(e[t]=s,!0)});return new Function("state","ctx","event",`with(state){with(ctx||{}){return (${e})}}`)(i,t,s)}catch{return}}executeMultipleExpressions(e,t={},s){const i=e.trim();if(!this.hasMultipleAssignments(i))return!1;const r=this.parseMultipleExpressions(i);try{const e=new Proxy(this.state,{get:(e,t)=>e[t],set:(e,t,s)=>(e[t]=s,!0)});for(const i of r)i.trim()&&new Function("state","ctx","event",`with(state){with(ctx||{}){${i.trim()}}}`)(e,t,s);return!0}catch(e){return!1}}executeDirectiveExpression(e,t={},s=null,i=!0){let r=e;this.hasInterpolation(e)&&(r=this.evalAttrValue(e,t));const n=r.replace(/\bstate\./g,"");try{if(this.executeMultipleExpressions(n,t,s))return i&&(window.ayisha?._isRendering||window.ayisha?._componentRenderQueued||(clearTimeout(window.ayisha?._componentRenderTimeout),window.ayisha._componentRenderQueued=!0,window.ayisha._componentRenderTimeout=setTimeout((()=>{window.ayisha._componentRenderQueued=!1,window.ayisha.render()}),0))),!0;return new Function("state","ctx","event",`with(state){with(ctx||{}){${n}}}`)(this.state,t||{},s),i&&(window.ayisha?._isRendering||window.ayisha?._componentRenderQueued||(clearTimeout(window.ayisha?._componentRenderTimeout),window.ayisha._componentRenderQueued=!0,window.ayisha._componentRenderTimeout=setTimeout((()=>{window.ayisha._componentRenderQueued=!1,window.ayisha.render()}),0))),!0}catch(e){return!1}}hasMultipleAssignments(e){if(e.includes("=>"))return!1;if(e.includes("(")&&e.includes(")")){return e.includes(";")}if(e.includes(";"))return!0;if(e.includes(",")&&!e.includes("("))return!0;return/\w+\s*=\s*[^=\s]+\s+\w+\s*=\s*/.test(e)}parseMultipleExpressions(e){if(e.includes(";"))return e.split(";").map((e=>e.trim())).filter((e=>e));if(e.includes(",")&&!e.includes("("))return e.split(",").map((e=>e.trim())).filter((e=>e));const t=[];let s="",i=!1,r="",n=0,a=0;for(;a<e.length;){const o=e[a];if(i||'"'!==o&&"'"!==o)if(i&&o===r&&"\\"!==e[a-1])i=!1,r="",s+=o;else if(i||"("!==o)if(i||")"!==o)if(i||" "!==o||0!==n)s+=o;else{e.substring(a+1).trim().match(/^\w+\s*=/)&&s.trim().includes("=")?(t.push(s.trim()),s=""):s+=o}else n--,s+=o;else n++,s+=o;else i=!0,r=o,s+=o;a++}return s.trim()&&t.push(s.trim()),t.length>1?t:[e]}evalText(e,t){return e.replace(/{{(.*?)}}/g,((e,s)=>{const i=this.evalExpr(s.trim(),t);return null!=i?i:""}))}evalAttrValue(e,t){let s=e.replace(/{{(.*?)}}/g,((e,s)=>{const i=this.evalExpr(s.trim(),t);return null!=i?i:""}));if(s=s.replace(/\[\{(.*?)\}\]/g,((e,s)=>{const i=this.evalExpr(s.trim(),t);return null!=i?i:""})),/^\{([^{}]+)\}$/.test(s.trim())){const e=s.trim().slice(1,-1),i=this.evalExpr(e,t);return null!=i?i:""}return s=s.replace(/\{([^{}]+)\}/g,((e,s)=>{if(/^\{\{.*\}\}$/.test(e))return e;const i=this.evalExpr(s.trim(),t);return null!=i?i:""})),s}autoVarExpr(e){return"string"==typeof e&&/^\w+$/.test(e.trim())?`{${e.trim()}}`:e}hasInterpolation(e){return/\{\{.*?\}\}|\{[\w$][\w\d$]*(?:\.[\w$][\w\d$]*|\[[^\]]+\])*\}/.test(e)}ensureVarInState(e,t=!1,s=null){if("string"!=typeof e)return;if(e.includes("=")||e.includes("<")||e.includes(">")||e.includes("!")||e.includes("&")||e.includes("|")||e.includes("'")||e.includes('"')||e.includes("(")||e.includes(")")||e.includes(" ")||e.includes("+")||e.includes("-")||e.includes("*")||e.includes("/")||e.includes("%")||e.includes("[")||e.includes("]")||e.includes("{")||e.includes("}")||e.includes("?")||e.includes(":")||e.includes(";")||e.includes(","))return;const i=["JSON","Object","Array","String","Number","Boolean","Date","Math","RegExp","console","window","document","setTimeout","setInterval","fetch","localStorage","sessionStorage","history","location","navigator","undefined","null","true","false"],r=e.match(/([\w$]+)\.(push|pop|shift|unshift|filter|map|reduce|forEach|length|slice|splice)/);if(r){const e=r[1];return void(i.includes(e)||e in this.state||(this.state[e]=[]))}const n=e.split(".")[0];if(!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n))return;i.includes(n)||n in this.state||("number"===s?this.state[n]=0:"checkbox"===s?this.state[n]=!1:t?this.state[n]=void 0:/items|list|array|data|results|errors|posts|todos|users/.test(n)?this.state[n]=[]:/count|total|index|id|size|length|number|num/.test(n)?this.state[n]=0:/show|hide|is|has|can|should|valid|enable|subscribed/.test(n)?this.state[n]=!1:/user|config|form|settings/.test(n)?this.state[n]={}:this.state[n]=void 0);const a=e.match(/([\w$][\w\d$]*(?:\.[\w$][\w\d$]*)+)/);if(a){const e=a[1].split("."),t=e[0];if(i.includes(t))return;if(!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(t))return;let s=this.state;for(let t=0;t<e.length;t++){const i=e[t];i in s?t<e.length-1&&"object"!=typeof s[i]&&(s[i]={}):s[i]=t===e.length-1?void 0:{},s=s[i]}}}safeSetArrayVariable(e,t){try{this.state[e]=t}catch(s){Object.defineProperty(this.state,e,{value:t,writable:!0,configurable:!0,enumerable:!0})}}}class i{constructor(e){this.initBlocks=e}parse(e){if(!e)return null;if(11===e.nodeType){const t={tag:"fragment",attrs:{},directives:{},subDirectives:{},children:[]};return e.childNodes.forEach((e=>{const s=this.parse(e);s&&t.children.push(s)})),t}if(3===e.nodeType)return{type:"text",text:e.textContent};if(1!==e.nodeType)return null;const t=e.tagName.toLowerCase();if("init"===t)return this.initBlocks.push(e.textContent),null;if("no"===t)return{tag:"no",attrs:{},directives:{},subDirectives:{},children:[],rawContent:e.innerHTML};const s={tag:t,attrs:{},directives:{},subDirectives:{},children:[]};for(const t of Array.from(e.attributes))if(t.name.startsWith("@")){const e=t.name.split(":");if(2===e.length){const[i,r]=e;s.subDirectives[i]=s.subDirectives[i]||{},s.subDirectives[i][r]=t.value}else s.directives[t.name]=t.value}else t.name.startsWith("#")?(s.scopedVars||(s.scopedVars={}),s.scopedVars[t.name.slice(1)]=t.value):s.attrs[t.name]=t.value;return e.childNodes&&e.childNodes.length>0&&e.childNodes.forEach((e=>{const t=this.parse(e);t&&s.children.push(t)})),s}}class r{constructor(){this.components={},this.cache={},this.loadingComponents=new Map}component(e,t){this.components[e]=t}async loadExternalComponent(e){if(this.cache[e])return this.cache[e];if(this.loadingComponents.has(e))return this.loadingComponents.get(e);const t=this._fetchComponent(e);this.loadingComponents.set(e,t);try{const s=await t;return this.cache[e]=s,s}catch(e){return null}finally{this.loadingComponents.delete(e)}}async _fetchComponent(e){const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.text()}getComponent(e){return this.components[e]}getCachedComponent(e){return this.cache[e]}isLoading(e){return this.loadingComponents.has(e)}}class n{constructor(e,t){this.state=e,this.watchers={},this._prevValues={},this._historyValues={},this._watcherOneShotFired={},this._watcherTypes={},this.renderCallback=t,this.watchersReady=!1,this._isUpdating=!1,this._renderTimeout=null}_safeStringify(e){const t=new WeakSet;try{return JSON.stringify(e,(function(e,s){if("object"==typeof s&&null!==s){if(t.has(s))return"[Circular]";t.add(s)}return"_ayishaInstance"===e?"[AyishaInstance]":s}))}catch(t){return String(e)}}makeReactive(){Object.defineProperty(this.state,"_historyValues",{value:this._historyValues,enumerable:!1,writable:!0,configurable:!0}),Object.defineProperty(this.state,"_ayishaReactivity",{value:this,enumerable:!1,writable:!0,configurable:!0}),Object.defineProperty(this.state,"_prevValues",{value:this._prevValues,enumerable:!1,writable:!0,configurable:!0});const e=this.renderCallback,t=(t,s)=>{if(!Array.isArray(t)||t._ayishaWrapped)return t;return["push","pop","shift","unshift","splice","sort","reverse"].forEach((s=>{if("function"==typeof t[s]){const i=t[s];t[s]=function(...t){const s=i.apply(this,t);return"function"==typeof e&&e(),s}}})),Object.defineProperty(t,"_ayishaWrapped",{value:!0,enumerable:!1,writable:!1,configurable:!1}),t};return this.state=new Proxy(this.state,{set:(e,s,i)=>{if(Array.isArray(i)&&(i=t(i)),this._isUpdating)return e[s]=i,!0;e._prevValues||(e._prevValues={}),e._prevValues[s]=e[s],this._historyValues[s]||(this._historyValues[s]=[]),Object.prototype.hasOwnProperty.call(e,s)&&(this._historyValues[s].push(e[s]),this._historyValues[s].length>20&&this._historyValues[s].shift());const r=e[s];return this._safeStringify(r)===this._safeStringify(i)||this._isRendering?(e[s]=i,!0):(this._isUpdating=!0,e[s]=i,this.watchersReady&&this.watchers[s]&&("oneShot"===this._watcherTypes[s]?this._watcherOneShotFired[s]||(this._watcherOneShotFired[s]=!0,this._prevValues[s]=i,this.watchers[s].forEach((e=>{try{e(i)}catch(e){}}))):this._safeStringify(this._prevValues[s])!==this._safeStringify(i)&&(this._prevValues[s]=i,this.watchers[s].forEach((e=>{try{e(i)}catch(e){}})))),this._renderTimeout&&clearTimeout(this._renderTimeout),this._renderTimeout=setTimeout((()=>{if(this._isUpdating=!1,this._renderTimeout=null,"function"==typeof this.renderCallback&&!this._isRendering){this._isRendering=!0;try{this.renderCallback()}finally{this._isRendering=!1}}}),10),!0)},get:(e,s)=>{const i=e[s];return Array.isArray(i)?t(i):i}}),this.state}addWatcher(e,t,s={}){this.watchers[e]=this.watchers[e]||[],e in this._prevValues||(this._prevValues[e]=this.state[e]),s.oneShot?(this._watcherTypes[e]="oneShot",this._watcherOneShotFired[e]=!1):this._watcherTypes[e]="reactive",this.watchers[e].push(t)}enableWatchers(){this.watchersReady=!0,Object.keys(this._watcherOneShotFired).forEach((e=>{this._watcherOneShotFired[e]=!1}))}}class a{constructor(e,t){this.state=e,this.renderCallback=t}setupRouting(){let e=location.pathname.replace(/^\//,"")||"";e&&"index.html"!==e||(history.replaceState({},"","/"),e="");let t=e.split("/").filter(Boolean);if(!t[0]){let e=null;if("undefined"!=typeof document)try{const t=document.querySelectorAll("[@page]");t.length>0&&(e=t[0].getAttribute("@page"))}catch(e){}t=[e||(this.state._currentPage&&""!==this.state._currentPage?this.state._currentPage:"home")]}this.state._currentPage=t[0]||"",this.state._params=t.slice(1),window.addEventListener("popstate",(()=>{let e=(location.pathname.replace(/^\//,"")||"").split("/").filter(Boolean);if(!e[0]){let t=null;if("undefined"!=typeof document)try{const e=document.querySelectorAll("[@page]");e.length>0&&(t=e[0].getAttribute("@page"))}catch(e){}e=[t||(this.state._currentPage&&""!==this.state._currentPage?this.state._currentPage:"home")]}this.state._currentPage=e[0]||"",this.state._params=e.slice(1),this.renderCallback()}))}setupCurrentPageProperty(){const e=this;let t=this.state._currentPage;Object.defineProperty(this.state,"_currentPage",{get:()=>t,set(s){if(t!==s){t=s;const i=s?"/"+s:"/";history.pushState({},"",i),e.renderCallback()}}})}navigate(e){const t=(e.startsWith("/")?e.substring(1):e).split("/").filter(Boolean);this.state._currentPage=t[0]||"",this.state._params=t.slice(1);const s="/"+t.join("/");history.pushState({},"",s),this.renderCallback()}}class o{constructor(e){this.evaluator=e,this.pendingFetches={},this.lastFetchUrl={},this.fetched={},this.readyPromise={},this.cacheBySignature=new Map,this.inflightBySignature=new Map}setupFetch(e,t,s,i,r){let n=this.evaluator.evalExpr(e,s,i);if(void 0===n){let t=!1;if(n=e.replace(/\{([^}]+)\}/g,((e,r)=>{const n=this.evaluator.evalExpr(r,s,i);return null==n||"string"==typeof n&&""===n.trim()?(t=!0,""):String(n)})),t)return null}if(null==n&&(n=e),(e=>{if(null==e)return!0;const t=String(e).trim();return!t||(!!/\{[^}]+\}/.test(t)||(!!/(^|\/)(undefined|null)(\/|$)/i.test(t)||!!/\/\.(?:[a-z0-9]+)?(\?|$|#)/i.test(t)))})(n))return null;if(!n)return null;if("string"==typeof n){n=n.trim();const e=n[0],t=n[n.length-1];!e||e!==t||"`"!==e&&'"'!==e&&"'"!==e||(n=n.slice(1,-1).trim())}/^https?:\/\//.test(n)||(n=n.replace(/\/+$/,""),n=n.replace(/\?$/,""),n=n.replace(/\?&/,"?"),n=n.replace(/\?$/,""),n=n.replace(/\&+$/,""),n=n.replace(/\?page=(&|$)/,"?").replace(/\?$/,""),n=n.replace(/\/\//g,"/"),n.startsWith("/")||(n="/"+n),n=location.origin+n);const a=`${n}::${t}`;let o="GET",l=null,c=null;if(s&&s._vNode){let e=null;if(s._vNode.directives&&s._vNode.directives["@method"]?e=s._vNode.directives["@method"]:s._vNode.subDirectives&&s._vNode.subDirectives["@method"]&&(e=s._vNode.subDirectives["@method"]),e){let t=this.evaluator.evalExpr(e,s,i);o="string"==typeof t&&""!==t.trim()?t.toUpperCase():"string"==typeof e&&""!==e.trim()?e.trim().toUpperCase():"GET"}s._vNode.directives&&s._vNode.directives["@payload"]&&(l=this.evaluator.evalExpr(s._vNode.directives["@payload"],s,i)),s._vNode.directives&&s._vNode.directives["@headers"]&&(c=this.evaluator.evalExpr(s._vNode.directives["@headers"],s,i))}const d=e=>Array.isArray(e)?e.map(d):e&&"object"==typeof e?Object.keys(e).sort().reduce(((t,s)=>(t[s]=d(e[s]),t)),{}):e,h=e=>{try{return JSON.stringify(d(e))}catch{return JSON.stringify(e)}},u=c&&"object"==typeof c?d(c):c,p=null!=l&&"object"==typeof l?h(l):null!=l?String(l):"",v=`${o} ${n} ${p} ${u?h(u):""}`;if(!r&&!i&&this.inflightBySignature.has(v)){const e=this.inflightBySignature.get(v);return this.readyPromise[a]=e,e}if(!r&&!i&&this.cacheBySignature.has(v)){const e=this.cacheBySignature.get(v);return this.evaluator.state[t]!==e&&(this.evaluator.state[t]=e),null}if(!r&&!i&&this.fetched[n]?.error)return null;if(this.pendingFetches[a]){const e=this.inflightBySignature.get(v)||this.readyPromise[a]||Promise.resolve(this.evaluator.state[t]);return this.readyPromise[a]=e,e}t&&"string"==typeof t&&t in this.evaluator.state&&(this.evaluator.state[t]=null),this.readyPromise[a]&&delete this.readyPromise[a],this.pendingFetches[a]=!0,this.lastFetchUrl[a]={url:n,value:this.evaluator.state[t]},this.pendingFetches[a]=!0,this.lastFetchUrl[t]=n,t in this.evaluator.state||(this.evaluator.state[t]=null);const f={method:o};let g={};null!=l&&o&&!["GET","HEAD"].includes(o.toUpperCase())&&("object"==typeof l?(f.body=JSON.stringify(l),g["Content-Type"]="application/json"):f.body=l),c&&"object"==typeof c&&(g={...g,...c}),Object.keys(g).length>0&&(f.headers=g);const m=fetch(n,f).then((e=>{if(!e.ok){this.fetched[n]||(this.fetched[n]={}),this.fetched[n].error=`${e.status} ${e.statusText||"errore di rete"}`;let t="_error";return s&&s._vNode&&s._vNode.directives&&s._vNode.directives["@error"]&&(t=s._vNode.directives["@error"]||"_error"),e.text().then((s=>{let i;try{i=JSON.parse(s)}catch(t){i=s||`${e.status} ${e.statusText||"errore di rete"}`}const r={error:i&&i.error?i.error:`${e.status} ${e.statusText}`,details:i&&i.details?i.details:i};throw this.evaluator.state._error=r,window._error=r,"_error"!==t&&(this.evaluator.state[t]=r,window[t]=r),new Error(`${e.status} ${e.statusText}`)}))}return e.json().catch((()=>e.text()))})).then((e=>{const i=this.evaluator.state[t];JSON.stringify(i)===JSON.stringify(e)||(this.evaluator.state[t]=e),this.cacheBySignature.set(v,e),this.readyPromise[a]=Promise.resolve(e),this.fetched[n]&&delete this.fetched[n].error,this.evaluator.state._error=null;let r="_error";return s&&s._vNode&&s._vNode.directives&&s._vNode.directives["@error"]&&(r=s._vNode.directives["@error"]||"_error"),"_error"!==r&&(this.evaluator.state[r]=null),e})).catch((e=>{this.fetched[n]||(this.fetched[n]={}),this.fetched[n].error=e.message;let t="_error";s&&s._vNode&&s._vNode.directives&&s._vNode.directives["@error"]&&(t=s._vNode.directives["@error"]||"_error"),this.evaluator.state._error={error:e&&e.message?e.message:e||"Errore sconosciuto",details:e&&e.stack?e.stack:void 0},"_error"!==t&&(this.evaluator.state[t]=this.evaluator.state._error)})).finally((()=>{this.pendingFetches[a]=!1,this.inflightBySignature.delete(v)}));return this.inflightBySignature.set(v,m),m}}class l{constructor(){this.helpTexts={"@error":'Esempio: <div @fetch="url" @error="myErrorVar"></div> (variabile dove viene salvato l\'errore della fetch, di default _error)',"@when":'Esempio: <span @when="condizione" @do="azione"></span> oppure <span @when="condizione" @go="pagina"></span>',"@do":'Esempio: <span @when="condizione" @do="azione"></span>',"@go":'Esempio: <span @when="condizione" @go="pagina"></span>',"@wait":'Esempio: <span @when="condizione" @wait="1000" @go="pagina"></span>',"@if":'Esempio: <div @if="condizione">Mostra se condizione è true</div>',"@not":'Esempio: <div @not="condizione">Mostra se condizione è false</div>',"@json":'Esempio: <span @json="\'/courses/html-master.json\'" @result="htmlcourse" @then="lessons=htmlcourse.lessons" @finally="step=1"></span> (carica file JSON locale, solo GET)',"@show":'Esempio: <div @show="condizione">Mostra se condizione è true</div>',"@hide":'Esempio: <div @hide="condizione">Nasconde se condizione è true</div>',"@for":'Esempio: <li @for="item in items">{{item}}</li> o <li @for="i, item in items">{{i}}: {{item}}</li>',"@model":'Esempio: <input @model="nome">',"@form":'Esempio: <form @form="nomeForm">...<input @model="campo">...</form> Aggrega tutti i campi @model in state[nomeForm] e calcola la validità globale in _validate[nomeForm] (true/false/null)',"@file":'Esempio: <input type="file" @file="pic"> (salva il file caricato come base64 nella variabile pic)',"@files":'Esempio: <input type="file" multiple @files="gallery"> (salva tutti i file caricati come base64 in un array nella variabile gallery, aggiungendo se già presenti)',"@click":'Esempio: <button @click="state.count++">Aumenta</button>',"@fetch":'Esempio: <div @fetch="\'url\'" @method="\'POST\'" @payload="{foo:1}" @headers="{ Authorization: \'Bearer ...\' }"></div>',"@method":"Esempio: <div @fetch=\"'url'\" @method=\"'POST'\"></div>","@payload":'Esempio: <div @fetch="\'url\'" @method="\'POST\'" @payload="{foo:1}"></div>',"@headers":"Esempio: <div @fetch=\"'url'\" @headers=\"{ Authorization: 'Bearer ...' }\"></div>","@result":'Esempio: <div @fetch="\'url\'" @result="data">Carica</div>',"@watch":'Esempio: <div @watch="user"></div>',"@text":'Esempio: <span @text="nome"></span>',"@attr":'Esempio: <img @attr="{ src: url, alt: titolo }"> (imposta attributi HTML da un oggetto). Supporta anche subdirettive come <b>@attr:src</b>, <b>@attr:alt</b>, ecc.',"@scope":'Esempio: <component @src="comp.html" @scope="course"></component> (isola la variabile \'course\' per ogni istanza del componente, aggiungendo un suffisso numerico incrementale)',"@date":'Esempio: <li @date="data"></li> (formatta una data ISO come "1 agosto 2025, 08:37")',"@dateonly":'Esempio: <li @dateonly="data"></li> (mostra solo giorno, mese e anno)',"@time":'Esempio: <li @time="data"></li> (mostra solo ora e minuti)',"@class":'Esempio: <div @class="{rosso: condizione}"></div>',"@style":"Esempio: <div @style=\"{color:'red'}\"></div>","@validate":'Esempio: <input @validate="required,minLength:3">',"@link":'Esempio: <a @link="pagina">Vai</a>',"@page":'Esempio: <div @page="home">Solo su home</div>',"@component":'Esempio: <component @src="comp.html"></component>',"@set":'Esempio: <button @set:click="foo=1"></button>',"@key":'Esempio: <li @for="item in items" @key="item.id"></li>',"@src":'Esempio: <component @src="comp.html"></component>',"@switch":'Esempio: <div @switch="valore"><div @case="1">Uno</div><div @default>Altro</div></div>',"@case":'Esempio: <div @case="1">Uno</div>',"@default":"Esempio: <div @default>Altro</div>","@source":'Esempio: <div @source="items" @map="item => item*2" @result="doppio"></div>',"@map":'Esempio: <div @source="items" @map="item => item*2"></div>',"@filter":'Esempio: <div @source="items" @filter="item > 0"></div>',"@reduce":'Esempio: <div @source="items" @reduce="(acc, item) => acc+item" @initial="0"></div>',"@initial":'Esempio: <div @source="items" @reduce="(acc, item) => acc+item" @initial="0"></div>',"@animate":'Esempio: <div @animate="fade-in"></div>',"@state":"Esempio: <div @state></div> (renderizza lo stato corrente come JSON)","@log":"Esempio: <div @log></div> (mostra il log delle direttive sull'elemento)","@hover":'Esempio: <div @hover="doSomething()"></div>',no:"Esempio: <no>{{nome}}</no> (mostra contenuto senza interpolazione)","@text:hover":"Esempio: <div @text:hover=\"'Testo hover'\"></div>","@text:click":"Esempio: <div @text:click=\"'Testo click'\"></div>","@text:input":'Esempio: <input @text:input="nome">',"@text:focus":'Esempio: <input @text:focus="nome">',"@class:focus":'Esempio: <input @class:focus="{rosso:true}">',"@class:hover":'Esempio: <div @class:hover="{rosso: condizione}"></div>',"@class:click":'Esempio: <div @class:click="{rosso: condizione}"></div>',"@class:input":'Esempio: <input @class:input="{rosso: condizione}">',"@class:change":'Esempio: <input @class:change="{rosso: condizione}">',"@fetch:click":'Esempio: <button @fetch:click="\'url\'" @result="data"></button>',"@fetch:hover":'Esempio: <button @fetch:hover="\'url\'" @result="data"></button>',"@fetch:input":'Esempio: <input @fetch:input="\'url\'" @result="data">',"@fetch:change":'Esempio: <input @fetch:change="\'url\'" @result="data">',"@model:input":'Esempio: <input @model:input="nome">',"@model:change":'Esempio: <input @model:change="nome">',"@model:focus":'Esempio: <input @model:focus="nome">',"@model:blur":'Esempio: <input @model:blur="nome">',"@set:change":"Esempio: <input @set:change=\"foo='bar'\">","@set:click":'Esempio: <button @set:click="foo=1"></button>',"@set:input":"Esempio: <input @set:input=\"foo='bar'\">","@set:focus":"Esempio: <input @set:focus=\"foo='bar'\">","@set:blur":"Esempio: <input @set:blur=\"foo='bar'\">","@focus":'Esempio: <input @focus="doSomething()">',"@blur":'Esempio: <input @blur="doSomething()">',"@change":'Esempio: <input @change="doSomething()">',"@input":'Esempio: <input @input="doSomething()">',"@prev":'Esempio: <div @prev></div> (mostra valore attuale e precedente dello state)\n<div @prev="foo"></div> (solo per foo)',"@then":'Esegui una o più espressioni dopo tutte le altre direttive su questo nodo. Esempio: <div @then="foo=1;;bar=2"></div>',"@finally":'Esegui una o più espressioni dopo tutto, inclusi @then. Esempio: <div @finally="foo=1;;bar=2"></div>'}}getHelp(e){return this.helpTexts[e]||""}isValidDirective(e){return!!this.helpTexts.hasOwnProperty(e)||!!/^@attr:[a-zA-Z0-9_-]+$/.test(e)}}class c{constructor(e){this.errorBus=e}showAyishaError(e,t,s){if(!e)return;let i=e.parentNode&&e.parentNode.querySelector(".ayisha-error-banner");i?i.innerHTML=`<b>Errore JS:</b> ${t.message}<br><code>${s}</code>`:(i=document.createElement("div"),i.className="ayisha-error-banner",i.style.background="#c00",i.style.color="#fff",i.style.padding="0.5em 1em",i.style.margin="0.5em 0",i.style.borderRadius="4px",i.style.fontWeight="bold",i.style.border="1px solid #900",i.style.position="relative",i.style.zIndex="1000",i.innerHTML=`<b>Errore JS:</b> ${t.message}<br><code>${s}</code>`,e.parentNode&&e.parentNode.insertBefore(i,e.nextSibling)),this.errorBus&&this.errorBus.report(t,{expr:s,el:e})}createErrorElement(e){const t=document.createElement("div");return t.className="ayisha-directive-error",t.style.background="#c00",t.style.color="#fff",t.style.padding="1em",t.style.margin="0.5em 0",t.style.borderRadius="4px",t.style.fontWeight="bold",t.style.border="1px solid #900",t.innerHTML=e,this.errorBus&&this.errorBus.report(new Error(e),{type:"createErrorElement",message:e}),t}createWarningElement(e){const t=document.createElement("div");return t.className="ayisha-directive-warning",t.style.background="#ffeb3b",t.style.color="#333",t.style.padding="1em",t.style.margin="0.5em 0",t.style.borderRadius="4px",t.style.fontWeight="bold",t.style.border="1px solid #e0c200",t.innerHTML=e,t}}class d{constructor(e,t){this.evaluator=e,this.renderCallback=t,this.modelBindings=[]}static setNestedValidate(e,t,s){const i=t.split(".");let r=e;for(let e=0;e<i.length-1;e++)"object"==typeof r[i[e]]&&null!==r[i[e]]||(r[i[e]]={}),r=r[i[e]];r[i[i.length-1]]=s}bindModel(e,t,s){let i=null;function r(e,t,s){if(e.includes(".")){const i=e.split("."),r=i[0];return t&&"object"==typeof t[r]&&null!==t[r]?{root:t[r],path:i.slice(1)}:{root:s,path:i}}return t&&"object"==typeof t[e]&&null!==t[e]?{root:t[e],path:[]}:{root:s,path:[e]}}"number"===e.type?i="number":"checkbox"===e.type&&(i="checkbox");const{root:n,path:a}=r(t,s,this.evaluator.state);let o=n;if(a.length>0){for(let e=0;e<a.length-1;e++)"object"==typeof o[a[e]]&&null!==o[a[e]]||(o[a[e]]={}),o=o[a[e]];const t=a[a.length-1];"number"===e.type?"number"!=typeof o[t]&&(o[t]=0):"checkbox"===e.type?"boolean"!=typeof o[t]&&(o[t]=!1):"string"!=typeof o[t]&&(o[t]="")}else"object"==typeof o&&null!==o||("number"===e.type?"number"!=typeof this.evaluator.state[t]&&(this.evaluator.state[t]=0):"checkbox"===e.type?"boolean"!=typeof this.evaluator.state[t]&&(this.evaluator.state[t]=!1):"string"!=typeof this.evaluator.state[t]&&(this.evaluator.state[t]=""));const l=()=>{const i=this.evaluator.evalExpr(t,s);if("checkbox"===e.type)e.checked=!!i;else if("radio"===e.type)e.checked=i===e.value||!0===i&&"true"===e.value||!1===i&&"false"===e.value;else if("color"===e.type)i&&"string"==typeof i&&i.match(/^#[0-9A-Fa-f]{6}$/)?e.value=i:i&&"string"==typeof i&&i.match(/^[0-9A-Fa-f]{6}$/)?e.value="#"+i:e.value="#000000";else{const t=null==i?"":String(i);e.value!==t&&(e.value=t)}};this.modelBindings.push({el:e,update:l}),l();const c=()=>{let i=null;"number"===e.type?i="number":"checkbox"===e.type&&(i="checkbox");const{root:n,path:a}=r(t,s,this.evaluator.state);let o,l=n;if(o="checkbox"===e.type?e.checked:"radio"===e.type?"true"===e.value||"false"!==e.value&&e.value:"number"===e.type?""===e.value?void 0:Number(e.value):e.value,a.length>0){for(let e=0;e<a.length-1;e++)"object"==typeof l[a[e]]&&null!==l[a[e]]||(l[a[e]]={}),l=l[a[e]];l[a[a.length-1]]=o}else"object"==typeof l&&null!==l||(this.evaluator.state[t]=o);this.renderCallback()};"checkbox"===e.type||"radio"===e.type?e.addEventListener("change",c):e.addEventListener("input",c)}bindValidation(e,t,s=null){const i=[];let r="",n=!1;for(let e=0;e<t.length;e++){const s=t[e];"^"!==s||n?"$"===s&&n?(n=!1,r+=s,i.push(r.trim()),r=""):","!==s||n?r+=s:(r.trim()&&i.push(r.trim()),r=""):(n=!0,r+=s)}for(let e=0;e<i.length;e++)i[e].includes("=")&&(i[e]=i[e].replace("=",":"));if(r.trim()&&i.push(r.trim()),!s)return;this.evaluator.state._validate||(this.evaluator.state._validate={}),d.setNestedValidate(this.evaluator.state._validate,s,null);const a=s.split(".");let o=this.evaluator.state._validate;for(let e=0;e<a.length-1;e++)"object"==typeof o[a[e]]&&null!==o[a[e]]||(o[a[e]]={}),o=o[a[e]];this.evaluator.state._validate.hasOwnProperty(s)&&delete this.evaluator.state._validate[s];const l=()=>{if(""===e.value||null==e.value)return d.setNestedValidate(this.evaluator.state._validate,s,null),e.classList.remove("invalid"),e.classList.remove("valid"),null;let t=!0;for(const s of i)if(/^\^.*\$$/.test(s))try{const i=new RegExp(s);if(!i.test(e.value||"")){t=!1;break}}catch(e){t=!1;break}else if("required"===s){if(!e.value||!e.value.trim()){t=!1;break}}else if(s.startsWith("minLength:")||s.startsWith("minLength=")){const i=parseInt(s.split(/:|=/)[1],10);if(e.value.length<i){t=!1;break}}else if(s.startsWith("maxLength:")||s.startsWith("maxLength=")){const i=parseInt(s.split(/:|=/)[1],10);if(e.value.length>i){t=!1;break}}else if(s.startsWith("min:")){const i=parseFloat(s.split(":")[1]),r=parseFloat(e.value);if(isNaN(r)||r<i){t=!1;break}}else if(s.startsWith("max:")){const i=parseFloat(s.split(":")[1]),r=parseFloat(e.value);if(isNaN(r)||r>i){t=!1;break}}else if("email"===s){if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(e.value||"")){t=!1;break}}else if("phone"===s){if(!/^\+\d{1,3}\s?\d{3,4}\s?\d{3,4}\s?\d{3,4}$/.test(e.value||"")){t=!1;break}}else if("password"===s){if(!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(e.value||"")){t=!1;break}}else if(s.startsWith("regex:")){let i=s.slice(6);try{if(!new RegExp(i).test(e.value||"")){t=!1;break}}catch(e){t=!1;break}}return d.setNestedValidate(this.evaluator.state._validate,s,t),e.classList.toggle("invalid",!t),e.classList.toggle("valid",t&&e.value.length>0),t};l(),e.addEventListener("input",(()=>{l(),this.renderCallback()})),e.addEventListener("blur",l)}updateBindings(){this.modelBindings.forEach((e=>e.update()))}clearBindings(){this.modelBindings=[]}}class h{constructor(e,t,s){this.evaluator=e,this.bindingManager=t,this.errorHandler=s}apply(e,t,s,i,r=null){}handleSubDirective(e,t,s,i,r,n,a=null){return!1}executeExpression(e,t,s=null,i=!0){return this.evaluator.executeDirectiveExpression(e,t,s,i)}evalExpr(e,t){return this.evaluator.evalExpr(e,t)}showError(e,t,s){this.errorHandler.showAyishaError(e,t,s)}}class u extends h{apply(e,t,s,i,r=null){if(!e.directives||!e.directives["@scope"])return void(r&&r.addTask((()=>Promise.resolve())));const n=e.directives["@scope"].trim();if(!e._scopeKey){const t=e.parent?e.parent.children.indexOf(e):0;e._scopeKey=n+"_"+String(t+1).padStart(3,"0")}!function e(t,s,i){t.scopedVars&&void 0!==t.scopedVars[s]&&(t.scopedVars[i]=t.scopedVars[s],delete t.scopedVars[s]),t.children&&t.children.forEach((t=>e(t,s,i)))}(e,n,e._scopeKey),void 0===s[e._scopeKey]&&e.scopedVars&&void 0!==e.scopedVars[e._scopeKey]&&(s[e._scopeKey]=e.scopedVars[e._scopeKey]),delete e.directives["@scope"],r&&r.addTask((()=>Promise.resolve()))}}class p extends h{apply(e,t,s,i,r=null){const n=e.directives["@form"];if(!n)return;const a=[],o=[];if(function e(t){t.directives&&t.directives["@model"]&&(a.push(t.directives["@model"]),t.directives["@validate"]&&o.push(t.directives["@model"])),t.children&&Array.isArray(t.children)&&t.children.forEach(e)}(e),s[n]||(s[n]={}),a.forEach((e=>{try{s[n][e]=this.evaluator.evalExpr(e,t)}catch(t){s[n][e]=void 0}})),s._validate||(s._validate={}),s._validate[n]||(s._validate[n]=null),0===o.length)s._validate[n]=null;else{let e=!0;for(const t of o){if(!1===s._validate[t]){e=!1;break}null==s._validate[t]&&(e=null)}s._validate[n]=e}r&&r.addTask((()=>Promise.resolve()))}}class v extends h{apply(e,t,s,i,r=null){let n=this.evaluator.evalExpr(e.directives["@date"],t),a=this.formatDate(n);i.innerText=a,r&&r.markSyncDone()}formatDate(e){if(!e)return"";let t;if("string"==typeof e)t=new Date(e);else{if(!(e instanceof Date))return String(e);t=e}if(isNaN(t.getTime()))return String(e);return t.toLocaleString(navigator.language||navigator.userLanguage||"it-IT",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}}class f extends h{apply(e,t,s,i,r=null){let n=this.evaluator.evalExpr(e.directives["@dateonly"],t),a=this.formatDateOnly(n);i.innerText=a,r&&r.markSyncDone()}formatDateOnly(e){if(!e)return"";let t;if("string"==typeof e)t=new Date(e);else{if(!(e instanceof Date))return String(e);t=e}return isNaN(t.getTime())?String(e):t.toLocaleDateString(navigator.language||navigator.userLanguage||"it-IT")}}class g extends h{apply(e,t,s,i,r=null){let n=this.evaluator.evalExpr(e.directives["@time"],t),a=this.formatTime(n);i.innerText=a,r&&r.markSyncDone()}formatTime(e){if(!e)return"";let t;if("string"==typeof e)t=new Date(e);else{if(!(e instanceof Date))return String(e);t=e}return isNaN(t.getTime())?String(e):t.toLocaleTimeString(navigator.language||navigator.userLanguage||"it-IT",{hour:"2-digit",minute:"2-digit"})}}class m extends h{apply(e,t,s,i,r=null){const n=e.directives["@if"];let a=!1;try{a=this.evaluator.evalExpr(n,t)}catch{}i&&(i.style.display=a?"":"none"),r&&r.addTask((()=>Promise.resolve()))}}class y extends h{apply(e,t,s,i,r=null){const n=e.directives["@not"];let a=!1;try{a=!this.evaluator.evalExpr(n,t)}catch{}i&&(i.style.display=a?"":"none"),r&&r.addTask((()=>Promise.resolve()))}}class b{constructor(e){this.evaluator=e,this.pendingJsons={},this.lastJsonUrl={},this.fetched={},this.readyPromise={},this.cacheByUrl=new Map,this.inflightByUrl=new Map,this.errorInfoByUrl=new Map,this.errorCooldownMs=3e3}setupJson(e,t,s,i,r){let n=this.evaluator.evalExpr(e,s,i);if(void 0===n){let t=!1;if(n=e.replace(/\{([^}]+)\}/g,((e,r)=>{const n=this.evaluator.evalExpr(r,s,i);return null==n||"string"==typeof n&&""===n.trim()?(t=!0,""):String(n)})),t)return null}if(null==n&&(n=e),(e=>{if(null==e)return!0;const t=String(e).trim();return!t||(!!/\{[^}]+\}/.test(t)||(!!/(^|\/)(undefined|null)(\/|$)/i.test(t)||!!/\/\.(?:[a-z0-9]+)?(\?|$|#)/i.test(t)))})(n))return null;if(!n)return null;if(/^https?:\/\//.test(n))return Promise.reject(new Error("@json accetta solo file locali"));n.startsWith("/")||(n="/"+n.replace(/^\.\//,"")),n=location.origin+n;const a=`${n}::${t}`;if(!r&&!i&&this.errorInfoByUrl.has(n)){const e=this.errorInfoByUrl.get(n);if(Date.now()-e.ts<this.errorCooldownMs)return null;this.errorInfoByUrl.delete(n)}if(!r&&!i&&this.fetched[n]?.error)return null;if(!r&&!i&&this.inflightByUrl.has(n)){const e=this.inflightByUrl.get(n);return this.readyPromise[a]=e,e}if(!r&&!i&&this.cacheByUrl.has(n)){const e=this.cacheByUrl.get(n);return this.evaluator.state[t]!==e&&(this.evaluator.state[t]=e),Promise.resolve(e)}if(this.pendingJsons[a]){return this.readyPromise[a]||Promise.resolve(this.evaluator.state[t])}t&&"string"==typeof t&&t in this.evaluator.state&&(this.evaluator.state[t]=null),this.readyPromise[a]&&delete this.readyPromise[a],this.pendingJsons[a]=!0,this.lastJsonUrl[a]={url:n,value:this.evaluator.state[t]},this.pendingJsons[a]=!0,this.lastJsonUrl[t]=n,t in this.evaluator.state||(this.evaluator.state[t]=null);const o=fetch(n,{method:"GET"}).then((e=>{if(!e.ok){this.fetched[n]||(this.fetched[n]={}),this.fetched[n].error=`${e.status} ${e.statusText||"errore di rete"}`;let t="_error";return s&&s._vNode&&s._vNode.directives&&s._vNode.directives["@error"]&&(t=s._vNode.directives["@error"]||"_error"),e.text().then((s=>{let i;try{i=JSON.parse(s)}catch(t){i=s||`${e.status} ${e.statusText||"errore di rete"}`}const r={error:i&&i.error?i.error:`${e.status} ${e.statusText}`,details:i&&i.details?i.details:i};throw this.evaluator.state._error=r,window._error=r,"_error"!==t&&(this.evaluator.state[t]=r,window[t]=r),new Error(`${e.status} ${e.statusText}`)}))}return e.json().catch((()=>e.text()))})).then((e=>{const i=this.evaluator.state[t];JSON.stringify(i)===JSON.stringify(e)||(this.evaluator.state[t]=e),this.cacheByUrl.set(n,e),this.readyPromise[a]=Promise.resolve(e),this.fetched[n]&&delete this.fetched[n].error,this.evaluator.state._error=null;let r="_error";return s&&s._vNode&&s._vNode.directives&&s._vNode.directives["@error"]&&(r=s._vNode.directives["@error"]||"_error"),"_error"!==r&&(this.evaluator.state[r]=null),this.errorInfoByUrl.delete(n),e})).catch((e=>{this.fetched[n]||(this.fetched[n]={}),this.fetched[n].error=e.message;let t="_error";s&&s._vNode&&s._vNode.directives&&s._vNode.directives["@error"]&&(t=s._vNode.directives["@error"]||"_error"),this.errorInfoByUrl.set(n,{ts:Date.now(),error:e&&e.message?e.message:String(e)});const i={error:e&&e.message?e.message:e||"Errore sconosciuto",details:e&&e.stack?e.stack:void 0},r=this.evaluator.state._error;return JSON.stringify(r)!==JSON.stringify(i)&&(this.evaluator.state._error=i),"_error"!==t&&(this.evaluator.state[t]=this.evaluator.state._error),null})).finally((()=>{this.pendingJsons[a]=!1,this.inflightByUrl.delete(n)}));return this.inflightByUrl.set(n,o),o}}class w extends h{constructor(e,t,s,i){super(e,t,s),this.jsonManager=i}apply(e,t,s,i,r=null){const n=e.directives["@json"];if(!n)return;if(e.subDirectives?.["@json"]||e.directives["@when"])return;const a=this.evaluator.autoVarExpr(n),o=e.directives["@result"]||"result",l=Object.assign({},t,{_vNode:e});let c=this.evaluator.evalExpr(a,l);if(void 0===c&&(c=a),"string"==typeof c){c=c.trim();const e=c[0],t=c[c.length-1];!e||e!==t||"`"!==e&&'"'!==e&&"'"!==e||(c=c.slice(1,-1).trim())}/^https?:\/\//.test(c)||(c.startsWith("/")||(c="/"+c.replace(/^\.\//,"")),c=location.origin+c);const d=this.jsonManager.cacheByUrl.has(c),h=this.jsonManager.setupJson(a,o,l);r&&h&&"function"==typeof h.then&&!d&&r.addTask(h.then((e=>(l._eventResult=e,e)))),e.directives["@watch"]&&this.handleWatchDirective(e,a,o)}handleSubDirective(e,t,s,i,r,n,a=null){const o="hover"===r?"mouseover":r,l=a?a.addAsyncTask():null;return i.addEventListener(o,(s=>{const r=e.directives["@result"]||"result",a=Object.assign({},t,{_vNode:e});try{let e=this.evaluator.evalExpr(n,a);void 0===e&&(e=n);const t=this.jsonManager.setupJson(e,r,a,s,!0);t&&"function"==typeof t.then?t.then((e=>{a._eventResult=e})).finally((()=>{l&&l()})):l&&l()}catch(e){this.showError(i,e,n),l&&l()}})),!0}handleWatchDirective(e,t,s){e.directives["@watch"].split(",").forEach((e=>{const i=(e=e.trim()).match(/^([\w$]+)\s*=>\s*(.+)$/)||e.match(/^([\w$]+)\s*:\s*(.+)$/);if(i){const e=i[1],t=i[2];this.evaluator.ensureVarInState(t),window.ayisha.addWatcher(e,(e=>{try{this.executeExpression(t,{},{newVal:e},!0)}catch(e){}}),{oneShot:!0})}else window.ayisha.addWatcher(e,(()=>{const e=this.jsonManager.setupJson(t,s,void 0,void 0,!0);e&&"function"==typeof e.then&&e.catch((()=>{}))}),{oneShot:!0})}))}}class x extends h{apply(e,t,s,i,r=null){let n=e.directives["@for"].match(/(\w+),\s*(\w+) in (.+)/);if(n){const[,i,a,o]=n;let l=this.evaluator.evalExpr(o,t)||[];"object"!=typeof l||Array.isArray(l)||(l=Object.values(l));const c=document.createDocumentFragment();return l.forEach(((n,l)=>{const d=JSON.parse(JSON.stringify(e));delete d.directives["@for"];const h={...t,[a]:n,[i]:l,[`${a}_index`]:l,[`${a}_ref`]:`${o.split(".")[0]}[${l}]`},u=s._ayishaInstance._renderVNode(d,h);u&&(s._ayishaInstance.directiveManager.applyDirectives(d,h,s,u,r),c.appendChild(u))})),r&&r.addTask((()=>Promise.resolve())),c}if(n=e.directives["@for"].match(/(\w+) in (.+)/),n){const[,i,a]=n;let o=this.evaluator.evalExpr(a,t)||[];"object"!=typeof o||Array.isArray(o)||(o=Object.values(o));const l=a.split(".")[0],c=a.includes(".filter"),d=document.createDocumentFragment();return o.forEach(((n,a)=>{const o=JSON.parse(JSON.stringify(e));delete o.directives["@for"];let h=a;c&&s[l]&&(h=s[l].findIndex((e=>e.id===n.id||JSON.stringify(e)===JSON.stringify(n))));const u={...t,[i]:n,$index:a,$originalIndex:h,$arrayName:l},p=s._ayishaInstance._renderVNode(o,u);p&&(s._ayishaInstance.directiveManager.applyDirectives(o,u,s,p,r),d.appendChild(p))})),r&&r.addTask((()=>Promise.resolve())),d}return null}}class _ extends h{apply(e,t,s,i,r=null){const n=e.directives["@model"];n&&(this.bindingManager.bindModel(i,n,t),r&&r.addTask((()=>Promise.resolve())))}handleSubDirective(e,t,s,i,r,n,a=null){if(["input","change","focus","blur"].includes(r)){if(this.bindingManager.bindModel(i,n,t),a){const e=a.addAsyncTask();i.addEventListener(r,(()=>{e&&e()}))}return!0}return!1}}class E{static setNested(e,t,s){const i=t.split(".");let r=e;for(let e=0;e<i.length-1;e++){const t=i[e].match(/(\w+)\[(\d+)\]/);if(t){const e=t[1],s=parseInt(t[2],10);Array.isArray(r[e])||(r[e]=[]),r[e][s]||(r[e][s]={}),r=r[e][s]}else"object"==typeof r[i[e]]&&null!==r[i[e]]||(r[i[e]]={}),r=r[i[e]]}const n=i[i.length-1],a=n.match(/(\w+)\[(\d+)\]/);if(a){const e=a[1],t=parseInt(a[2],10);Array.isArray(r[e])||(r[e]=[]),r[e][t]=s}else r[n]=s}static getNested(e,t){const s=t.split(".");let i=e;for(let e=0;e<s.length;e++){const t=s[e].match(/(\w+)\[(\d+)\]/);if(t){const e=t[1],s=parseInt(t[2],10);if(!Array.isArray(i[e]))return;i=i[e][s]}else{if("object"!=typeof i||null===i)return;i=i[s[e]]}}return i}}class $ extends h{apply(e,t,s,i,r=null){const n=e.directives["@file"];n&&"INPUT"===i.tagName&&"file"===i.type&&i.addEventListener("change",(e=>{const t=i.files&&i.files[0];if(!t)return E.setNested(s,n,null),void(r&&r.addTask((()=>Promise.resolve())));const a=new FileReader;a.onload=function(e){E.setNested(s,n,e.target.result),r&&r.addTask((()=>Promise.resolve()))},a.readAsDataURL(t)}))}handleSubDirective(){return!1}}class S extends h{apply(e,t,s,i,r=null){const n=e.directives["@files"];n&&"INPUT"===i.tagName&&"file"===i.type&&i.addEventListener("change",(e=>{const t=i.files;if(!t||0===t.length)return E.setNested(s,n,[]),void(r&&r.addTask((()=>Promise.resolve())));let a=0;const o=[];for(let e=0;e<t.length;e++){const i=new FileReader;i.onload=function(i){if(o[e]=i.target.result,a++,a===t.length){n.split(".").pop().match(/\[(\d+)\]$/)?E.setNested(s,n,o[0]||null):E.setNested(s,n,o),r&&r.addTask((()=>Promise.resolve()))}},i.readAsDataURL(t[e])}}))}handleSubDirective(){return!1}}class k extends h{apply(e,t,s,i,r=null){const n=e.directives["@hide"];let a=!1;try{a=this.evaluator.evalExpr(n,t)}catch{}i&&(i.style.display=a?"none":""),r&&r.addTask((()=>Promise.resolve()))}}class T extends h{apply(e,t,s,i,r=null){const n=e.directives["@text"];if(n&&!e.subDirectives?.["@text"])try{if(this.evaluator.hasMultipleAssignments(n))this.executeExpression(n,t,null,!1);else{const e=this.evalExpr(n,t);i.textContent=this.formatTextValue(e)}r&&r.addTask((()=>Promise.resolve()))}catch(e){i.textContent=`[Error: ${e.message}]`}}formatTextValue(e){return void 0===e?"":null===e?"null":String(e)}handleSubDirective(e,t,s,i,r,n,a=null){switch(i._ayishaOriginalText||(e.children&&e.children.length>0?i._ayishaOriginalText=e.children.filter((e=>"text"===e.type)).map((e=>e.text)).join(""):i._ayishaOriginalText=i.textContent||i.innerText||""),r){case"click":const e=a?a.addAsyncTask():null;return i.addEventListener("click",(s=>{const r=this.evalExpr(n,t,s);i.textContent=this.formatTextValue(r),e&&e()})),!0;case"hover":return i.addEventListener("mouseover",(e=>{const s=this.evalExpr(n,t,e);i.textContent=this.formatTextValue(s)})),i.addEventListener("mouseout",(()=>{i.textContent=i._ayishaOriginalText})),!0;case"input":case"focus":case"blur":const s=a?a.addAsyncTask():null;return i.addEventListener(r,(e=>{const r=this.evalExpr(n,t,e);i.textContent=this.formatTextValue(r),s&&s()})),!0;default:return!1}}}class A extends h{apply(e,t,s,i,r=null){const n=e.directives["@class"];if(!n||e.subDirectives?.["@class"])return;let a={};try{const e="string"==typeof n?n.trim():n;let s=this.evalExpr(n,t);if(null==s&&"string"==typeof e&&e.startsWith("{")&&e.endsWith("}"))try{s=this.evaluator.evalExpr(`(${e})`,t)}catch{}if("string"==typeof s){let e=s.trim();(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))&&(e=e.slice(1,-1)),e.startsWith("{")&&e.endsWith("}")?(e=e.slice(1,-1),e.split(",").forEach((e=>{let[s,i]=e.split(":");if(s&&void 0!==i){s=s.trim().replace(/^['"]|['"]$/g,"");try{i=this.evaluator.evalExpr(i.trim(),t)}catch{i=!!i.trim()}a[s]=!!i}}))):a={[e]:!0}}else"object"==typeof s&&null!==s&&(a=s)}catch(e){a={}}Object.keys(a).forEach((e=>{i.classList.remove(e)})),Object.entries(a).forEach((([e,t])=>{i.classList.toggle(e,!!t)})),i.setAttribute("class",i.className),r&&r.addTask((()=>Promise.resolve()))}handleSubDirective(e,t,s,i,r,n,a=null){const o=()=>{try{return this.evalExpr(n,t)||{}}catch(e){return{}}};switch(r){case"hover":return i.addEventListener("mouseover",(()=>{const e=o();Object.entries(e).forEach((([e,t])=>{t&&i.classList.add(e)}))})),i.addEventListener("mouseout",(()=>{const e=o();Object.entries(e).forEach((([e,t])=>{t&&i.classList.remove(e)}))})),!0;case"focus":return i.addEventListener("focus",(()=>{const e=o();Object.entries(e).forEach((([e,t])=>{t&&i.classList.add(e)}))})),i.addEventListener("blur",(()=>{const e=o();Object.entries(e).forEach((([e,t])=>{t&&i.classList.remove(e)}))})),!0;case"click":const e=a?a.addAsyncTask():null;return i.addEventListener("click",(()=>{const t=o();Object.entries(t).forEach((([e,t])=>{t&&i.classList.toggle(e)})),e&&e()})),!0;case"input":const t=a?a.addAsyncTask():null;return i.addEventListener("input",(()=>{const e=o();Object.entries(e).forEach((([e,t])=>{t&&i.classList.add(e)})),t&&t()})),i.addEventListener("blur",(()=>{const e=o();Object.entries(e).forEach((([e,t])=>{t&&i.classList.remove(e)}))})),!0;default:return!1}}}class N extends h{apply(e,t,s,i,r=null){const n=e.directives["@style"];if(n)try{const e=this.evalExpr(n,t)||{};"object"!=typeof e||null===e||Array.isArray(e)||Object.entries(e).forEach((([e,t])=>{"string"==typeof e&&e.trim()&&(i.style[e]=t)})),r&&r.addTask((()=>Promise.resolve()))}catch(e){}}}class C extends h{apply(e,t,s,i,r=null){const n=e.directives["@click"];if(!n)return;!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n.trim())||n.includes("=")||n.includes("<")||n.includes(">")||n.includes("!")||n.includes("&")||n.includes("|")||n.includes("'")||n.includes('"')||n.includes("(")||n.includes(")")||this.evaluator.ensureVarInState(n);const a=r?r.addAsyncTask():null;i.addEventListener("click",(e=>{this.handleClick(e,n,t,s,i),a&&a()}))}handleClick(e,t,s,i,r){"BUTTON"===r.tagName&&e.preventDefault();try{let r=t;this.evaluator.hasInterpolation(t)&&(r=this.evaluator.evalAttrValue(t,s));const n=r.replace(/\bstate\./g,"");if(this.handleSpecialClickPatterns(n,s,i))return;const a=n.match(/^\s*([a-zA-Z_$][\w$]*)\s*=\s*!\s*\1\s*$/);if(a){const e=a[1],t=i[e];return i[e]=!Boolean(t),void(window.ayisha?._isRendering||window.ayisha?._componentRenderQueued||(clearTimeout(window.ayisha?._componentRenderTimeout),window.ayisha._componentRenderQueued=!0,window.ayisha._componentRenderTimeout=setTimeout((()=>{window.ayisha._componentRenderQueued=!1,window.ayisha.render()}),0)))}this.executeExpression(n,s,e);const o=/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*([^;,]+)/g;let l;for(;null!==(l=o.exec(n));){const e=l[1].trim();let t;if(void 0!==s[e])t=s[e];else try{t=this.evaluator.evalExpr(l[2].trim(),s)}catch{t=l[2].trim()}i[e]=t}window.ayisha?._isRendering||window.ayisha?._componentRenderQueued||(clearTimeout(window.ayisha?._componentRenderTimeout),window.ayisha._componentRenderQueued=!0,window.ayisha._componentRenderTimeout=setTimeout((()=>{window.ayisha._componentRenderQueued=!1,window.ayisha.render()}),0));const c=/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*([^;]+)/g;let d;for(;null!==(d=c.exec(n));){const e=d[1].trim();e in i&&void 0!==s[e]&&s[e]!==i[e]&&(i[e]=s[e],window.ayisha?._isRendering||window.ayisha?._componentRenderQueued||(clearTimeout(window.ayisha?._componentRenderTimeout),window.ayisha._componentRenderQueued=!0,window.ayisha._componentRenderTimeout=setTimeout((()=>{window.ayisha._componentRenderQueued=!1,window.ayisha.render()}),0)))}}catch(e){this.showError(r,e,t)}}handleSpecialClickPatterns(e,t,s){const i=e.match(/^(\w+)\.(\w+)(\+\+|--|=.+)$/);if(i)return this.handleContextObjectOperation(i,t,s);const r=e.match(/^(\w+)\s*=\s*(\w+)\.filter\((.+)\)$/);if(r)return this.handleFilterOperation(r,t,s);const n=e.match(/^(\w+)\+\+$/);if(n)return this.handleIncrement(n[1],s);const a=e.match(/^(\w+)--$/);if(a)return this.handleDecrement(a[1],s);const o=e.match(/^(\w+)\s*([+\-*\/])=\s*(.+)$/);return!!o&&this.handleArithmetic(o,t,s)}handleContextObjectOperation([,e,t,s],i,r){if(!i||!i[e])return!1;const n=i[e];if(n&&"object"==typeof n&&n.id)return this.updateObjectInState(n,t,s,i,r);if("++"===s)n[t]=(n[t]||0)+1;else if("--"===s)n[t]=(n[t]||0)-1;else if(s.startsWith("=")){const e=s.substring(1).trim();n[t]=this.evalExpr(e,i)}return setTimeout((()=>window.ayisha?.render()),0),!0}updateObjectInState(e,t,s,i,r){for(const[n,a]of Object.entries(r))if(Array.isArray(a)){const o=a.findIndex((t=>t&&"object"==typeof t&&t.id===e.id));if(-1!==o){if("++"===s)r[n][o][t]=(r[n][o][t]||0)+1;else if("--"===s)r[n][o][t]=(r[n][o][t]||0)-1;else if(s.startsWith("=")){const e=s.substring(1).trim();r[n][o][t]=this.evalExpr(e,i)}return setTimeout((()=>window.ayisha?.render()),0),!0}}return!1}handleFilterOperation([,e,t,s],i,r){if(s.includes("!==")&&e===t){const t=s.match(/!==\s*(\w+)\.id/);let n=null;if(t)n=i[t[1]];else for(const[e,t]of Object.entries(i))if(t&&"object"==typeof t&&t.id&&"users"!==e){n=t;break}if(n?.id)return r[e]=r[e].filter((e=>e.id!==n.id)),setTimeout((()=>window.ayisha?.render()),0),!0}return!1}handleIncrement(e,t){return e in t||(t[e]=0),t[e]=(Number(t[e])||0)+1,setTimeout((()=>window.ayisha?.render()),0),!0}handleDecrement(e,t){return t[e]=(Number(t[e])||0)-1,setTimeout((()=>window.ayisha?.render()),0),!0}handleArithmetic([,e,t,s],i,r){let n=Number(r[e])||0,a=Number(this.evalExpr(s,i))||0;switch(t){case"+":r[e]=n+a;break;case"-":r[e]=n-a;break;case"*":r[e]=n*a;break;case"/":r[e]=0!==a?n/a:n;break}return setTimeout((()=>window.ayisha?.render()),0),!0}handleSubDirective(e,t,s,i,r,n,a=null){if("click"===r){const e=a?a.addAsyncTask():null;return i.addEventListener("click",(r=>{this.handleClick(r,n,t,s,i),e&&e()})),!0}return!1}}class D extends h{constructor(e,t,s,i){super(e,t,s),this.fetchManager=i}apply(e,t,s,i,r=null){const n=e.directives["@fetch"];if(!n)return;if(e.subDirectives?.["@fetch"]||e.directives["@when"])return;const a=this.evaluator.autoVarExpr(n),o=e.directives["@result"]||"result",l=Object.assign({},t,{_vNode:e}),c=this.fetchManager.setupFetch(a,o,l);r&&c&&"function"==typeof c.then&&r.addTask(c.then((e=>(l._eventResult=e,e)))),e.directives["@watch"]&&this.handleWatchDirective(e,a,o)}handleSubDirective(e,t,s,i,r,n,a=null){const o="hover"===r?"mouseover":r,l=a?a.addAsyncTask():null;return i.addEventListener(o,(s=>{const r=e.directives["@result"]||"result",a=Object.assign({},t,{_vNode:e});try{let e=this.evaluator.evalExpr(n,a);void 0===e&&(e=n);const t=this.fetchManager.setupFetch(e,r,a,s,!0);t?t.then((e=>{a._eventResult=e})).finally((()=>{l&&l()})):l&&l()}catch(e){this.showError(i,e,n),l&&l()}})),!0}handleWatchDirective(e,t,s){e.directives["@watch"].split(",").forEach((e=>{const i=(e=e.trim()).match(/^([\w$]+)\s*=>\s*(.+)$/)||e.match(/^([\w$]+)\s*:\s*(.+)$/);if(i){const e=i[1],t=i[2];this.evaluator.ensureVarInState(t),window.ayisha.addWatcher(e,(e=>{try{this.executeExpression(t,{},{newVal:e},!0)}catch(e){}}),{oneShot:!0})}else window.ayisha.addWatcher(e,(()=>{this.fetchManager.setupFetch(t,s,void 0,void 0,!0)}),{oneShot:!0})}))}}class M extends h{apply(e,t,s,i,r=null){const n=e.directives["@validate"],a=e.directives["@model"];i&&n&&a&&this.bindingManager.bindValidation(i,n,a),r&&r.addTask((()=>Promise.resolve()))}}class O extends h{apply(e,t,s,i,r=null){if(i){const r=document.createElement("div");r.style.backgroundColor="rgba(0, 0, 0, 0.8)",r.style.color="#fff",r.style.padding="1em",r.style.borderRadius="4px",r.style.marginTop="1em",r.style.overflow="auto";let n,a=s,o="CURRENT & PREVIOUS VALUE";const l=e.directives["@prev"];window.ayisha&&window.ayisha._reactivity&&window.ayisha._reactivity;if("string"==typeof l&&l.trim())try{a=this.evaluator.evalExpr(l,t),o=`PREV: ${l}`,n=s._prevValues&&l in s._prevValues?s._prevValues[l]:void 0}catch(e){a={error:"Invalid expression",details:e.message},o=`PREV: ${l}`}else if(s._prevValues){n={};for(const e in s)Object.prototype.hasOwnProperty.call(s,e)&&(n[e]=s._prevValues[e])}function c(e){if(void 0===e)return"undefined";if(null===e)return"null";try{const t=new WeakSet;return JSON.stringify(e,(function(e,s){if("object"==typeof s&&null!==s){if(t.has(s))return"[Circular]";t.add(s)}return void 0===s?"undefined":"function"==typeof s?"[Function]":"_ayishaInstance"!==e?s:void 0}),2)}catch(t){try{return String(e)}catch{return"[Unserializable]"}}}const d=document.createElement("h3");d.textContent=o,d.style.margin="0.5em 0 2em",d.style.fontSize="1.1em",d.style.fontWeight="bold",d.style.color="#fff",r.appendChild(d);const h=document.createElement("pre");h.style.margin="0",h.style.whiteSpace="pre-wrap",h.style.fontFamily="monospace";try{h.textContent="Current Value:\n"+c(a)+"\n\nPrevious Value:\n"+c(n)}catch(e){h.textContent="Error displaying previous value: "+e.message}r.appendChild(h),i.appendChild(r)}r&&r.addTask((()=>Promise.resolve()))}}class L extends h{apply(e,t,s,i,r=null){if(i){const r=document.createElement("div");r.style.backgroundColor="rgba(0, 0, 0, 0.8)",r.style.color="#fff",r.style.padding="1em",r.style.borderRadius="4px",r.style.marginTop="1em",r.style.overflow="auto";let n=s,a="CURRENT STATE";const o=e.directives["@state"];if("string"==typeof o&&o.trim())try{n=this.evaluator.evalExpr(o,t),a=`STATE: ${o}`}catch(e){n={error:"Invalid expression",details:e.message},a=`STATE: ${o}`}function l(e){const t=new WeakSet;return JSON.parse(JSON.stringify(e,(function(e,s){if("object"==typeof s&&null!==s){if(t.has(s))return;t.add(s)}if("_ayishaInstance"!==e)return s})))}void 0===n&&(n=null);const c=document.createElement("h3");c.textContent=a,c.style.margin="0.5em 0 2em",c.style.fontSize="1.1em",c.style.fontWeight="bold",c.style.color="#fff",r.appendChild(c);const d=document.createElement("pre");d.style.margin="0",d.style.whiteSpace="pre-wrap",d.style.fontFamily="monospace";try{d.textContent=JSON.stringify(l(n),null,2)}catch(e){d.textContent="[Non serializzabile]"}r.appendChild(d),i.appendChild(r)}r&&r.addTask((()=>Promise.resolve()))}}class z extends h{apply(e,t,s,i,r=null){i&&(i.textContent="Log: "+JSON.stringify(e.directives,null,2)),r&&r.addTask((()=>Promise.resolve()))}}class j extends h{apply(e,t,s,i,r=null){const n=e.directives["@attr"];let a={};try{a=this.evaluator.evalExpr(n,t)}catch{}i&&"object"==typeof a&&Object.entries(a).forEach((([e,t])=>{i.setAttribute(e,t)})),r&&r.addTask((()=>Promise.resolve()))}handleSubDirective(e,t,s,i,r,n,a=null){const o=r;try{const e=this.evalExpr(n,t);i&&(null==e?i.removeAttribute(o):i.setAttribute(o,e))}catch(e){this.showError(i,e,n)}return a&&a.addTask((()=>Promise.resolve())),!0}}class V extends h{apply(e,t,s,i,r=null){const n=e.directives["@focus"];if(!n)return;!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n.trim())||n.includes("=")||n.includes("<")||n.includes(">")||n.includes("!")||n.includes("&")||n.includes("|")||n.includes("'")||n.includes('"')||n.includes("(")||n.includes(")")||this.evaluator.ensureVarInState(n);const a=r?r.addAsyncTask():null;i.addEventListener("focus",(e=>{try{this.executeExpression(n,t,e,!0),a&&a()}catch(e){this.showError(i,e,n),a&&a()}}))}handleSubDirective(e,t,s,i,r,n,a=null){if("focus"===r){!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n.trim())||n.includes("=")||n.includes("<")||n.includes(">")||n.includes("!")||n.includes("&")||n.includes("|")||n.includes("'")||n.includes('"')||n.includes("(")||n.includes(")")||this.evaluator.ensureVarInState(n);const e=a?a.addAsyncTask():null;return i.addEventListener("focus",(s=>{try{this.executeExpression(n,t,s,!0),e&&e()}catch(t){this.showError(i,t,n),e&&e()}})),!0}return!1}}class P extends h{apply(e,t,s,i,r=null){const n=e.directives["@blur"];if(!n)return;!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n.trim())||n.includes("=")||n.includes("<")||n.includes(">")||n.includes("!")||n.includes("&")||n.includes("|")||n.includes("'")||n.includes('"')||n.includes("(")||n.includes(")")||this.evaluator.ensureVarInState(n);const a=r?r.addAsyncTask():null;i.addEventListener("blur",(e=>{try{this.executeExpression(n,t,e,!0),a&&a()}catch(e){this.showError(i,e,n),a&&a()}}))}handleSubDirective(e,t,s,i,r,n,a=null){if("blur"===r){!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n.trim())||n.includes("=")||n.includes("<")||n.includes(">")||n.includes("!")||n.includes("&")||n.includes("|")||n.includes("'")||n.includes('"')||n.includes("(")||n.includes(")")||this.evaluator.ensureVarInState(n);const e=a?a.addAsyncTask():null;return i.addEventListener("blur",(s=>{try{this.executeExpression(n,t,s,!0),e&&e()}catch(t){this.showError(i,t,n),e&&e()}})),!0}return!1}}class R extends h{apply(e,t,s,i,r=null){const n=e.directives["@change"];if(!n)return;!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n.trim())||n.includes("=")||n.includes("<")||n.includes(">")||n.includes("!")||n.includes("&")||n.includes("|")||n.includes("'")||n.includes('"')||n.includes("(")||n.includes(")")||this.evaluator.ensureVarInState(n);const a=r?r.addAsyncTask():null;i.addEventListener("change",(e=>{try{this.executeExpression(n,t,e,!0),a&&a()}catch(e){this.showError(i,e,n),a&&a()}}))}handleSubDirective(e,t,s,i,r,n,a=null){if("change"===r){!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n.trim())||n.includes("=")||n.includes("<")||n.includes(">")||n.includes("!")||n.includes("&")||n.includes("|")||n.includes("'")||n.includes('"')||n.includes("(")||n.includes(")")||this.evaluator.ensureVarInState(n);const e=a?a.addAsyncTask():null;return i.addEventListener("change",(s=>{try{this.executeExpression(n,t,s,!0),e&&e()}catch(t){this.showError(i,t,n),e&&e()}})),!0}return!1}}class I extends h{apply(e,t,s,i,r=null){const n=e.directives["@input"];if(!n)return;!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n.trim())||n.includes("=")||n.includes("<")||n.includes(">")||n.includes("!")||n.includes("&")||n.includes("|")||n.includes("'")||n.includes('"')||n.includes("(")||n.includes(")")||this.evaluator.ensureVarInState(n);const a=r?r.addAsyncTask():null;i.addEventListener("input",(e=>{try{this.executeExpression(n,t,e,!0),a&&a()}catch(e){this.showError(i,e,n),a&&a()}}))}handleSubDirective(e,t,s,i,r,n,a=null){if("input"===r){!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(n.trim())||n.includes("=")||n.includes("<")||n.includes(">")||n.includes("!")||n.includes("&")||n.includes("|")||n.includes("'")||n.includes('"')||n.includes("(")||n.includes(")")||this.evaluator.ensureVarInState(n);const e=a?a.addAsyncTask():null;return i.addEventListener("input",(s=>{try{this.executeExpression(n,t,s,!0),e&&e()}catch(t){this.showError(i,t,n),e&&e()}})),!0}return!1}}class B extends h{apply(e,t,s,i,r=null){const n=e.directives["@do"];if(!n)return;const a=["@watch","@when","@fetch","@click","@input","@change","@blur","@focus","@hover","@go","@set","@model","@validate","@key","@result","@then","@finally","@error","@payload","@headers","@method","@page","@component","@src","@state","@log","@text","@class","@style","@show","@hide","@if","@for","@switch","@case","@default","@source","@map","@filter","@reduce","@initial","@animate","@link"];for(const t of a)if(e.directives[t]&&"@do"!==t)return;this.executeExpression(n,t),r&&r.addTask((()=>Promise.resolve()))}}class H extends h{apply(e,t,s,i,r=null){const n=e.directives["@when"],a=e.directives["@do"],o=e.directives["@go"],l=e.directives["@wait"];if(!a&&!o)return;const c=`when_${n}_${a||""}_${o||""}`;if(window._ayishaWhenLastState||(window._ayishaWhenLastState={}),!e._ayishaWhenWatcherSetup){e._ayishaWhenWatcherSetup=!0;const d=this.evaluator.extractDependencies(n);window.ayisha&&"function"==typeof window.ayisha.addWatcher&&d.forEach((d=>{window.ayisha.addWatcher(d,(()=>{this._ayishaWhenReactiveTrigger(e,t,s,i,c,n,a,o,l,r)}))}))}this._ayishaWhenReactiveTrigger(e,t,s,i,c,n,a,o,l,r,!0)}_ayishaWhenReactiveTrigger(e,t,s,i,r,n,a,o,l,c=null,d=!1){let h=!1;try{h=this.evaluator.evalExpr(n,t)}catch(e){return}const u=!!h;let p=window._ayishaWhenLastState[r];if("boolean"!=typeof p&&(p=!1),u&&!p){let e=!1;const i=()=>{if(!e){e=!0,window._ayishaWhenLastState[r]=!0;try{if(a&&this.executeExpression(a,t,null,!1),o){let e;try{let s=this.evaluator.autoPageName(o);e=this.evaluator.evalExpr(s,t)}catch(t){e=void 0}!e&&"string"==typeof o&&o.trim()&&(e=o.trim().replace(/^['"]|['"]$/g,"")),"string"==typeof e&&e.length>0&&s._currentPage!==e&&(s._currentPage=e,window&&window.history&&"function"==typeof window.history.pushState&&(window.history.pushState({},"","/"+e),window.dispatchEvent(new PopStateEvent("popstate"))))}c&&c.addTask((()=>Promise.resolve()))}catch(e){}}},d=l?this.parseDelay(l,t,s):0;if(d>0)if(c){const e=new Promise((e=>{setTimeout((()=>{let s=!1;try{s=this.evaluator.evalExpr(n,t)}catch{}s?i():window._ayishaWhenLastState[r]=!1,e()}),d)}));c.addTask(e)}else setTimeout((()=>{let e=!1;try{e=this.evaluator.evalExpr(n,t)}catch{}e?i():window._ayishaWhenLastState[r]=!1}),d);else i(),c&&setTimeout((()=>{c.markSyncDone()}),0)}else!u&&p&&(window._ayishaWhenLastState[r]=!1)}parseDelay(e,t,s){try{let s=this.evaluator.evalExpr(e,t);const i=parseInt(s,10);return isNaN(i)?0:Math.max(0,i)}catch(e){return 0}}}class F extends h{apply(e,t,s,i,r=null){if(e.directives["@when"])return;let n=e.directives["@go"];this.evaluator&&"function"==typeof this.evaluator.autoPageName&&(n=this.evaluator.autoPageName(n));let a=this.evaluator?this.evaluator.evalExpr(n,t):n;if("string"==typeof a){let e=this.resolvePath(a);if(s._currentPage=e,window&&window.history&&"function"==typeof window.history.pushState){const t=e?"/"+e:"/";window.history.pushState({},"",t),window.dispatchEvent(new PopStateEvent("popstate"))}"function"==typeof window.ayisha?.render&&(window.ayisha?._isRendering||window.ayisha?._componentRenderQueued||(clearTimeout(window.ayisha?._componentRenderTimeout),window.ayisha._componentRenderQueued=!0,window.ayisha._componentRenderTimeout=setTimeout((()=>{window.ayisha._componentRenderQueued=!1,window.ayisha.render()}),0)))}r&&r.addTask((()=>Promise.resolve()))}resolvePath(e){return e?e.startsWith("/")?e.substring(1):e:""}}class W extends h{apply(e,t,s,i,r=null){r&&r.addTask((()=>Promise.resolve()))}}class Z extends h{apply(e,t,s,i,r=null){const n=e.directives["@set"];if(!n||e._setProcessed)return;let a=n;a=Array.isArray(a)?a.flat().filter(Boolean):"string"==typeof a?a.split(/;;|\n/).map((e=>e.trim())).filter(Boolean):[a],a.forEach((e=>{try{const i=/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=([^=].*)/g;let r;for(;null!==(r=i.exec(e));){const e=r[1];e in s&&void 0!==s[e]||(s[e]=this.evaluator.evalExpr(r[2],t))}}catch(e){i&&i.setAttribute("data-ayisha-set-error",e.message)}})),e._setProcessed=!0,delete e.directives["@set"],r&&r.addTask((()=>Promise.resolve()))}handleSubDirective(e,t,s,i,r,n,a=null){if(["click","input","change","focus","blur"].includes(r)){const e=a?a.addAsyncTask():null;return i.addEventListener(r,(()=>{try{this.executeExpression(n,t,null,!0),e&&e()}catch(t){this.showError(i,t,n),e&&e()}})),!0}return!1}}class J extends h{apply(e,t,s,i,r=null){const n=e.directives["@then"];r&&n&&r.addThen((()=>{try{this.evaluator.executeDirectiveExpression(n,t,s,i)}catch(e){this.showError(i,e,n)}}))}}class U extends h{apply(e,t,s,i,r=null){const n=e.directives["@finally"];r&&n&&r.addFinally((()=>{try{this.evaluator.executeDirectiveExpression(n,t,s,i)}catch(e){this.showError(i,e,n)}}))}}class Q extends h{apply(e,t,s,i,r=null){i&&e.directives["@key"]&&i.setAttribute("data-ayisha-key",e.directives["@key"]),r&&r.addTask((()=>Promise.resolve()))}}class q extends h{apply(e,t,s,i,r=null){if(i&&e.directives["@src"]){const t=e.directives["@src"],s=window.ayisha?.componentManager?.loadExternalComponent(t).then((e=>{e&&(i.innerHTML=e)}));r&&s&&r.addTask(s)}}}class G extends h{apply(e,t,s,i,r=null){if(i&&e.directives["@page"]){const t=e.directives["@page"];i.style.display=s._currentPage===t?"":"none"}r&&r.addTask((()=>Promise.resolve()))}}class K extends h{constructor(e,t,s,i){super(e,t,s),this.componentManager=i,this._scopeCounter=0,this._scopeMap=new WeakMap,this._instanceIdMap=new WeakMap}static _scopeCounter=1;static _scopeMap=new WeakMap;static _elementInstanceMap=new WeakMap;apply(e,t,s,i,r=null){const n=e.directives["@src"];if(!n)return this.errorHandler.createErrorElement("Error: <b>&lt;component&gt;</b> requires the <b>@src</b> attribute");let a=null;try{a=this.evaluator.evalExpr(n,t)}catch(e){a=n}if(a||(a=n),"string"==typeof a&&(a=a.trim()),"string"==typeof a&&/^['"].*['"]$/.test(a)&&(a=a.slice(1,-1)),!a||"undefined"===a||"null"===a)return this.errorHandler.createErrorElement("Error: Invalid component URL");a.startsWith("./")&&(a=a.substring(2));const o=i||e;let l=K._elementInstanceMap.get(o);if(l||(l=K._scopeCounter++,K._elementInstanceMap.set(o,l)),e.directives["@scope"]){const t=String(e.directives["@scope"]).split(",").map((e=>e.trim())).filter(Boolean);let i=K._scopeMap.get(o);i||(i={scopedNames:{},htmlPatched:!1},K._scopeMap.set(o,i)),e._scopedNames=e._scopedNames||{},t.forEach((t=>{if(!i.scopedNames[t]){const r=`${t}_${String(l).padStart(4,"0")}`;i.scopedNames[t]=r,e.scopedVars&&void 0!==e.scopedVars[t]&&(e.scopedVars[r]=e.scopedVars[t]),void 0!==s[t]&&void 0===s[r]&&(s[r]=s[t])}e._scopedNames[t]=i.scopedNames[t]}))}const c=window.ayisha?.componentManager;if(c&&c.getCachedComponent(a)){let i=c.getCachedComponent(a);if(e._scopedNames&&!K._scopeMap.get(o)?.htmlPatched){Object.entries(e._scopedNames).forEach((([e,t])=>{const s=new RegExp(`@result=["']${e}(?!_\\d+)["']`,"g"),r=new RegExp(`\\b${e}(?!_\\d+)\\.`,"g");i=i.replace(s,`@result="${t}"`),i=i.replace(r,`${t}.`)}));const t=K._scopeMap.get(o);t&&(t.htmlPatched=!0)}const n=document.createElement("div");n.innerHTML=i,window.ayisha?._processComponentInitBlocks(n);const l=window.ayisha?.parse(n);if(l&&l.children){let i;if(e.scopedVars&&"object"==typeof e.scopedVars){i=Object.create(t||null);for(const[s,r]of Object.entries(e.scopedVars)){let e=r;try{e=window.ayisha.evaluator.evalExpr(r,t)}catch{}i[s]=e}}else i=Object.create(null);const n=document.createDocumentFragment();return l.children.forEach((e=>{const t=s._ayishaInstance._renderVNode(e,i);t&&n.appendChild(t)})),r&&r.addTask((()=>Promise.resolve())),n}}if(c&&!c.getCachedComponent(a)){const t=c.loadExternalComponent(a).then((t=>{if(t){let s=t;if(e._scopedNames&&!K._scopeMap.get(o)?.htmlPatched){Object.entries(e._scopedNames).forEach((([e,t])=>{const i=new RegExp(`@result=["']${e}(?!_\\d+)["']`,"g"),r=new RegExp(`\\b${e}(?!_\\d+)\\.`,"g");s=s.replace(i,`@result="${t}"`),s=s.replace(r,`${t}.`)}));const t=K._scopeMap.get(o);t&&(t.htmlPatched=!0)}const i=document.createElement("div");i.innerHTML=s,window.ayisha?._processComponentInitBlocks(i),window.ayisha?._isRendering||window.ayisha?._componentRenderQueued||(clearTimeout(window.ayisha?._componentRenderTimeout),window.ayisha._componentRenderQueued=!0,window.ayisha._componentRenderTimeout=setTimeout((()=>{window.ayisha._componentRenderQueued=!1,window.ayisha.render()}),10))}})).catch((e=>{c.cache[a]=`<div class='component-error' style='padding: 10px; background: #ffe6e6; border: 1px solid #ff6b6b; border-radius: 4px; color: #d32f2f;'>Errore: ${e.message}</div>`,window.ayisha?._isRendering||window.ayisha?._componentRenderQueued||(clearTimeout(window.ayisha?._componentRenderTimeout),window.ayisha._componentRenderQueued=!0,window.ayisha._componentRenderTimeout=setTimeout((()=>{window.ayisha._componentRenderQueued=!1,window.ayisha.render()}),10))}));r&&r.addTask(t)}const d=document.createElement("div");return d.className="component-loading",d.style.cssText="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; color: #6c757d; font-size: 14px; text-align: center;",d.innerHTML=`⏳ Loading component: <code>${a}</code>`,d}}class Y extends h{apply(e,t,s,i,r=null){const n=this.evaluator.evalExpr(e.directives["@switch"],t);let a=null;for(const i of e.children)if(i.directives){if(null!=i.directives["@case"]){let e=i.directives["@case"];if(/^['"].*['"]$/.test(e)&&(e=e.slice(1,-1)),String(e)===String(n))return r&&r.addTask((()=>Promise.resolve())),s._ayishaInstance._renderVNode(i,t)}null!=i.directives["@default"]&&(a=i)}return r&&r.addTask((()=>Promise.resolve())),a?s._ayishaInstance._renderVNode(a,t):document.createComment("noswitch")}}class X extends h{apply(e,t,s,i,r=null){r&&r.addTask((()=>Promise.resolve()))}}class ee extends h{apply(e,t,s,i,r=null){r&&r.addTask((()=>Promise.resolve()))}}class te extends h{apply(e,t,s,i,r=null){if(i&&e.directives["@source"]){const s=e.directives["@source"],r=this.evaluator?.evalExpr(s,t);i.ayishaSourceData=r}r&&r.addTask((()=>Promise.resolve()))}}class se extends h{apply(e,t,s,i,r=null){if(i&&e.directives["@map"]){const s=e.directives["@map"],r=i.ayishaSourceData;if(Array.isArray(r))try{const e=this.evaluator?.evalExpr(s,t);i.ayishaSourceData=r.map(e)}catch{}}r&&r.addTask((()=>Promise.resolve()))}}class ie extends h{apply(e,t,s,i,r=null){if(i&&e.directives["@filter"]){const s=e.directives["@filter"],r=i.ayishaSourceData;if(Array.isArray(r))try{const e=this.evaluator?.evalExpr(s,t);i.ayishaSourceData=r.filter(e)}catch{}}r&&r.addTask((()=>Promise.resolve()))}}class re extends h{apply(e,t,s,i,r=null){if(i&&e.directives["@reduce"]){const s=e.directives["@reduce"],r=e.directives["@initial"],n=i.ayishaSourceData;if(Array.isArray(n))try{const e=this.evaluator?.evalExpr(s,t);i.ayishaSourceData=n.reduce(e,r)}catch{}}r&&r.addTask((()=>Promise.resolve()))}}class ne extends h{apply(e,t,s,i,r=null){r&&r.addTask((()=>Promise.resolve()))}}class ae extends h{apply(e,t,s,i,r=null){i&&e.directives["@animate"]&&i.classList.add(e.directives["@animate"]),r&&r.addTask((()=>Promise.resolve()))}}class oe extends h{apply(e,t,s,i,r=null){if(i&&e.directives["@link"]){const n=r?r.addAsyncTask():null;i.addEventListener("click",(i=>{i.preventDefault();const r=e.directives["@link"];let a=r;try{if(this.evaluator&&"string"==typeof r){const e=this.evaluator.evalAttrValue(r,t);if(e!==r)a=e;else{const s=r.trim();if(/^[a-zA-Z0-9_\/\.-]+$/.test(s)&&!s.startsWith("'")&&!s.startsWith('"')&&!s.includes("{")&&!s.includes("}")&&!s.includes(" "))a=s;else{const s=this.evaluator.evalExpr(r,t);a=null!=s&&void 0!==s?s:e}}}}catch{}a&&"object"==typeof a?a=Array.isArray(a)?a.join("/"):"string"==typeof r?r.trim():"":"string"!=typeof a&&(a=String(a??"").trim());let o=this.resolvePath(a);o&&"[object Object]"!==o||(o="string"==typeof r?this.resolvePath(r.trim()):"");const l=o.split("/").filter(Boolean);s._currentPage=l[0]||"",s._params=l.slice(1);const c="/"+l.join("/");window&&window.history&&"function"==typeof window.history.pushState&&(window.history.pushState({},"",c),window.dispatchEvent(new PopStateEvent("popstate"))),setTimeout((()=>{window.scrollTo({top:0,left:0,behavior:"smooth"})}),100),"function"==typeof window.ayisha?.render&&setTimeout((()=>window.ayisha.render()),0),n&&n()}))}}resolvePath(e){return e?e.startsWith("/")?e.substring(1):e:""}}class le extends h{apply(e,t,s,i,r=null){const n=e.directives["@hover"];if(!n)return;const a=r?r.addAsyncTask():null,o=e=>{try{this.executeExpression(n,t,e,!0),a&&a()}catch(e){this.showError(i,e,n),a&&a()}};i.addEventListener("mouseover",o),i.addEventListener("mouseout",o)}handleSubDirective(e,t,s,i,r,n,a=null){if("hover"===r){const e=a?a.addAsyncTask():null,s=s=>{try{this.executeExpression(n,t,s,!0),e&&e()}catch(t){this.showError(i,t,n),e&&e()}};return i.addEventListener("mouseover",s),i.addEventListener("mouseout",s),!0}return!1}}const ce={"@if":m,"@not":y,"@for":x,"@form":p,"@model":_,"@file":$,"@files":S,"@show":class extends h{apply(e,t,s,i,r=null){const n=e.directives["@show"];let a=!1;try{a=this.evaluator.evalExpr(n,t)}catch{}i&&(i.style.display=a?"":"none"),r&&r.addTask((()=>Promise.resolve()))}},"@hide":k,"@text":T,"@class":A,"@style":N,"@click":C,"@fetch":D,"@validate":M,"@state":L,"@log":z,"@attr":j,"@focus":V,"@blur":P,"@change":R,"@input":I,"@when":H,"@do":B,"@go":F,"@wait":W,"@set":Z,"@then":J,"@finally":U,"@key":Q,"@src":q,"@page":G,"@component":K,"@switch":Y,"@case":X,"@default":ee,"@source":te,"@map":se,"@filter":ie,"@reduce":re,"@initial":ne,"@animate":ae,"@link":oe,"@prev":O,"@hover":le,"@date":v,"@dateonly":f,"@time":g,"@scope":u};class de{constructor(e,t,s,i){this.directives=new Map,this.evaluator=e,this.bindingManager=t,this.errorHandler=s,this.fetchManager=i,this.jsonManager=new b(this.evaluator),this.initializeDirectives()}initializeDirectives(){this.register("@if",new m(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@not",new y(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@for",new x(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@form",new p(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@model",new _(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@file",new $(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@files",new S(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@hide",new k(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@text",new T(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@date",new v(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@dateonly",new f(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@time",new g(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@class",new A(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@style",new N(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@click",new C(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@fetch",new D(this.evaluator,this.bindingManager,this.errorHandler,this.fetchManager)),this.register("@json",new w(this.evaluator,this.bindingManager,this.errorHandler,this.jsonManager)),this.register("@validate",new M(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@state",new L(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@log",new z(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@attr",new j(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@focus",new V(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@blur",new P(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@change",new R(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@input",new I(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@when",new H(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@do",new B(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@go",new F(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@wait",new W(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@set",new Z(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@then",new J(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@finally",new U(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@key",new Q(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@src",new q(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@page",new G(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@component",new K(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@switch",new Y(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@case",new X(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@default",new ee(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@source",new te(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@map",new se(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@filter",new ie(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@reduce",new re(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@initial",new ne(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@animate",new ae(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@prev",new O(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@link",new oe(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@hover",new le(this.evaluator,this.bindingManager,this.errorHandler)),this.register("@scope",new u(this.evaluator,this.bindingManager,this.errorHandler))}register(e,t){this.directives.set(e,t)}getDirective(e){return this.directives.get(e)}applyDirectives(e,t,s,i,r=null){if(e.directives&&e.directives["@watch"]&&e.directives["@do"]&&window.ayisha&&"function"==typeof window.ayisha.addWatcher){window._ayishaGlobalWatchRegistry||(window._ayishaGlobalWatchRegistry=new Set);let s=null,i=[],r=e;for(;r;){let e=r.tag||"",t="";r.attrs&&(t=Object.entries(r.attrs).filter((([e,t])=>"string"==typeof t&&!e.startsWith("@"))).map((([e,t])=>`${e}=${t}`)).join(";"));let s=r.directives&&r.directives["@for"]?`@for=${r.directives["@for"]}`:"";i.push(`${e}|${t}|${s}`),r=r.parent||r._parent||null}i=i.reverse(),s=i.join(">")+"::"+e.directives["@watch"]+"::"+e.directives["@do"],e.directives["@__autoKey"]=s,e.directives["@watch"].split(",").forEach((i=>{const r=i.trim(),n=r+"::"+e.directives["@do"]+"::"+s;window._ayishaGlobalWatchRegistry.has(n)||(window._ayishaGlobalWatchRegistry.add(n),window.ayisha.addWatcher(r,(()=>{try{window.ayisha.evaluator.executeDirectiveExpression(e.directives["@do"],t,null,!0)}catch(e){}}),{oneShot:!1}))}))}Object.keys(e.directives||{}).forEach((n=>{if("@then"===n||"@finally"===n)return;const a=this.getDirective(n);if(a)try{a.apply(e,t,s,i,r)}catch(t){this.errorHandler.showAyishaError(i,t,e.directives[n])}})),Object.entries(e.subDirectives||{}).forEach((([n,a])=>{const o=this.getDirective(n);o&&Object.entries(a).forEach((([n,a])=>{try{o.handleSubDirective(e,t,s,i,n,a,r)}catch(e){this.errorHandler.showAyishaError(i,e,a)}}))}))}}class he{constructor(e){this.evaluator=e,this.startTime=performance.now()}getBaseInfo(e,t){return{tag:e.tag,timestamp:new Date,executionTime:(performance.now()-this.startTime).toFixed(2)+"ms"}}log(e,t,s){return this.getBaseInfo(e,t)}}class ue extends he{log(e,t,s){const i=super.log(e,t,s),r=e.directives["@for"];let n={};try{const e=r.match(/(\w+),\s*(\w+) in (.+)/),s=r.match(/(\w+) in (.+)/);if(e||s){const i=e?e[3]:s[2],a=e?e[2]:s[1],o=e?e[1]:null,l=this.evaluator.evalExpr(i,t),c=Array.isArray(l),d=c?l.length:l?Object.keys(l).length:0;n={expression:r,arrayVariable:i,itemVariable:a,indexVariable:o,arrayType:c?"Array":"Object",length:d,isEmpty:0===d,firstItem:d>0?l[0]:null,status:0===d?"❌ Empty":`✅ ${d} items`,performance:`${d} items rendered`}}}catch(e){n={expression:r,error:`❌ ${e.message}`,status:"❌ Error evaluating"}}return{...i,type:"@for",data:n}}}class pe extends he{constructor(e,t){super(e),this.fetchManager=t}log(e,t,s){const i=super.log(e,t,s),r=e.directives["@fetch"],n=e.directives["@result"]||"result";let a={};try{let e=this.evaluator.evalExpr(r,t);e||(e=r);const i=s[n],o=this.fetchManager.fetched[e]?.error,l=this.fetchManager.pendingFetches[`${e}::${n}`];a={url:e,method:"GET",resultVariable:n,status:o?`❌ ${o}`:l?"⏳ Loading...":i?"✅ Success":"⭕ No data",responseSize:i?`${JSON.stringify(i).length} chars`:"N/A",hasData:!!i,hasError:!!o,isPending:!!l,lastFetch:this.fetchManager.lastFetchUrl[n]?"Recently":"Never"}}catch(e){a={url:r,error:`❌ ${e.message}`,status:"❌ Error evaluating URL"}}return{...i,type:"@fetch",data:a}}}class ve extends he{log(e,t,s){const i=super.log(e,t,s),r=e.directives["@model"],n=e.directives["@validate"];let a={};try{const e=this.evaluator.evalExpr(r,t),i=s._validate?.[r];a={variable:r,currentValue:e,valueType:typeof e,isEmpty:!e||""===e,validation:n?{rules:n,isValid:i,status:i?"✅ Valid":"❌ Invalid"}:null,binding:"✅ Active"}}catch(e){a={variable:r,error:`❌ ${e.message}`,status:"❌ Error evaluating"}}return{...i,type:"@model",data:a}}}class fe extends he{log(e,t,s){const i=super.log(e,t,s),r=e.directives["@if"]||e.directives["@show"]||e.directives["@hide"],n=e.directives["@if"]?"@if":e.directives["@show"]?"@show":"@hide";let a={};try{const e=this.evaluator.evalExpr(r,t),s="@hide"===n?!e:!!e;a={condition:r,result:e,isVisible:s,status:s?"✅ Visible":"❌ Hidden",evaluation:`${r} → ${e}`}}catch(e){a={condition:r,error:`❌ ${e.message}`,status:"❌ Error evaluating"}}return{...i,type:n,data:a}}}class ge extends he{constructor(e){super(e),this.clickCount=0,this.lastClick=null}log(e,t,s){return{...super.log(e,t,s),type:"@click",data:{action:e.directives["@click"],clickCount:this.clickCount,lastClick:this.lastClick?Date.now()-this.lastClick+"ms ago":"Never",status:"✅ Ready"}}}recordClick(){this.clickCount++,this.lastClick=Date.now()}}class me extends he{constructor(e){super(e),this.inputCount=0,this.lastInput=null}log(e,t,s){return{...super.log(e,t,s),type:"@input",data:{action:e.directives["@input"],inputCount:this.inputCount,lastInput:this.lastInput?Date.now()-this.lastInput+"ms ago":"Never",status:"✅ Ready"}}}recordInput(){this.inputCount++,this.lastInput=Date.now()}}class ye extends he{constructor(e){super(e),this.focusCount=0,this.lastFocus=null}log(e,t,s){return{...super.log(e,t,s),type:"@focus",data:{action:e.directives["@focus"],focusCount:this.focusCount,lastFocus:this.lastFocus?Date.now()-this.lastFocus+"ms ago":"Never",status:"✅ Ready"}}}recordFocus(){this.focusCount++,this.lastFocus=Date.now()}}class be extends he{constructor(e){super(e),this.blurCount=0,this.lastBlur=null}log(e,t,s){return{...super.log(e,t,s),type:"@blur",data:{action:e.directives["@blur"],blurCount:this.blurCount,lastBlur:this.lastBlur?Date.now()-this.lastBlur+"ms ago":"Never",status:"✅ Ready"}}}recordBlur(){this.blurCount++,this.lastBlur=Date.now()}}class we extends he{constructor(e){super(e),this.changeCount=0,this.lastChange=null}log(e,t,s){return{...super.log(e,t,s),type:"@change",data:{action:e.directives["@change"],changeCount:this.changeCount,lastChange:this.lastChange?Date.now()-this.lastChange+"ms ago":"Never",status:"✅ Ready"}}}recordChange(){this.changeCount++,this.lastChange=Date.now()}}class xe extends he{constructor(e,t){super(e),this.componentManager=t}log(e,t,s){const i=super.log(e,t,s),r=e.directives["@src"];let n={};try{let e=this.evaluator.evalExpr(r,t);if(!e){const t=r.trim();e=/^['"].*['"]$/.test(t)?t.slice(1,-1):t}const s=this.componentManager.getCachedComponent(e),i=this.componentManager.isLoading(e);n={source:e,status:i?"⏳ Loading...":s?"✅ Loaded":"⭕ Not loaded",cached:!!s,isLoading:i,size:s?`${s.length} chars`:"N/A"}}catch(e){n={source:r,error:`❌ ${e.message}`,status:"❌ Error evaluating"}}return{...i,type:"@component",data:n}}}class _e{constructor(){this.logs=[],this.loggers={},this.clickLoggers=new WeakMap,this.startTime=performance.now(),this.maxLogs=100}initializeLoggers(e,t,s){this.loggers={"@for":new ue(e),"@fetch":new pe(e,t),"@model":new ve(e),"@if":new fe(e),"@show":new fe(e),"@hide":new fe(e),"@click":new ge(e),"@component":new xe(e,s),"@input":new me(e),"@focus":new ye(e),"@blur":new be(e),"@change":new we(e)}}addLog(e,t,s,i,r=null){if(!this.loggers||0===Object.keys(this.loggers).length)return;const n=performance.now(),a={id:Date.now()+Math.random(),timestamp:new Date,tag:t.tag,type:"multi-directive",elementInfo:e,executionTime:(performance.now()-n).toFixed(2)+"ms",directives:[]};Object.keys(t.directives).forEach((e=>{if(this.loggers[e])try{const r=this.loggers[e].log(t,s,i);a.directives.push({type:e,data:r.data,status:this._getDirectiveStatus(r.data)})}catch(t){a.directives.push({type:e,data:{error:t.message,status:"❌ Error logging"},status:"error"})}else a.directives.push({type:e,data:{expression:t.directives[e],status:"📋 Untracked directive"},status:"unknown"})})),Object.entries(t.subDirectives||{}).forEach((([e,r])=>{Object.keys(r).forEach((n=>{if(this.loggers[e])try{const r=this.loggers[e].log(t,s,i);a.directives.push({type:`${e}:${n}`,data:r.data,status:this._getDirectiveStatus(r.data),isSubDirective:!0})}catch(t){a.directives.push({type:`${e}:${n}`,data:{error:t.message,status:"❌ Error logging"},status:"error",isSubDirective:!0})}else a.directives.push({type:`${e}:${n}`,data:{expression:r[n],status:"📋 Untracked sub-directive"},status:"unknown",isSubDirective:!0})}))})),0===a.directives.length&&(a.type="generic",a.directives.push({type:"generic",data:{message:"Element with @log but no tracked directives",status:"📋 Generic log"},status:"generic"})),a.overallStatus=this._calculateOverallStatus(a.directives),this.logs.unshift(a),this.logs.length>this.maxLogs&&(this.logs=this.logs.slice(0,this.maxLogs))}_getDirectiveStatus(e){return e.error?"error":e.isPending||e.isLoading?"loading":e.status&&e.status.includes("✅")?"success":e.status&&e.status.includes("❌")?"error":e.status&&e.status.includes("⏳")?"loading":"normal"}_calculateOverallStatus(e){if(!e||0===e.length)return"📊 No directives";const t=e.map((e=>e.status));return t.includes("error")?"❌ Has Errors":t.includes("loading")?"⏳ Loading":t.every((e=>"success"===e))?"✅ All Good":"📊 Mixed Status"}recordClick(e){const t=this.clickLoggers.get(e);t&&t.recordClick()}_getDirectiveColor(e){return{"@for":"#ff9800","@fetch":"#4caf50","@model":"#2196f3","@if":"#9c27b0","@show":"#9c27b0","@hide":"#9c27b0","@click":"#f44336","@component":"#00bcd4","@input":"#e91e63","@focus":"#3f51b5","@blur":"#607d8b","@change":"#795548",generic:"#666666"}[e]||"#666666"}_generateIntelligentLogHTML(e){const t=e.timestamp.toLocaleTimeString();if("multi-directive"===e.type){let s=`\n          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n            <span style="color: #66ccff; font-weight: bold;">🎯 &lt;${e.tag}&gt; (${e.directives.length} directives)</span>\n            <span style="color: #999; font-size: 10px;">${t}</span>\n          </div>\n          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">\n            <span style="color: #ffcc66; font-size: 10px;">⏱️ ${e.executionTime}</span>\n            <span style="color: ${this._getStatusColor(e.overallStatus)}; font-size: 10px; font-weight: bold;">${e.overallStatus}</span>\n          </div>\n        `;return e.directives.forEach(((e,t)=>{const i=this._getDirectiveColor(e.type),r=this._getStatusColor(e.status);s+=`\n            <div style="border-left: 3px solid ${i}; margin: 6px 0; padding: 6px 8px; background: rgba(255,255,255,0.03); border-radius: 3px;">\n              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">\n                <span style="color: ${i}; font-weight: bold; font-size: 11px;">\n                  ${e.isSubDirective?"📎":"📋"} ${e.type}\n                </span>\n                <span style="color: ${r}; font-size: 9px;">${this._getStatusIcon(e.status)}</span>\n              </div>\n              ${this._generateCompactDirectiveHTML(e.type,e.data)}\n            </div>\n          `})),s}return'<div style="color: #cccccc;">Generic log entry</div>'}_getStatusColor(e){if(!e)return"#cccccc";if("string"==typeof e){if(e.includes("error")||e.includes("❌"))return"#ff6b6b";if(e.includes("loading")||e.includes("⏳"))return"#ffa726";if(e.includes("success")||e.includes("✅"))return"#66bb6a"}return"#cccccc"}_getStatusIcon(e){return e?"error"===e?"❌":"loading"===e?"⏳":"success"===e?"✅":"unknown"===e?"❓":"📊":"📊"}_generateCompactDirectiveHTML(e,t){if(!t)return'<div style="color: #999;">No data available</div>';let s="";try{switch(e.split(":")[0]){case"@for":s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Array: <strong>${t.arrayVariable||"unknown"}</strong> (${t.length||0} items)<br>\n                Status: ${t.status||"unknown"}\n              </div>\n            `;break;case"@fetch":const e=t.url||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                URL: <strong>${e.slice(0,40)}${e.length>40?"...":""}</strong><br>\n                Status: ${t.status||"unknown"} | Size: ${t.responseSize||"N/A"}\n              </div>\n            `;break;case"@model":const i=t.currentValue,r="string"==typeof i?`"${i.slice(0,20)}${i.length>20?"...":""}"`:JSON.stringify(i);s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Variable: <strong>${t.variable||"unknown"}</strong><br>\n                Value: ${r} | ${t.validation?.status||"No validation"}\n              </div>\n            `;break;case"@if":case"@show":case"@hide":const n=t.condition||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Condition: <strong>${n.slice(0,30)}${n.length>30?"...":""}</strong><br>\n                Result: ${t.result} → ${t.isVisible?"Visible":"Hidden"}\n              </div>\n            `;break;case"@click":const a=t.action||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${a.slice(0,30)}${a.length>30?"...":""}</strong><br>\n                Clicks: ${t.clickCount||0} | Last: ${t.lastClick||"Never"}\n              </div>\n            `;break;case"@component":const o=t.source||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Source: <strong>${o.slice(0,30)}${o.length>30?"...":""}</strong><br>\n                Status: ${t.status||"unknown"} | Cached: ${t.cached?"Yes":"No"}\n              </div>\n            `;break;case"@input":const l=t.action||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${l.slice(0,30)}${l.length>30?"...":""}</strong><br>\n                Inputs: ${t.inputCount||0} | Last: ${t.lastInput||"Never"}\n              </div>\n            `;break;case"@focus":const c=t.action||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${c.slice(0,30)}${c.length>30?"...":""}</strong><br>\n                Focus events: ${t.focusCount||0} | Last: ${t.lastFocus||"Never"}\n              </div>\n            `;break;case"@blur":const d=t.action||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${d.slice(0,30)}${d.length>30?"...":""}</strong><br>\n                Blur events: ${t.blurCount||0} | Last: ${t.lastBlur||"Never"}\n              </div>\n            `;break;case"@change":const h=t.action||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Action: <strong>${h.slice(0,30)}${h.length>30?"...":""}</strong><br>\n                Change events: ${t.changeCount||0} | Last: ${t.lastChange||"Never"}\n              </div>\n            `;break;default:const u=t.expression||"";s=`\n              <div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n                Expression: <strong>${u.slice(0,40)}${u.length>40?"...":""}</strong><br>\n                Status: ${t.status||"unknown"}\n              </div>\n            `}t.error&&(s+=`<div style="color: #ff6b6b; font-size: 9px; margin-top: 2px;">💥 ${t.error}</div>`)}catch(e){s=`<div style="color: #ff6b6b; font-size: 9px;">Error rendering directive data: ${e.message}</div>`}return s}}class Ee{showAllErrors(e=document.body){if(!this.errorBus)return;const t=e.querySelector(".ayisha-error-list");t&&t.remove();const s=this.errorBus.getAll();if(!s.length)return;const i=document.createElement("div");i.className="ayisha-error-list",i.style.cssText="\n      background: #fff3f3;\n      color: #c00;\n      border: 1px solid #c00;\n      border-radius: 8px;\n      padding: 16px;\n      margin: 16px 0;\n      font-family: 'JetBrains Mono', 'Courier New', monospace;\n      font-size: 13px;\n      max-width: 600px;\n      box-shadow: 0 2px 8px rgba(200,0,0,0.08);\n    ",i.innerHTML=`<div style='font-weight:bold; color:#900; margin-bottom:8px;'>❌ Ayisha Error Log (${s.length})</div>`,s.forEach(((e,t)=>{const s=document.createElement("div");s.style.cssText="margin-bottom:10px; padding:8px; border-bottom:1px solid #fdd;",s.innerHTML=`\n        <div style='font-weight:bold;'>${t+1}. ${e.error?.message||e.error||"Unknown error"}</div>\n        <div style='color:#333; font-size:12px;'>${e.context&&e.context.expr?`<b>Expr:</b> <code>${e.context.expr}</code><br>`:""}\n          ${e.context&&e.context.type?`<b>Type:</b> ${e.context.type}<br>`:""}\n          <b>Time:</b> ${new Date(e.timestamp).toLocaleString()}\n        </div>\n      `,i.appendChild(s)})),e.appendChild(i)}isBot(){const e=navigator.userAgent.toLowerCase();return/bot|crawler|spider|googlebot|bingbot|facebookexternalhit|twitterbot/i.test(e)}renderForSEO(){this.processAllDirectivesSync(),this.loadAllComponentsSync(),this.executeAllFetchSync(),this.generateMetaTags()}processAllDirectivesSync(){Object.keys(ce).forEach((e=>{document.querySelectorAll(`[\\${e}]`).forEach((t=>{const s=new(0,ce[e])(this.evaluator,this.bindingManager,this.errorHandler),i={_el:t,directives:{[e]:t.getAttribute(e)}};s.apply(i,this.state,this.state,t)}))}))}loadAllComponentsSync(){document.querySelectorAll("[data-component]").forEach((e=>{const t=e.getAttribute("data-component");this.componentManager&&this.componentManager.getComponent(t)&&(e.innerHTML=this.componentManager.getComponent(t))}))}executeAllFetchSync(){const e=document.querySelectorAll("[\\@fetch]"),t=[];if(e.forEach((e=>{const s=e.getAttribute("@fetch");let i=s,r="result";const n=s.match(/(.+) as (\w+)/);n&&(i=n[1].trim(),r=n[2].trim());try{i=this.evaluator.evalExpr(i,this.state)}catch{}i&&t.push(fetch(i).then((e=>e.json())).then((e=>{this.state[r]=e})).catch((()=>{this.state[r]=null})))})),t.length>0){const e=Date.now();let s=!1;for(Promise.all(t).then((()=>{s=!0}));!s&&Date.now()-e<2e3;);}}generateMetaTags(){const e=document.querySelector("h1");e&&!document.title&&(document.title=e.textContent);const t=document.body.textContent.slice(0,160);if(!document.querySelector('meta[name="description"]')){const e=document.createElement("meta");e.name="description",e.content=t,document.head.appendChild(e)}}renderToString(e,t={}){if(!this.isServerSide()&&!this.options.ssr)throw new Error("renderToString can only be called in SSR mode");this._isSSRMode=!0,this.state={...this.state,...t},this._preInitializeEssentialVariables(),this._runInitBlocks(),this._vdom=this._parseTemplateForSSR(e);const s=this._renderVNodeToString(this._vdom,this.state);return this._hydrationData={state:this._serializeState(this.state),version:Ee.version},{html:s,state:this._hydrationData.state,hydrationScript:this._generateHydrationScript()}}_parseTemplateForSSR(e){const t=[],s={tag:"fragment",children:[],directives:{}};let i=s;const r=/<(\/?[a-zA-Z][a-zA-Z0-9]*)((?:\s+[^>]*)?)>/g;let n,a=0;for(;null!==(n=r.exec(e));){const s=e.slice(a,n.index).trim();s&&i.children.push({type:"text",text:s});const o=n[1],l=n[2];if(o.startsWith("/"))t.length>0&&(i=t.pop());else{const e={tag:o.toLowerCase(),children:[],directives:{},attrs:{}};if(l){const t=/([a-zA-Z@][a-zA-Z0-9_-]*)\s*=\s*"([^"]*)"/g;let s;for(;null!==(s=t.exec(l));){const t=s[1],i=s[2];t.startsWith("@")?e.directives[t]=i:e.attrs[t]=i}const i=/([a-zA-Z@][a-zA-Z0-9_-]*)\s*=\s*'([^']*)'/g;let r;for(;null!==(r=i.exec(l));){const t=r[1],s=r[2];t.startsWith("@")?e.directives[t]=s:e.attrs[t]=s}const n=/([a-zA-Z@][a-zA-Z0-9_-]*)\s*=\s*([^"'\s>]+)/g;let a;for(;null!==(a=n.exec(l));){const t=a[1],s=a[2];t.startsWith("@")?e.directives[t]=s:e.attrs[t]=s}}i.children.push(e);["img","br","hr","input","meta","link"].includes(o.toLowerCase())||l.includes("/")||(t.push(i),i=e)}a=r.lastIndex}const o=e.slice(a).trim();return o&&i.children.push({type:"text",text:o}),s}_createVirtualElement(e){const t={tagName:e.toUpperCase(),innerHTML:"",textContent:"",setAttribute:function(e,t){this.attributes=this.attributes||{},this.attributes[e]=t},getAttribute:function(e){return this.attributes?.[e]||null},hasAttribute:function(e){return this.attributes&&e in this.attributes},childNodes:[],children:[],nodeType:1,attributes:{},appendChild:function(e){this.childNodes.push(e),1===e.nodeType&&this.children.push(e)},querySelector:function(e){return null},querySelectorAll:function(e){return[]}};return Object.defineProperty(t,"innerHTML",{get:function(){return this._innerHTML||""},set:function(e){this._innerHTML=e,this.childNodes=[],this.children=[],e&&this._parseHTML(e)}}),t._parseHTML=function(e){if(e.trim()){const t={nodeType:3,textContent:e,nodeValue:e};this.childNodes.push(t)}},t}_renderVNodeToString(e,t){if(!e)return"";if("text"===e.type)return this._escapeHtml(this.evaluator.evalText(e.text,t));if("fragment"===e.tag)return e.children.map((e=>this._renderVNodeToString(e,t))).join("");if(e.directives&&e.directives["@if"]&&!this.evaluator.evalExpr(e.directives["@if"],t))return"";if(e.directives&&e.directives["@show"]&&!this.evaluator.evalExpr(e.directives["@show"],t))return"";if(e.directives&&e.directives["@hide"]&&this.evaluator.evalExpr(e.directives["@hide"],t))return"";if(e.directives&&e.directives["@for"])return this._handleForDirectiveSSR(e,t);if(e.directives&&e.directives["@switch"])return this._handleSwitchDirectiveSSR(e,t);if("component"===e.tag)return this._handleComponentDirectiveSSR(e,t);let s=`<${e.tag}`;if(Object.entries(e.attrs||{}).forEach((([e,i])=>{const r=this.evaluator.evalAttrValue?this.evaluator.evalAttrValue(i,t):i;s+=` ${e}="${this._escapeHtml(r)}"`})),e.directives&&Object.keys(e.directives).length>0&&(s+=' data-ayisha-hydrate="true"',s+=` data-ayisha-directives="${this._escapeHtml(JSON.stringify(e.directives))}"`),s+=">",e.directives&&e.directives["@text"]){const i=this.evaluator.evalExpr(e.directives["@text"],t);s+=this._escapeHtml(String(i||""))}else e.children&&e.children.forEach((e=>{s+=this._renderVNodeToString(e,t)}));return s+=`</${e.tag}>`,s}_handleForDirectiveSSR(e,t){let s=e.directives["@for"].match(/(\w+),\s*(\w+) in (.+)/);if(s){const[,i,r,n]=s;let a=this.evaluator.evalExpr(n,t)||[];return"object"!=typeof a||Array.isArray(a)||(a=Object.values(a)),a.map(((s,n)=>{const a=JSON.parse(JSON.stringify(e));delete a.directives["@for"];const o={...t,[r]:s,[i]:n};return this._renderVNodeToString(a,o)})).join("")}if(s=e.directives["@for"].match(/(\w+) in (.+)/),s){const[,i,r]=s;let n=this.evaluator.evalExpr(r,t)||[];return"object"!=typeof n||Array.isArray(n)||(n=Object.values(n)),n.map(((s,r)=>{const n=JSON.parse(JSON.stringify(e));delete n.directives["@for"];const a={...t,[i]:s,$index:r};return this._renderVNodeToString(n,a)})).join("")}return""}_handleSwitchDirectiveSSR(e,t){const s=this.evaluator.evalExpr(e.directives["@switch"],t);for(const i of e.children||[])if(i.directives){if(null!=i.directives["@case"]){let e=i.directives["@case"];if(/^['"].*['"]$/.test(e)&&(e=e.slice(1,-1)),String(e)===String(s))return this._renderVNodeToString(i,t)}if(null!=i.directives["@default"])return this._renderVNodeToString(i,t)}return""}_handleComponentDirectiveSSR(e,t){const s=e.directives["@src"];if(s&&this.componentManager?.getCachedComponent(s)){return this.componentManager.getCachedComponent(s)}return`\x3c!-- Component: ${s||"unknown"} --\x3e`}_escapeHtml(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(e).replace(/[&<>"']/g,(e=>t[e]))}_serializeState(e){const t={};return Object.keys(e).forEach((s=>{if("function"!=typeof e[s]&&"_ayishaInstance"!==s)try{JSON.stringify(e[s]),t[s]=e[s]}catch(e){}})),t}_generateHydrationScript(){return`\n<script>\nwindow.__AYISHA_HYDRATION_DATA__ = ${JSON.stringify(this._hydrationData)};\n<\/script>`}static version="1.0.4";isServerSide(){return"undefined"==typeof window||"undefined"==typeof document||"undefined"!=typeof global}isNodeJS(){return"undefined"!=typeof process&&process.versions&&process.versions.node}constructor(t=document.body,h={}){if(this.options={ssr:!1,hydration:!1,initialState:{},...h},this.errorBus=new e,this.errorBus.onError((()=>{setTimeout((()=>this.showAllErrors()),0)})),this.root=t,this.state={...this.options.initialState},this._initBlocks=[],this._vdom=null,this._isRendering=!1,this._processedSetDirectives=new Set,this._componentRenderTimeout=null,this._setNodes=new WeakSet,this._isSSRMode=this.options.ssr||this.isServerSide(),this._isHydrationMode=this.options.hydration,this._ssrOutput="",this._hydrationData={},this.evaluator=new s(this.state),this.parser=new i(this._initBlocks),this.componentManager=new r,this.reactivitySystem=new n(this.state,(()=>this.render())),this.router=new a(this.state,(()=>this.render())),this.fetchManager=new o(this.evaluator),this.helpSystem=new l,this.errorHandler=new c(this.errorBus),this.bindingManager=new d(this.evaluator,(()=>this.render())),this.centralLogger=new _e,this.centralLogger.initializeLoggers(this.evaluator,this.fetchManager,this.componentManager),this.directiveManager=new de(this.evaluator,this.bindingManager,this.errorHandler,this.fetchManager),!("_currentPage"in this.state)||!this.state._currentPage){let e=null,t=[];if("undefined"!=typeof document)try{t=document.querySelectorAll("[@page]")}catch(e){try{t=document.querySelectorAll("[@page]")}catch(e){t=[]}}t.length>0&&(e=t[0].getAttribute("@page")),this.state._currentPage=e||"home"}this.isBot&&"function"==typeof this.isBot&&this.isBot()&&this.renderForSEO(),"undefined"!=typeof window&&(window.ayisha=this)}component(e,t){this.componentManager.component(e,t)}addWatcher(e,t){this.reactivitySystem.addWatcher(e,t)}directiveHelp(e){return this.helpSystem.getHelp(e)}parse(e){return this.parser.parse(e)}_runInitBlocks(){if(this._isRendering)return;this._initBlocks.forEach((e=>{if(!e||!e.trim())return;let t=e.trim().replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n\s*\n/g,"\n").replace(/\n\s+/g,"\n").trim();const s=t.split("\n");t=s.map((e=>{const t=e.trim();if(!t||t.startsWith("function")||t.includes("function(")||t.includes("=>")||/^(if|else|for|while|switch|case|default|try|catch|finally|return|var|let|const)\b/.test(t))return e;const s=t.match(/^([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*(.+)$/);if(s&&!t.includes("state.")&&!t.includes("this.")&&!t.includes("window.")&&!t.includes("console.")&&!t.includes("localStorage.")&&!t.includes("sessionStorage.")){const[,t,i]=s;if(!["JSON","Object","Array","String","Number","Boolean","Date","Math","RegExp"].includes(t))return e.replace(s[0],`state.${t} = ${i}`)}return e})).join("\n");try{new Function("state",t)(this.state)}catch(e){}}));["JSON","Object","Array","String","Number","Boolean","Date","Math","RegExp","console","window","document","setTimeout","setInterval","fetch","localStorage","sessionStorage","history","location","navigator","undefined","null","true","false"].forEach((e=>{e in this.state&&delete this.state[e]}));Object.keys(this.state).forEach((e=>{/[+\-*\/=<>!&|(){}[\].,\s]|=>|==|!=|<=|>=|\|\||&&/.test(e)&&delete this.state[e]}));["_validate","_currentPage","_params","_version","_locale"].forEach((e=>{e in this.state||("_validate"===e?this.state[e]={}:"_currentPage"===e?this.state[e]="":"_params"===e?this.state[e]=[]:"_version"===e?this.state[e]=Ee.version:"_locale"===e&&(this.state[e]="undefined"!=typeof navigator&&(navigator.language||navigator.userLanguage)||"en"))})),"_ayishaInstance"in this.state&&delete this.state._ayishaInstance;Object.keys(this.state).filter((e=>e.includes("=")||e.includes("<")||e.includes(">")||e.includes("!")||e.includes("&")||e.includes("|")||e.includes("'")||e.includes('"')||e.includes("(")||e.includes(")")||e.includes(" "))).forEach((e=>{delete this.state[e]}))}_preInitializeEssentialVariables(){this.state._validate||(this.state._validate={}),this.state._currentPage||(this.state._currentPage=""),this.state._version||(this.state._version=Ee.version),this.state._locale||(this.state._locale="undefined"!=typeof navigator&&(navigator.language||navigator.userLanguage)||"en"),"_ayishaInstance"in this.state&&delete this.state._ayishaInstance;const e=()=>{var e;"undefined"!=typeof window?(this.state._currentBreakpoint=(e=window.innerWidth)<576?"xs":e<768?"sm":e<992?"md":e<1200?"lg":e<1400?"xl":"xxl",this.state._screenSize=window.innerWidth):(this.state._currentBreakpoint="lg",this.state._screenSize=1200)};e(),this._breakpointListenerAdded||"undefined"==typeof window||(window.addEventListener("resize",e),this._breakpointListenerAdded=!0)}_makeReactive(){this.state=this.reactivitySystem.makeReactive(),this.evaluator.state=this.state,this.fetchManager.evaluator.state=this.state}_setupRouting(){this.router.setupRouting()}_findFirstPageDirective(e){if(!e)return null;if(e.directives&&e.directives["@page"])return e;if(e.children&&e.children.length)for(const t of e.children){const e=this._findFirstPageDirective(t);if(e)return e}return null}async preloadComponents(){const e=[],t=new Set;if(this.root.querySelectorAll("component").forEach((s=>{let i=null;if(s.hasAttribute("src"))i=s.getAttribute("src");else if(s.hasAttribute("@src")){const e=s.getAttribute("@src");if(/^['\"].*['\"]$/.test(e))i=e.slice(1,-1);else try{i=this.evaluator.evalExpr(e)}catch(t){(e.includes(".html")||e.startsWith("./"))&&(i=e)}}!i||t.has(i)||this.componentManager.getCachedComponent(i)||(t.add(i),e.push(this.componentManager.loadExternalComponent(i)))})),e.length>0)try{await Promise.allSettled(e)}catch(e){}}render(){if(this._isRendering)return;this._isRendering=!0,"_ayishaInstance"in this.state&&delete this.state._ayishaInstance;const e=Object.keys(this.state).filter((e=>e.includes("=")||e.includes("<")||e.includes(">")||e.includes("!")||e.includes("&")||e.includes("|")||e.includes("'")||e.includes('"')||e.includes("(")||e.includes(")")||e.includes(" ")||e.includes("+")||e.includes("-")||e.includes("*")||e.includes("/")||e.includes("%")||e.includes("[")||e.includes("]")||e.includes("{")||e.includes("}")||e.includes("?")||e.includes(":")||e.includes(";")||e.includes(",")||!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(e)));e.length>0&&e.forEach((e=>{delete this.state[e]}));const t=window.scrollX,s=window.scrollY,i=document.activeElement;let r=null;if(i&&("INPUT"===i.tagName||"TEXTAREA"===i.tagName)){const e=[];let t=i;for(;t&&t!==this.root;){const s=t.parentNode;e.unshift([...s.childNodes].indexOf(t)),t=s}r={path:e,start:i.selectionStart,end:i.selectionEnd,type:i.type}}this.bindingManager.clearBindings();const n=this._renderVNode(this._vdom,this.state);if(this.root===document.body?(document.body.innerHTML="",n&&(void 0===n.tagName&&n.childNodes?Array.from(n.childNodes).forEach((e=>document.body.appendChild(e))):(DocumentFragment,document.body.appendChild(n)))):(this.root.innerHTML="",n&&(void 0===n.tagName&&n.childNodes?Array.from(n.childNodes).forEach((e=>this.root.appendChild(e))):(DocumentFragment,this.root.appendChild(n)))),r){let e=this.root;for(const t of r.path){if(!e||!e.childNodes||!e.childNodes[t]){e=void 0;break}e=e.childNodes[t]}if(e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName)){e.focus();try{("INPUT"===e.tagName&&"number"==typeof e.selectionStart&&"function"==typeof e.setSelectionRange&&"number"!==e.type||"TEXTAREA"===e.tagName)&&e.setSelectionRange(r.start,r.end)}catch(e){}}}this._addLogIndicators(),window.scrollTo(t,s),this.bindingManager.updateBindings(),this._whenDirectiveWatchers&&this._whenDirectiveWatchers.forEach((e=>{try{e()}catch{}})),this._isRendering=!1}_addLogIndicators(){this.root.querySelectorAll('[data-ayisha-log="true"]').forEach((e=>{const t=e.nextElementSibling;t&&t.classList.contains("ayisha-log-display")&&t.remove();try{const t=JSON.parse(e.getAttribute("data-ayisha-log-info")||"{}"),s=document.createElement("div");s.className="ayisha-log-display",s.style.cssText="\n            background: rgba(0, 20, 40, 0.95) !important;\n            color: #fff !important;\n            padding: 8px 12px !important;\n            margin: 4px 0 !important;\n            border-radius: 6px !important;\n            font-family: 'JetBrains Mono', 'Courier New', monospace !important;\n            font-size: 11px !important;\n            border-left: 4px solid #0066cc !important;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;\n            max-width: 400px !important;\n            overflow-x: auto !important;\n            line-height: 1.4 !important;\n          ";const i=this._generateInlineLogContent(e,t);s.innerHTML=i,e.parentNode&&e.parentNode.insertBefore(s,e.nextSibling)}catch(e){}}));this.root.querySelectorAll("[data-ayisha-log-error]").forEach((e=>{const t=e.getAttribute("data-ayisha-log-error"),s=document.createElement("div");s.className="ayisha-log-error-display",s.style.cssText="\n          background: rgba(255, 0, 0, 0.9) !important;\n          color: white !important;\n          padding: 8px 12px !important;\n          margin: 4px 0 !important;\n          border-radius: 6px !important;\n          font-family: monospace !important;\n          font-size: 11px !important;\n          font-weight: bold !important;\n          display: block !important;\n        ",s.innerHTML=`❌ Log Error: ${t}`,e.parentNode&&e.parentNode.insertBefore(s,e.nextSibling)}))}_generateInlineLogContent(e,t){const s={tag:t.tag||e.tagName.toLowerCase(),directives:t.directives||{},subDirectives:t.subDirectives||{}},i={};let r=`<div style="color: #66ccff; font-weight: bold; margin-bottom: 6px;">📊 &lt;${s.tag}&gt;</div>`,n=!1,a=0;if(Object.keys(s.directives).forEach((e=>{if("@log"!==e)if(a++,this.centralLogger.loggers[e]){n=!0;try{const t=this.centralLogger.loggers[e].log(s,i,this.state);r+=this._formatDirectiveLog(e,t.data)}catch(t){r+=`<div style="color: #ff6b6b; margin: 2px 0;">\n              <span style="color: #ff9999;">${e}</span>: \n              <span style="color: #ffcccc;">❌ ${t.message}</span>\n            </div>`}}else r+=`<div style="color: #999; margin: 2px 0;">\n            <span style="color: #ccc;">${e}</span>: \n            <span style="color: #aaa;">${this._truncateValue(s.directives[e])}</span>\n            <span style="color: #777; font-size: 10px;"> [untracked]</span>\n          </div>`})),Object.entries(s.subDirectives||{}).forEach((([e,t])=>{Object.keys(t).forEach((o=>{a++;const l=`${e}:${o}`;if(this.centralLogger.loggers[e]){n=!0;try{const t=this.centralLogger.loggers[e].log(s,i,this.state);r+=this._formatDirectiveLog(l,t.data,!0)}catch(e){r+=`<div style="color: #ff6b6b; margin: 2px 0;">\n                <span style="color: #ff9999;">${l}</span>: \n                <span style="color: #ffcccc;">❌ ${e.message}</span>\n              </div>`}}else r+=`<div style="color: #999; margin: 2px 0;">\n              <span style="color: #ccc;">${l}</span>: \n              <span style="color: #aaa;">${this._truncateValue(t[o])}</span>\n              <span style="color: #777; font-size: 10px;"> [untracked]</span>\n            </div>`}))})),0===a?r+='<div style="color: #ff9966; font-style: italic; margin: 4px 0;">\n          ⚠️ Element has @log but no other directives\n        </div>':n||(r+=`<div style="color: #ffa726; font-style: italic; margin: 4px 0;">\n          Found ${a} directive(s) but none are tracked by loggers\n        </div>`),t.elementInfo){const e=t.elementInfo;(e.className||e.id)&&(r+=`<div style="color: #666; font-size: 10px; margin-top: 4px; padding-top: 2px; border-top: 1px solid #333;">\n            ${e.className?`Class: ${e.className}`:""}${e.className&&e.id?" | ":""}${e.id?`ID: ${e.id}`:""}\n          </div>`)}return r+=`<div style="color: #666; font-size: 10px; margin-top: 4px; border-top: 1px solid #333; padding-top: 2px;">\n        ${(new Date).toLocaleTimeString()}\n      </div>`,r}_formatDirectiveLog(e,t,s=!1){const i=s?"📎":"📋";let r='<div style="margin: 4px 0; padding: 4px; background: rgba(255,255,255,0.03); border-radius: 3px;">';if(r+=`<div style="color: ${this._getDirectiveColor(e.split(":")[0])}; font-weight: bold; font-size: 11px; margin-bottom: 2px;">\n        ${i} ${e}\n      </div>`,!t)return r+='<div style="color: #999;">No data available</div>',r+="</div>",r;switch(e.split(":")[0]){case"@for":r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Array: <strong style="color: #ffcc66;">${t.arrayVariable||"unknown"}</strong> (${t.length||0} items)<br>\n            Status: <span style="color: ${this._getStatusColor(t.status)};">${t.status||"unknown"}</span><br>\n            Item var: <span style="color: #66ccff;">${t.itemVariable||"unknown"}</span>\n            ${t.indexVariable?`, Index var: <span style="color: #66ccff;">${t.indexVariable}</span>`:""}\n          </div>`;break;case"@fetch":const e=t.url||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            URL: <strong style="color: #66ff66;">${e.slice(0,35)}${e.length>35?"...":""}</strong><br>\n            Result var: <span style="color: #ffcc66;">${t.resultVariable||"result"}</span><br>\n            Status: <span style="color: ${this._getStatusColor(t.status)};">${t.status||"unknown"}</span><br>\n            Size: <span style="color: #ccc;">${t.responseSize||"N/A"}</span>\n          </div>`;break;case"@model":const s=t.currentValue,i="string"==typeof s?`"${s.slice(0,20)}${s.length>20?"...":""}"`:JSON.stringify(s);r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Variable: <strong style="color: #66ccff;">${t.variable||"unknown"}</strong><br>\n            Value: <span style="color: #ffcc66;">${i}</span> \n            <span style="color: #999;">(${t.valueType})</span><br>\n            ${t.validation?`Validation: <span style="color: ${this._getStatusColor(t.validation.status)};">${t.validation.status}</span>`:"No validation"}\n          </div>`;break;case"@if":case"@show":case"@hide":const n=t.condition||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Condition: <strong style="color: #ffcc66;">${n.slice(0,25)}${n.length>25?"...":""}</strong><br>\n            Result: <span style="color: #66ccff;">${t.result}</span> → \n            <span style="color: ${t.isVisible?"#66bb6a":"#ff6b6b"};">${t.isVisible?"Visible":"Hidden"}</span>\n          </div>`;break;case"@click":const a=t.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${a.slice(0,25)}${a.length>25?"...":""}</strong><br>\n            Clicks: <span style="color: #66ccff;">${t.clickCount||0}</span><br>\n            Last: <span style="color: #999;">${t.lastClick||"Never"}</span>\n          </div>`;break;case"@component":const o=t.source||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Source: <strong style="color: #66ccff;">${o.slice(0,30)}${o.length>30?"...":""}</strong><br>\n            Status: <span style="color: ${this._getStatusColor(t.status)};">${t.status||"unknown"}</span><br>\n            Cached: <span style="color: ${t.cached?"#66bb6a":"#ff9800"};">${t.cached?"Yes":"No"}</span>\n          </div>`;break;case"@input":const l=t.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${l.slice(0,25)}${l.length>25?"...":""}</strong><br>\n            Inputs: <span style="color: #66ccff;">${t.inputCount||0}</span><br>\n            Last: <span style="color: #999;">${t.lastInput||"Never"}</span>\n          </div>`;break;case"@focus":const c=t.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${c.slice(0,25)}${c.length>25?"...":""}</strong><br>\n            Focus events: <span style="color: #66ccff;">${t.focusCount||0}</span><br>\n            Last: <span style="color: #999;">${t.lastFocus||"Never"}</span>\n          </div>`;break;case"@blur":const d=t.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${d.slice(0,25)}${d.length>25?"...":""}</strong><br>\n            Blur events: <span style="color: #66ccff;">${t.blurCount||0}</span><br>\n            Last: <span style="color: #999;">${t.lastBlur||"Never"}</span>\n          </div>`;break;case"@change":const h=t.action||"";r+=`<div style="color: #cccccc; font-size: 10px; line-height: 1.3;">\n            Action: <strong style="color: #ffcc66;">${h.slice(0,25)}${h.length>25?"...":""}</strong><br>\n            Change events: <span style="color: #66ccff;">${t.changeCount||0}</span><br>\n            Last: <span style="color: #999;">${t.lastChange||"Never"}</span>\n          </div>`;break;default:r+=`<div style="color: #cccccc; font-size: 10px;">\n            Expression: <span style="color: #ffcc66;">${t.expression||"N/A"}</span><br>\n            Status: <span style="color: #999;">${t.status||"unknown"}</span>\n          </div>`}return t.error&&(r+=`<div style="color: #ff6b6b; font-size: 9px; margin-top: 2px; padding: 2px; background: rgba(255,0,0,0.1); border-radius: 2px;">\n          💥 ${t.error}\n        </div>`),r+="</div>",r}_getDirectiveColor(e){return{"@for":"#ff9800","@fetch":"#4caf50","@model":"#2196f3","@if":"#9c27b0","@show":"#9c27b0","@hide":"#9c27b0","@click":"#f44336","@component":"#00bcd4",generic:"#666666"}[e]||"#666666"}_getStatusColor(e){if(!e)return"#cccccc";if("string"==typeof e){if(e.includes("error")||e.includes("❌"))return"#ff6b6b";if(e.includes("loading")||e.includes("⏳"))return"#ffa726";if(e.includes("success")||e.includes("✅"))return"#66bb6a"}return"#cccccc"}_getStatusIcon(e){return e?"error"===e?"❌":"loading"===e?"⏳":"success"===e?"✅":"unknown"===e?"❓":"📊":"📊"}_truncateValue(e,t=30){return"string"!=typeof e&&(e=String(e)),e.length>t?e.slice(0,t)+"...":e}_renderVNode(e,s){if(!e)return null;let i=s;if(e.scopedVars&&"object"==typeof e.scopedVars){i=Object.assign(Object.create(s||null),i);for(const[t,r]of Object.entries(e.scopedVars)){let e=r;try{e=this.evaluator.evalExpr(r,s)}catch{}i[t]=e}}let r=null;if(e&&e.directives&&Object.keys(e.directives).length>0){(Object.keys(e.directives).some((e=>"@then"!==e&&"@finally"!==e))||e.directives["@then"]||e.directives["@finally"])&&(r=new t(e,i,this),e.directives["@then"]&&r.addThen(e.directives["@then"]),e.directives["@finally"]&&r.addFinally(e.directives["@finally"]))}if(e.directives&&e.directives["@set"]&&!e._setProcessed){let t=e.directives["@set"];t=Array.isArray(t)?t.flat().filter(Boolean):"string"==typeof t?t.split(/;;|\n/).map((e=>e.trim())).filter(Boolean):[t],t.forEach((t=>{try{const e=/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=([^=].*)/g;let s;for(;null!==(s=e.exec(t));){const e=s[1];e in this.state&&void 0!==this.state[e]||(this.state[e]=this.evaluator.evalExpr(s[2],i))}}catch(t){e._setErrors||(e._setErrors=[]),e._setErrors.push(t.message)}})),e._setProcessed=!0,delete e.directives["@set"]}Object.entries(e.directives||{}).forEach((([e,t])=>{!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(t.trim())||t.includes("=")||t.includes("<")||t.includes(">")||t.includes("!")||t.includes("&")||t.includes("|")||t.includes("'")||t.includes('"')||t.includes("(")||t.includes(")")||("@model"===e?this.evaluator.ensureVarInState(t,!0):this.evaluator.ensureVarInState(t))})),Object.values(e.subDirectives||{}).forEach((e=>Object.values(e).forEach((e=>{!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(e.trim())||e.includes("=")||e.includes("<")||e.includes(">")||e.includes("!")||e.includes("&")||e.includes("|")||e.includes("'")||e.includes('"')||e.includes("(")||e.includes(")")||this.evaluator.ensureVarInState(e)}))));let n=null,a=null,o=null;if(e&&e.directives)for(const t of Object.keys(e.directives))if(("@src"!==t||"component"!==e.tag)&&"@attr"!==t&&"@then"!==t&&"@finally"!==t&&!this.helpSystem.isValidDirective(t)){n=t;break}if(!n&&e&&e.subDirectives)for(const[t,s]of Object.entries(e.subDirectives)){for(const e of Object.keys(s)){const s=`${t}:${e}`;if(!this.helpSystem.isValidDirective(s)){a=t,o=e;break}}if(a)break}if(n||a){let e="";if(n)e=`Error: Unknown directive <b>${n}</b>.`,e+="<br>"+this.directiveHelp(n);else{const t=`${a}:${o}`;e=`Error: Unknown sub-directive <b>${t}</b>.`,e+="<br>"+this.directiveHelp(t)}return this.errorHandler.createErrorElement(e)}if("text"===e.type)return document.createTextNode(this.evaluator.evalText(e.text,s));if("fragment"===e.tag){const t=document.createDocumentFragment();return e.children.forEach((e=>{const i=this._renderVNode(e,s);i&&t.appendChild(i)})),t}if(e.directives["@if"]&&!this.evaluator.evalExpr(e.directives["@if"],s))return null;if(e.directives["@show"]&&!this.evaluator.evalExpr(e.directives["@show"],s))return null;if(e.directives["@hide"]&&this.evaluator.evalExpr(e.directives["@hide"],s))return null;if(e.directives["@for"]){const t=this.directiveManager.directives.get("@for"),i={...this.state,_ayishaInstance:this};return t.apply(e,s,i,null,r)}if(e.directives["@switch"]){const t=this.directiveManager.directives.get("@switch"),i={...this.state,_ayishaInstance:this};return t.apply(e,s,i,null,r)}if(e.directives["@source"])return this._handleFunctionalDirectives(e,s,r);if("component"===e.tag){if(e.directives["@page"]){const t=e.directives["@page"],s=this.state._currentPage||this.state.currentPage;if(String(t)!==String(s))return null}return this._handleComponentDirective(e,s,r)}if("no"===e.tag)return this._handleNoDirective(e,s);const l=document.createElement(e.tag);return"form"===e.tag&&l.addEventListener("submit",(function(e){e.preventDefault()})),e.directives&&e.directives["@go"]&&e._goId&&(l.setAttribute("data-ayisha-go-id",e._goId),l.style.cursor="pointer"),Object.entries(e.attrs).forEach((([e,t])=>{l.setAttribute(e,this.evaluator.evalAttrValue(t,i))})),e.subDirectives?.["@text"]&&(e.children&&e.children.length>0?l._ayishaOriginalText=e.children.filter((e=>"text"===e.type)).map((e=>e.text)).join(""):l._ayishaOriginalText=l.textContent||l.innerText||""),this._handleSpecialDirectives(l,e,i),this.directiveManager.applyDirectives(e,i,this.state,l,r),e.directives&&e.directives["@text"]?e.children.forEach((e=>{if("text"!==e.type){const t=this._renderVNode(e,i);t&&l.appendChild(t)}})):e.children.forEach((e=>{const t=this._renderVNode(e,i);t&&l.appendChild(t)})),r&&!r.done&&r.total>0&&r.markSyncDone(),l}_handleFunctionalDirectives(e,t,s=null){let i=this.evaluator.evalExpr(e.directives["@source"],t),r=[];r=Array.isArray(i)?i:i&&"object"==typeof i?Object.values(i):null==i?[]:[i];const n=(e,t)=>{JSON.stringify(this.state[e])!==JSON.stringify(t)&&Object.defineProperty(this.state,e,{value:t,writable:!0,configurable:!0,enumerable:!0})};let a=!1;if(e.directives["@map"]){a=!0;try{const t=e.directives["@map"];let s;if(t.includes("=>")){const[e,i]=t.split("=>").map((e=>e.trim()));s=new Function(e.trim(),`return (${i})`)}else s=new Function("item",`return (${t})`);const i=r.map(s);n(e.directives["@result"]||"result",i)}catch(t){n(e.directives["@result"]||"result",[])}}if(e.directives["@filter"]){a=!0;try{const t=e.directives["@filter"];let s;if(t.includes("=>")){const[e,i]=t.split("=>").map((e=>e.trim()));s=new Function(e.trim(),`return (${i})`)}else s=new Function("item",`return (${t})`);const i=r.filter(s);n(e.directives["@result"]||"result",i)}catch(t){n(e.directives["@result"]||"result",[])}}if(e.directives["@reduce"]){a=!0;try{const s=e.directives["@reduce"];let i;if(s.includes("=>")){const[e,t]=s.split("=>").map((e=>e.trim())),[r,n]=e.replace(/[()]/g,"").split(",").map((e=>e.trim()));i=new Function(r,n,`return (${t})`)}else i=new Function("acc","item",`return (${s})`);const a=e.directives["@initial"]?this.evaluator.evalExpr(e.directives["@initial"],t):void 0;let o;o=0===r.length?void 0!==a?a:void 0:void 0!==a?r.reduce(i,a):r.reduce(i),n(e.directives["@result"]||"result",o)}catch(s){const i=e.directives["@initial"]?this.evaluator.evalExpr(e.directives["@initial"],t):void 0;n(e.directives["@result"]||"result",void 0!==i?i:void 0)}}return s&&s.addTask((()=>Promise.resolve())),a?document.createComment("functional"):null}_handleComponentDirective(e,t,s=null){let i=Object.create(t||null);if(e.scopedVars&&"object"==typeof e.scopedVars)for(const[s,r]of Object.entries(e.scopedVars)){let e=r;try{e=this.evaluator.evalExpr(r,t)}catch{}i[s]=e}const r=this.directiveManager.directives.get("@component"),n={...this.state,_ayishaInstance:this};return r.apply(e,i,n,null,s)}_processComponentInitBlocks(e){const t=e.querySelectorAll("init"),s=[];t.forEach((e=>{const t=e.textContent.trim();t&&(this._initBlocks.includes(t)||(s.push(t),this._initBlocks.push(t))),e.remove()})),this._runInitBlocksImmediate(s)}_runInitBlocksImmediate(e){e.forEach((e=>{if(!e||!e.trim())return;let t=e.trim().replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n\s*\n/g,"\n").replace(/\n\s+/g,"\n").trim();const s=t.split("\n");t=s.map((e=>{const t=e.trim();if(!t||t.startsWith("//")||t.startsWith("/*")||t.startsWith("function")||t.includes("function(")||t.includes("=>")||/^(if|else|for|while|switch|case|default|try|catch|finally|return|var|let|const)\b/.test(t))return e;const s=t.match(/^([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*(.+)$/);if(s&&!t.includes("state.")&&!t.includes("this.")&&!t.includes("window.")&&!t.includes("console.")&&!t.includes("localStorage.")&&!t.includes("sessionStorage.")){const[,t,i]=s;if(!["JSON","Object","Array","String","Number","Boolean","Date","Math","RegExp"].includes(t))return e.replace(s[0],`state.${t} = ${i}`)}return e})).join("\n");try{new Function("state",t)(this.state)}catch(e){}}))}_handleNoDirective(e,t){const s=document.createElement("span");if(void 0!==e.rawContent){const i=this.evaluator.evalText(e.rawContent,t);s.textContent=i}else{let i="";const r=e=>{if("string"==typeof e)return e;if("text"===e.type)return e.content||"";if(e.tag){let t="";e.attrs&&(t=Object.entries(e.attrs).map((([e,t])=>` ${e}="${t}"`)).join(""));let s="";e.directives&&(s=Object.entries(e.directives).map((([e,t])=>` ${e}="${t}"`)).join(""));let i="";e.subDirectives&&Object.entries(e.subDirectives).forEach((([e,t])=>{Object.entries(t).forEach((([t,s])=>{i+=` ${e}:${t}="${s}"`}))}));const n=e.children?e.children.map(r).join(""):"";return`<${e.tag}${t}${s}${i}>${n}</${e.tag}>`}return""};e.children&&e.children.length>0&&(i=e.children.map(r).join(""));const n=this.evaluator.evalText(i,t);s.textContent=n}return s}_handleSpecialDirectives(e,t,s){if(t.directives&&t.directives["@set"]&&!t._setProcessed){const i=t.directives["@set"],r=`${t.tag}-${JSON.stringify(t.attrs)}-${i}`;if(this._processedSetDirectives||(this._processedSetDirectives=new Set),!this._processedSetDirectives.has(r)){this._processedSetDirectives.add(r);try{const e=/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=([^=].*)/g;let t;for(;null!==(t=e.exec(i));){const e=t[1];e in this.state&&void 0!==this.state[e]||(this.state[e]=this.evaluator.evalExpr(t[2],s))}}catch(t){e.setAttribute("data-ayisha-set-error",t.message)}}return t._setProcessed=!0,delete t.directives["@set"],void(e.parentNode&&e.parentNode.removeChild(e))}if(t.directives.hasOwnProperty("@attr")){const t=document.createElement("div");t.style.backgroundColor="rgba(0, 0, 0, 0.8)",t.style.color="#fff",t.style.padding="1em",t.style.borderRadius="4px",t.style.marginTop="1em",t.style.overflow="auto";const s=document.createElement("h3");s.textContent="STATE ATTRIBUTES",s.style.margin="0.5em 0 2em",s.style.fontSize="1.1em",s.style.fontWeight="bold",s.style.color="#fff",t.appendChild(s);const i=document.createElement("ul");i.style.margin="0",i.style.padding="0 0 0 1.2em",i.style.fontFamily="monospace",i.style.fontSize="1em",Object.keys(this.state).forEach((e=>{const t=document.createElement("li");t.textContent=e,i.appendChild(t)})),t.appendChild(i),e.appendChild(t)}if(t.directives.hasOwnProperty("@log")){this.centralLogger&&this.centralLogger.loggers&&0!==Object.keys(this.centralLogger.loggers).length||this.centralLogger.initializeLoggers(this.evaluator,this.fetchManager,this.componentManager);try{const i={tagName:e.tagName,className:e.className,id:e.id};this.centralLogger.addLog(i,t,s,this.state,e);const r={tag:t.tag,directives:{...t.directives},subDirectives:{...t.subDirectives},elementInfo:i};if(e.setAttribute("data-ayisha-log","true"),e.setAttribute("data-ayisha-log-info",JSON.stringify(r)),t.directives["@click"]){const r=this.centralLogger.loggers["@click"];r&&(this.centralLogger.clickLoggers.set(e,r),e.addEventListener("click",(()=>{r.recordClick(),this.centralLogger.addLog(i,t,s,this.state,e)})))}}catch(t){e.setAttribute("data-ayisha-log-error",t.message)}}}mount(){if(this.root.childNodes.forEach((e=>{1===e.nodeType&&e.tagName&&"init"===e.tagName.toLowerCase()&&this.parser.parse(e)})),this.root.childNodes.length>1){const e={tag:"fragment",attrs:{},directives:{},subDirectives:{},children:[]};this.root.childNodes.forEach((t=>{if(1===t.nodeType&&t.tagName&&"init"===t.tagName.toLowerCase())return;const s=this.parse(t);s&&e.children.push(s)})),this._vdom=e}else this._vdom=this.parse(this.root);if(!this.state._currentPage){const e=this._findFirstPageDirective(this._vdom);e&&(this.state._currentPage=e.directives["@page"])}this._preInitializeEssentialVariables(),this._makeReactive(),this._runInitBlocks(),this.reactivitySystem.enableWatchers(),this._setupRouting(),this.router.setupCurrentPageProperty(),this.preloadComponents().then((()=>{this._isRendering||this.render()})),this.render(),this.root.addEventListener("click",(e=>{let t=e.target;for(;t&&t!==this.root;){if(t.hasAttribute("@link")){e.preventDefault();const s=t.getAttribute("@link");let i=s;return s.startsWith("/")&&(i=s.substring(1)),this.state._currentPage=i,void this.render()}if("A"===t.tagName&&t.hasAttribute("href")){const s=t.getAttribute("href");return!s||"index.html"!==s&&"./index.html"!==s&&"/index.html"!==s?s&&!/^(https?:|ftp:|mailto:|tel:|#|javascript:)/i.test(s)?(e.preventDefault(),void(window.location.href="/"+s.replace(/^\/+/,""))):void 0:(e.preventDefault(),void(window.location.href="/index.html"))}t=t.parentNode}}),!0)}}"undefined"!=typeof window&&(window.AyishaVDOM=Ee);"undefined"!=typeof module&&module.exports?(module.exports={AyishaVDOM:Ee,Ayisha:Ee},module.exports.default=Ee):"function"==typeof define&&define.amd?define([],(function(){return{AyishaVDOM:Ee,Ayisha:Ee,default:Ee}})):"undefined"!=typeof window&&(window.Ayisha=Ee);const $e=()=>{if("undefined"==typeof document)return;if(!document.getElementById("ayisha-default-animations")){const e=document.createElement("style");e.id="ayisha-default-animations",e.textContent="\n        /* FadeIn animation for both .fadeIn and .fade-in */\n        .fadeIn, .fade-in {\n          animation: ayishaFadeIn 0.3s ease-in-out;\n        }\n\n        @keyframes ayishaFadeIn {\n          from { opacity: 0; }\n          to { opacity: 1; }\n        }\n\n        /* Slide-down animation */\n        .slide-down {\n          overflow: hidden;\n          transition: height 0.3s ease-in-out;\n        }\n\n        /* Styles for @log display as sibling */\n        .ayisha-log-display {\n          background: rgba(0, 20, 40, 0.95) !important;\n          color: #fff !important;\n          padding: 8px 12px !important;\n          margin: 4px 0 !important;\n          border-radius: 6px !important;\n          font-family: 'JetBrains Mono', 'Courier New', monospace !important;\n          font-size: 11px !important;\n          border-left: 4px solid #0066cc !important;\n          box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;\n          max-width: 400px !important;\n          overflow-x: auto !important;\n          line-height: 1.4 !important;\n          display: block !important;\n        }\n\n        /* Styles for @log error display */\n        .ayisha-log-error-display {\n          background: rgba(255, 0, 0, 0.9) !important;\n          color: white !important;\n          padding: 8px 12px !important;\n          margin: 4px 0 !important;\n          border-radius: 6px !important;\n          font-family: monospace !important;\n          font-size: 11px !important;\n          font-weight: bold !important;\n          display: block !important;\n        }\n      ",document.head.appendChild(e)}};"undefined"!=typeof window&&"undefined"!=typeof document&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{$e(),new Ee(document.body).mount()})):($e(),new Ee(document.body).mount()))}();export{AyishaVDOM,AyishaVDOM as Ayisha};export default AyishaVDOM;